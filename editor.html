
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bass‑Routine — Éditeur</title>
<style>
body{margin:0;background:#0c0d10;color:#e9ebef;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
header{position:sticky;top:0;background:#0f1117d0;border-bottom:1px solid #262a31;backdrop-filter:blur(6px)}
.wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
a{color:inherit;text-decoration:none;border:1px solid #262a31;padding:6px 10px;border-radius:10px;background:#0f1117}
main{max-width:1100px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
@media(max-width:980px){main{grid-template-columns:1fr}}
.card{background:#14161b;border:1px solid #262a31;border-radius:14px;overflow:hidden}
.card h2{margin:0;padding:10px 12px;border-bottom:1px solid #262a31;font-size:15px}
.content{padding:12px}
input,select,button,textarea{border:1px solid #262a31;background:#0f1117;color:#e9ebef;border-radius:10px;padding:8px 10px;font-family:ui-monospace,Menlo,Consolas,monospace}
textarea{width:100%;min-height:300px;white-space:pre;line-height:1.5}
.badge{display:inline-block;border:1px solid #262a31;border-radius:999px;padding:2px 8px;font-size:11px;color:#c9ced6}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
details{position:relative} details>summary{list-style:none;cursor:pointer}
.dropdown-menu{position:absolute;top:100%;left:0;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;background:#0f1117;border:1px solid #262a31;padding:8px;border-bottom-left-radius:10px;border-bottom-right-radius:10px;z-index:5}
.chip{padding:6px 8px;border:1px solid #2a2f36;background:#10131a;border-radius:8px;cursor:pointer}
.compas{background:#0f1117;border:1px solid #262a31;border-radius:12px;padding:10px}
.grid{display:grid;gap:8px}
.row{display:grid;grid-template-columns:repeat(var(--cols,4),1fr);gap:8px}
.cell{position:relative;min-height:62px;display:flex;align-items:center;justify-content:center;text-align:center;padding:6px;border:1px solid #2a2f3a;border-radius:10px;font-family:ui-monospace,Menlo,Consolas,monospace;line-height:1.25}
.cell small{position:absolute;top:6px;left:8px;opacity:.55;font-size:10px}
.cell .multi{display:flex;flex-direction:column;gap:2px;white-space:pre-wrap}
.cell.empty{opacity:.6;font-style:italic}
.bracketL::before{content:'𝄆';position:absolute;left:-14px;top:50%;transform:translateY(-50%);font-size:18px}
.bracketR::after{content:'𝄇';position:absolute;right:-14px;top:50%;transform:translateY(-50%);font-size:18px}
.warn{border-bottom:2px dotted #f7c87a}
</style>
</head>
<body>
<header><div class="wrap"><a href="index.html">← Lecteur</a><h1 style="margin-left:8px;font-size:18px">Éditeur</h1><span id="saveStatus" style="margin-left:auto" class="badge"> </span></div></header>

<main>
  <section class="card">
    <h2>Métadonnées</h2>
    <div class="content">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><div class="badge">ID</div><input id="id"></div>
        <div><div class="badge">Titre</div><input id="title"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <div><div class="badge">Auteur</div><input id="author"></div>
        <div><div class="badge">Style</div><input id="style"></div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <span class="badge">Mesures/ligne</span><select id="cols"><option>2</option><option>3</option><option selected>4</option><option>8</option></select>
        <button id="saveDb" class="badge">Enregistrer (DB)</button>
        <button id="saveLocal" class="badge">Enregistrer (local)</button>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Grille</h2>
    <div class="content">
      <div class="toolbar" id="toolbar">
        <details><summary>Mesures ▾</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="𝄆">𝄆</button>
            <button class="chip" data-insert="𝄇">𝄇</button>
            <button class="chip" data-insert=" | ">|</button>
          </div>
        </details>
        <details><summary>Accords ▾</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="♭">♭</button><button class="chip" data-insert="♯">♯</button>
            <button class="chip" data-insert="ø">ø</button><button class="chip" data-insert="Δ">Δ</button>
            <button class="chip" data-insert="°">°</button><button class="chip" data-insert="sus4">sus4</button>
            <button class="chip" data-insert="sus2">sus2</button><button class="chip" data-insert="add9">add9</button>
            <button class="chip" data-insert="(alt)">(alt)</button><button class="chip" data-insert="/B♭">/B♭</button>
            <button class="chip" data-insert="(♭9♯9♯11♭13)">(♭9♯9♯11♭13)</button>
          </div>
        </details>
        <details><summary>Structure ▾</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="A:">A:</button><button class="chip" data-insert="B:">B:</button><button class="chip" data-insert="C:">C:</button>
            <button class="chip" data-insert="Intro:">Intro:</button><button class="chip" data-insert="Bridge:">Bridge:</button>
            <button class="chip" data-insert="D.S. al Coda">D.S. al Coda</button><button class="chip" data-insert="D.S. al Fine">D.S. al Fine</button>
            <button class="chip" data-insert="D.C. al Coda">D.C. al Coda</button><button class="chip" data-insert="D.C. al Fine">D.C. al Fine</button>
            <button class="chip" data-insert="To Coda">To Coda</button><button class="chip" data-insert="Segno 𝄋">Segno 𝄋</button><button class="chip" data-insert="Coda 𝄌">Coda 𝄌</button><button class="chip" data-insert="Fine">Fine</button>
          </div>
        </details>
      </div>
      <textarea id="grid" spellcheck="false"></textarea>
      <div id="validation" class="badge" style="margin-top:6px"></div>
    </div>
  </section>

  <section class="card">
    <h2>Aperçus</h2>
    <div class="content">
      <div class="badge">Texte normalisé</div>
      <div id="preview" style="white-space:pre-wrap;background:#0f1117;border:1px solid #262a31;border-radius:12px;padding:10px;min-height:140px"></div>
      <div style="height:8px"></div>
      <div class="badge">Rendu “compas”</div>
      <div id="compas" class="compas"></div>
    </div>
  </section>
</main>

<script type="module">
import { getAll, patchOne } from './js/api/library-client.js'
import { normalizeGrid } from './js/grid/parse.js'
import { renderCompas } from './js/grid/render.js'

const $=id=>document.getElementById(id);
const params=new URLSearchParams(location.search); const itemId=params.get('id');

function update(){
  const text=$('grid').value;
  const norm=normalizeGrid(text);
  $('preview').innerHTML=norm.html;
  renderCompas($('compas'), text, parseInt($('cols').value,10)||4, true);
}

document.addEventListener('click',(e)=>{
  const btn=e.target.closest('[data-insert]'); if(btn){
    e.preventDefault();
    const ta=$('grid'); ta.focus();
    const s=ta.selectionStart, ed=ta.selectionEnd, v=ta.value;
    ta.value=v.slice(0,s)+btn.dataset.insert+v.slice(ed);
    const pos=(s||0)+btn.dataset.insert.length; ta.selectionStart=ta.selectionEnd=pos;
    const d=btn.closest('details'); if(d) d.removeAttribute('open');
    update(); return;
  }
  document.querySelectorAll('details[open]').forEach(d=>{ if(!d.contains(e.target)) d.removeAttribute('open'); });
});
$('cols').onchange=update;

$('saveLocal').onclick=()=>{
  const obj=collect();
  localStorage.setItem('jazzgrid:'+obj.id, JSON.stringify(obj));
  flash('Enregistré (local) ✔');
};
$('saveDb').onclick=async()=>{
  const obj=collect();
  if(!obj.id){ alert('ID requis'); return; }
  try{ await patchOne(obj.id, obj); flash('Enregistré (DB) ✔'); }catch(e){ alert(e.message); }
};

function collect(){
  return {
    id:$('id').value.trim(),
    title:$('title').value.trim(),
    composer:$('author').value.trim(),
    style:$('style').value.trim(),
    grid_text:$('grid').value
  };
}
function flash(t){ $('saveStatus').textContent=t; setTimeout(()=>$('saveStatus').textContent=' ',1200); }

async function boot(){
  let lib=[];
  try{ lib=await getAll(); }catch(_){}
  const it = lib.find(x=>x.id===itemId) || null;
  if(it){
    $('id').value=it.id||''; $('title').value=it.title||''; $('author').value=it.composer||''; $('style').value=it.style||''; $('grid').value=it.grid_text||'';
  }else{
    // Default prefill Blue Bossa
    $('id').value=itemId||'blue-bossa';
    $('title').value='Blue Bossa';
    $('author').value='Kenny Dorham';
    $('style').value='Bossa';
    $('grid').value=`A:
𝄆 Cm7 | Fm7 | Dm7b5 G7 | Cm7 |
| Cm7 | Fm7 | Dm7b5 G7 | Cm7 𝄇

B: (Bridge)
| E♭m7 A♭7 | D♭Δ | Dm7b5 G7 | Cm7 |

A:
| Cm7 | Fm7 | Dm7b5 G7 | Cm7 | Fine

D.C. al Fine`;
  }
  update();
}
boot();
</script>
</body>
</html>
