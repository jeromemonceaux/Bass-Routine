<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Éditeur — Bass-Routine</title>
  <style>
    body{margin:0;background:#0c0d10;color:#e9ebef;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:#0f1117d0;border-bottom:1px solid #262a31;backdrop-filter:blur(6px)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    a{color:inherit;text-decoration:none;border:1px solid #262a31;padding:6px 10px;border-radius:10px;background:#0f1117}
    main{max-width:1100px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
    @media(max-width:980px){main{grid-template-columns:1fr}}
    .card{background:#14161b;border:1px solid #262a31;border-radius:14px;overflow:hidden}
    .card h2{margin:0;padding:10px 12px;border-bottom:1px solid #262a31;font-size:15px}
    .content{padding:12px}
    input,select,button,textarea{border:1px solid #262a31;background:#0f1117;color:#e9ebef;border-radius:10px;padding:8px 10px;font-family:ui-monospace,Menlo,Consolas,monospace}
    textarea{width:100%;min-height:300px;white-space:pre;line-height:1.5}
    .badge{display:inline-block;border:1px solid #262a31;border-radius:999px;padding:2px 8px;font-size:11px;color:#c9ced6}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    details{position:relative}
    details>summary{list-style:none;cursor:pointer}
    .dropdown-menu{position:absolute;top:100%;left:0;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;background:#0f1117;border:1px solid #262a31;padding:8px;border-bottom-left-radius:10px;border-bottom-right-radius:10px;z-index:5}
    .chip{padding:6px 8px;border:1px solid #2a2f36;background:#10131a;border-radius:8px;cursor:pointer}

    /* Aperçu (texte normalisé) */
    #preview{white-space:pre-wrap;background:#0f1117;border:1px solid #262a31;border-radius:12px;padding:10px;min-height:140px;font-family:ui-monospace,Menlo,Consolas,monospace}
    #preview .line{margin:2px 0}
    #preview .section{display:inline-block;margin:2px 0 6px}
    #preview .sep{opacity:.85}
    #preview .dir{margin:0 4px 0 0}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <a href="library.html">← Bibliothèque</a>
    <h1 style="margin-left:8px;font-size:18px">Éditeur</h1>
    <span id="saveStatus" style="margin-left:auto" class="badge"> </span>
    <button id="playBtn" class="badge">▶ Jouer dans le lecteur</button>
  </div>
</header>

<main>
  <section class="card">
    <h2>Métadonnées</h2>
    <div class="content">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><div class="badge">ID</div><input id="id"></div>
        <div><div class="badge">Titre</div><input id="title"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <div><div class="badge">Auteur</div><input id="author"></div>
        <div><div class="badge">Style</div><input id="style"></div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button id="saveDb" class="badge">Enregistrer (DB)</button>
        <button id="saveLocal" class="badge">Enregistrer (local)</button>
        <span id="keyBadge" class="badge">Mesures : —</span>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Grille</h2>
    <div class="content">
      <div class="toolbar" id="toolbar">
        <details><summary>Mesures ▾</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="𝄆">𝄆</button>
            <button class="chip" data-insert="𝄇">𝄇</button>
            <button class="chip" data-insert=" | ">|</button>
          </div>
        </details>
        <details><summary>Accords ▾</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="♭">♭</button><button class="chip" data-insert="♯">♯</button>
            <button class="chip" data-insert="ø">ø</button><button class="chip" data-insert="Δ">Δ</button>
            <button class="chip" data-insert="°">°</button><button class="chip" data-insert="sus4">sus4</button>
            <button class="chip" data-insert="sus2">sus2</button><button class="chip" data-insert="add9">add9</button>
            <button class="chip" data-insert="(alt)">(alt)</button><button class="chip" data-insert="/B♭">/B♭</button>
            <button class="chip" data-insert="(♭9♯11)">(♭9♯11)</button>
          </div>
        </details>
        <details><summary>Structure ▾</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="A:">A:</button><button class="chip" data-insert="B:">B:</button><button class="chip" data-insert="C:">C:</button>
            <button class="chip" data-insert="Intro:">Intro:</button><button class="chip" data-insert="Bridge:">Bridge:</button>
            <button class="chip" data-insert="D.S. al Coda">D.S. al Coda</button><button class="chip" data-insert="D.S. al Fine">D.S. al Fine</button>
            <button class="chip" data-insert="D.C. al Coda">D.C. al Coda</button><button class="chip" data-insert="D.C. al Fine">D.C. al Fine</button>
            <button class="chip" data-insert="To Coda">To Coda</button><button class="chip" data-insert="Segno 𝄋">Segno 𝄋</button><button class="chip" data-insert="Coda 𝄌">Coda 𝄌</button><button class="chip" data-insert="Fine">Fine</button>
          </div>
        </details>
      </div>
      <textarea id="grid" spellcheck="false"></textarea>
      <div id="validation" class="badge" style="margin-top:6px"></div>
    </div>
  </section>

  <section class="card">
    <h2>Aperçus</h2>
    <div class="content">
      <div class="badge">Texte normalisé</div>
      <div id="preview"></div>
    </div>
  </section>
</main>

<!-- Dépendances -->
<script src="js/grid/parse.js"></script>
<script src="js/grid/grid-bridge.js"></script>

<script>
(function(){
  'use strict';

  // --- Utils ---
  const $ = (id)=>document.getElementById(id);
  const params = new URLSearchParams(location.search);
  const itemId = params.get('id') || 'temp';
  const API = '/api/library';

  // Directives (split + test exact) — pas de /g sur DIR_ONLY_RE (évite toute boucle liée à lastIndex)
  const DIR_PAT = '(D\\.?S\\.?\\s*al\\s*Coda|D\\.?S\\.?\\s*al\\s*Fine|D\\.?C\\.?\\s*al\\s*Coda|D\\.?C\\.?\\s*al\\s*Fine|To\\s*Coda|Fine|Segno\\s*𝄋|Segno|Coda\\s*𝄌|Coda|𝄋|𝄌)';
  const DIR_SPLIT_RE = new RegExp(DIR_PAT, 'gi');
  const DIR_ONLY_RE  = new RegExp('^' + DIR_PAT + '$', 'i');

  function sectionFromLine(line){
    const m = String(line||'').match(/^\s*[\[(]?(Intro|A\d*|A|B\d*|B|C|D|Bridge|Solo|Solos|Refrain|Coda|Segno)\s*[:\])]?\s*$/i);
    return m ? m[1] : null;
  }
  function escapeHtml(s){ return (''+s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // Rendu texte (sans “compas”), en évitant les doubles symboles (ex: “𝄆 |”, “| 𝄇”, “||”)
  function renderPreview(text){
    const lines = String(text||'').split(/\r?\n/);
    const out = [];

    for (let raw of lines){
      if (!raw.trim()){ out.push(''); continue; }

      // Section → badge dédiée (PAS une mesure)
      const sec = sectionFromLine(raw);
      if (sec){
        out.push('<div class="line section"><span class="badge">▶ ' + escapeHtml(sec.replace(/\d+/g,'')) + '</span></div>');
        continue;
      }

      // Normalisation douce (espaces autour des séparateurs)
      let line = raw.replace(/\s+/g,' ').trim();
      line = line.replace(/𝄆/g,' 𝄆 ').replace(/𝄇/g,' 𝄇 ').replace(/\|/g,' | ');

      // Découpe en gardant les directives
      const chunks = line.split(DIR_SPLIT_RE);
      const tokens = [];

      // Construit des tokens: accords/texte, |, 𝄆, 𝄇, directives
      for (const chunk of chunks){
        const c = chunk && chunk.trim();
        if (!c) continue;

        if (DIR_ONLY_RE.test(c)) {
          tokens.push({type:'dir',val:c});
          continue;
        }

        // re-split sur symboles simples
        const sub = c.split(/(\||𝄆|𝄇)/);
        for (const t of sub){
          const tt = t && t.trim();
          if (!tt) continue;
          if (tt==='|' || tt==='𝄆' || tt==='𝄇'){ tokens.push({type:'sym',val:tt}); }
          else { tokens.push({type:'txt',val:tt}); }
        }
      }

      // Filtrage “anti-doublons”:
      // - supprime '|' si juste après '𝄆'
      // - supprime '|' si juste avant '𝄇'
      // - compresse les '|' successifs
      const cleaned = [];
      for (let i=0;i<tokens.length;i++){
        const t = tokens[i];
        const prev = cleaned[cleaned.length-1];
        const next = tokens[i+1];

        if (t.type==='sym' && t.val==='|') {
          if (prev && prev.type==='sym' && prev.val==='𝄆') continue;
          if (next && next.type==='sym' && next.val==='𝄇') continue;
          if (prev && prev.type==='sym' && prev.val==='|') continue; // compresse ||
        }
        cleaned.push(t);
      }

      // Sortie HTML
      const parts = cleaned.map(t=>{
        if (t.type==='sym' && (t.val==='|' || t.val==='𝄆' || t.val==='𝄇')) return '<span class="sep">'+t.val+'</span>';
        if (t.type==='dir') return '<span class="badge dir">'+escapeHtml(t.val)+'</span>';
        return escapeHtml(t.val);
      });

      out.push('<div class="line">'+parts.join(' ')+'</div>');
    }

    return out.join('\n');
  }

  function normalizeAndPreview(){
    const text = ($('grid')?.value)||'';
    let barsCount = 0;
    try{
      if (window.GridParse && typeof window.GridParse.parse==='function'){
        const res = window.GridParse.parse(text);
        barsCount = Array.isArray(res?.bars) ? res.bars.length : 0;
      } else {
        // fallback très approximatif
        barsCount = (text.match(/\|/g)||[]).length;
      }
    }catch(_){}

    $('preview').innerHTML = renderPreview(text);
    $('keyBadge').textContent = 'Mesures : ' + barsCount;
  }

  // Insertion via la palette
  document.addEventListener('click',(e)=>{
    const btn = e.target.closest('[data-insert]'); if(btn){
      e.preventDefault();
      const ta=$('grid'); ta.focus();
      const s=ta.selectionStart, ed=ta.selectionEnd, v=ta.value;
      const ins=btn.dataset.insert;
      ta.value=v.slice(0,s)+ins+v.slice(ed);
      const pos=(s||0)+ins.length; ta.selectionStart=ta.selectionEnd=pos;
      const d=btn.closest('details'); if(d) d.removeAttribute('open');
      normalizeAndPreview();
    }
    document.querySelectorAll('details[open]').forEach(d=>{ if(!d.contains(e.target)) d.removeAttribute('open'); });
  });

  // Conversion DB -> format standard (pour Bridge / lecteur)
  function toBridgeGrid(rec){
    const parsed = (window.GridParse && window.GridParse.parse) ? window.GridParse.parse(rec.grid_text||'') : { bars: [] };
    return {
      id: rec.id,
      name: rec.title || rec.id,
      author: rec.composer || '',
      key: rec.key || null,
      mode: rec.mode || null,
      tpb: rec.tpb || 4,
      bars: Array.isArray(parsed.bars) ? parsed.bars : []   // format: [ [ "Cm7" ], [ "F7" ], ... ]
    };
  }

  function makeDbRecord(){
    return {
      id: $('id').value.trim(),
      title: $('title').value.trim(),
      composer: $('author').value.trim(),
      style: $('style').value.trim(),
      grid_text: $('grid').value
    };
  }

  // Save local (et miroir lecteur)
  $('saveLocal').onclick = function(){
    const obj = makeDbRecord();
    if(!obj.id){ alert('ID requis'); return; }
    localStorage.setItem('jazzgrid:'+obj.id, JSON.stringify(obj));
    if (window.Bridge && typeof Bridge.upsertLocalGrid==='function'){
      Bridge.upsertLocalGrid(toBridgeGrid(obj));
    }
    $('saveStatus').textContent='Enregistré (local) ✔'; setTimeout(()=>{$('saveStatus').textContent=' ';},1200);
  };

  // Save DB (et miroir lecteur)
  $('saveDb').onclick = async function(){
    const obj = makeDbRecord();
    if(!obj.id){ alert('ID requis'); return; }
    try{
      const r = await fetch(API+'/'+encodeURIComponent(obj.id),{
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(obj)
      });
      if(!r.ok){ const t=await r.text(); throw new Error('HTTP '+r.status+' '+t); }
      if (window.Bridge && typeof Bridge.upsertLocalGrid==='function'){
        Bridge.upsertLocalGrid(toBridgeGrid(obj));
      }
      $('saveStatus').textContent='Enregistré (DB) ✔'; setTimeout(()=>{$('saveStatus').textContent=' ';},1200);
    }catch(e){ alert(e.message); }
  };

  // Jouer dans le player : on prépare la grille pour le ticker et on redirige
  function doPlay(){
    const obj = makeDbRecord();
    if(!obj.id){ alert('ID requis'); return; }

    // 1) miroir local brut (pour sécurité)
    localStorage.setItem('jazzgrid:'+obj.id, JSON.stringify(obj));

    // 2) upsert format standard pour le lecteur (ticker)
    if (window.Bridge && typeof Bridge.upsertLocalGrid==='function'){
      Bridge.upsertLocalGrid(toBridgeGrid(obj));
    }

    // 3) ouverture du player avec l’ID (le Bridge côté lecteur chargera et poussera dans le ticker)
    if (window.Bridge && typeof Bridge.playGrid==='function'){
      Bridge.playGrid(obj.id); // redirige vers index.html#grid=<id>&auto=1 (selon ton Bridge)
    } else {
      location.href = 'index.html#grid=' + encodeURIComponent(obj.id) + '&auto=1';
    }
  }
  $('playBtn').onclick = doPlay;

  // Boot : charge /api/library/:id si dispo, sinon fallback d’exemple
  (async function boot(){
    const id = itemId;
    let rec = null;
    try{
      const r = await fetch(API+'/'+encodeURIComponent(id));
      if (r.ok) rec = await r.json();
    }catch(_){}

    if (!rec){
      rec = {
        id, title:'Blue Bossa', composer:'Kenny Dorham', style:'Bossa',
        grid_text:`A:
𝄆 Cm7 | Fm7 | Dm7b5 G7 | Cm7 |
| Cm7 | Fm7 | Dm7b5 G7 | Cm7 𝄇

B: (Bridge)
| E♭m7 A♭7 | D♭Δ | Dm7b5 G7 | Cm7 |

A:
| Cm7 | Fm7 | Dm7b5 G7 | Cm7 | Fine

D.C. al Fine`
      };
    }

    $('id').value     = rec.id || '';
    $('title').value  = rec.title || '';
    $('author').value = rec.composer || '';
    $('style').value  = rec.style || '';
    $('grid').value   = rec.grid_text || '';
    normalizeAndPreview();
  })();

})();
</script>
</body>
</html>