<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>√âditeur ‚Äî Bass-Routine</title>
  <style>
    body{margin:0;background:#0c0d10;color:#e9ebef;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:#0f1117d0;border-bottom:1px solid #262a31;backdrop-filter:blur(6px)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    a{color:inherit;text-decoration:none;border:1px solid #262a31;padding:6px 10px;border-radius:10px;background:#0f1117}
    main{max-width:1100px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
    @media(max-width:980px){main{grid-template-columns:1fr}}
    .card{background:#14161b;border:1px solid #262a31;border-radius:14px;overflow:hidden}
    .card h2{margin:0;padding:10px 12px;border-bottom:1px solid #262a31;font-size:15px}
    .content{padding:12px}
    input,select,button,textarea{border:1px solid #262a31;background:#0f1117;color:#e9ebef;border-radius:10px;padding:8px 10px;font-family:ui-monospace,Menlo,Consolas,monospace}
    textarea{width:100%;min-height:300px;white-space:pre;line-height:1.5}
    .badge{display:inline-block;border:1px solid #262a31;border-radius:999px;padding:2px 8px;font-size:11px;color:#c9ced6}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    details{position:relative} details>summary{list-style:none;cursor:pointer}
    .dropdown-menu{position:absolute;top:100%;left:0;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;background:#0f1117;border:1px solid #262a31;padding:8px;border-bottom-left-radius:10px;border-bottom-right-radius:10px;z-index:5}
    .chip{padding:6px 8px;border:1px solid #2a2f36;background:#10131a;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <a href="library.html">‚Üê Biblioth√®que</a>
    <h1 style="margin-left:8px;font-size:18px">√âditeur</h1>
    <span id="saveStatus" style="margin-left:auto" class="badge"> </span>
    <button id="playBtn" class="badge">‚ñ∂ Jouer dans le lecteur</button>
  </div>
</header>

<main>
  <section class="card">
    <h2>M√©tadonn√©es</h2>
    <div class="content">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><div class="badge">ID</div><input id="id"></div>
        <div><div class="badge">Titre</div><input id="title"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <div><div class="badge">Auteur</div><input id="author"></div>
        <div><div class="badge">Style</div><input id="style"></div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button id="saveDb" class="badge">Enregistrer (DB)</button>
        <button id="saveLocal" class="badge">Enregistrer (local)</button>
        <span id="keyBadge" class="badge">Mesures : ‚Äî</span>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Grille</h2>
    <div class="content">
      <div class="toolbar" id="toolbar">
        <details><summary>Mesures ‚ñæ</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="ùÑÜ">ùÑÜ</button>
            <button class="chip" data-insert="ùÑá">ùÑá</button>
            <button class="chip" data-insert=" | ">|</button>
          </div>
        </details>
        <details><summary>Accords ‚ñæ</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="‚ô≠">‚ô≠</button><button class="chip" data-insert="‚ôØ">‚ôØ</button>
            <button class="chip" data-insert="√∏">√∏</button><button class="chip" data-insert="Œî">Œî</button>
            <button class="chip" data-insert="¬∞">¬∞</button><button class="chip" data-insert="sus4">sus4</button>
            <button class="chip" data-insert="sus2">sus2</button><button class="chip" data-insert="add9">add9</button>
            <button class="chip" data-insert="(alt)">(alt)</button><button class="chip" data-insert="/B‚ô≠">/B‚ô≠</button>
            <button class="chip" data-insert="(‚ô≠9‚ôØ11)">(‚ô≠9‚ôØ11)</button>
          </div>
        </details>
        <details><summary>Structure ‚ñæ</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="A:">A:</button><button class="chip" data-insert="B:">B:</button><button class="chip" data-insert="C:">C:</button>
            <button class="chip" data-insert="Intro:">Intro:</button><button class="chip" data-insert="Bridge:">Bridge:</button>
            <button class="chip" data-insert="D.S. al Coda">D.S. al Coda</button><button class="chip" data-insert="D.S. al Fine">D.S. al Fine</button>
            <button class="chip" data-insert="D.C. al Coda">D.C. al Coda</button><button class="chip" data-insert="D.C. al Fine">D.C. al Fine</button>
            <button class="chip" data-insert="To Coda">To Coda</button><button class="chip" data-insert="Segno ùÑã">Segno ùÑã</button><button class="chip" data-insert="Coda ùÑå">Coda ùÑå</button><button class="chip" data-insert="Fine">Fine</button>
          </div>
        </details>
      </div>
      <textarea id="grid" spellcheck="false"></textarea>
      <div id="validation" class="badge" style="margin-top:6px"></div>
    </div>
  </section>

  <section class="card">
    <h2>Aper√ßus</h2>
    <div class="content">
      <div class="badge">Texte normalis√©</div>
      <div id="preview" style="white-space:pre-wrap;background:#0f1117;border:1px solid #262a31;border-radius:12px;padding:10px;min-height:140px"></div>
    </div>
  </section>
</main>

<!-- D√©pendances -->
<script src="js/grid/parse.js"></script>
<script src="js/grid/grid-bridge.js"></script>

<script>
(function(){
  'use strict';
  const $ = (id)=>document.getElementById(id);
  const params=new URLSearchParams(location.search);
  const itemId=params.get('id')||'temp';
  const API='/api/library';

  function sanitizePreviewText(s){
    if (!s) return '';
    return (GridParse && GridParse._cleanForPreview) ? GridParse._cleanForPreview(s) : String(s);
  }

  function renderPreview(){
    const txt=$('grid').value||'';
    const res=(window.GridParse&&GridParse.parse)?GridParse.parse(txt):{bars:[],html:txt};
    $('preview').textContent = sanitizePreviewText(res.html||txt);
    $('keyBadge').textContent = 'Mesures : '+ (Array.isArray(res.bars)?res.bars.length:0);
  }

  // Palette insertion
  document.addEventListener('click',(e)=>{
    const b=e.target.closest('[data-insert]'); if(!b) return;
    e.preventDefault();
    const ta=$('grid'); ta.focus();
    const s=ta.selectionStart, ed=ta.selectionEnd, v=ta.value;
    const ins=b.dataset.insert;
    ta.value=v.slice(0,s)+ins+v.slice(ed);
    const pos=(s||0)+ins.length; ta.selectionStart=ta.selectionEnd=pos;
    const d=b.closest('details'); if(d) d.removeAttribute('open');
    renderPreview();
  });

  function toBridgeGrid(rec){
    const parsed=(window.GridParse&&GridParse.parse)?GridParse.parse(rec.grid_text||''):{bars:[]};
    return { id:rec.id, name:rec.title||rec.id, author:rec.composer||'', tpb:4, bars:parsed.bars||[], grid_text:rec.grid_text||'' };
  }
  function makeRec(){
    return {
      id: $('id').value.trim(),
      title: $('title').value.trim(),
      composer: $('author').value.trim(),
      style: $('style').value.trim(),
      grid_text: $('grid').value
    };
  }

  $('saveLocal').onclick=function(){
    const obj=makeRec(); if(!obj.id){ alert('ID requis'); return; }
    localStorage.setItem('jazzgrid:'+obj.id, JSON.stringify(obj));
    if (window.Bridge && Bridge.upsertLocalGrid) Bridge.upsertLocalGrid(toBridgeGrid(obj));
    $('saveStatus').textContent='Enregistr√© (local) ‚úî'; setTimeout(()=>{$('saveStatus').textContent=' ';},1200);
  };

  $('saveDb').onclick=async function(){
    const obj=makeRec(); if(!obj.id){ alert('ID requis'); return; }
    try{
      const r=await fetch(API+'/'+encodeURIComponent(obj.id),{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(obj)});
      if(!r.ok){ const t=await r.text(); throw new Error('HTTP '+r.status+' '+t); }
      if (window.Bridge && Bridge.upsertLocalGrid) Bridge.upsertLocalGrid(toBridgeGrid(obj));
      $('saveStatus').textContent='Enregistr√© (DB) ‚úî'; setTimeout(()=>{$('saveStatus').textContent=' ';},1200);
    }catch(e){ alert(e.message); }
  };

  function playNow(){
    const obj=makeRec(); if(!obj.id){ alert('ID requis'); return; }
    // miroir local au cas o√π
    localStorage.setItem('jazzgrid:'+obj.id, JSON.stringify(obj));
    if (window.Bridge && Bridge.upsertLocalGrid) Bridge.upsertLocalGrid(toBridgeGrid(obj));
    if (window.Bridge && Bridge.playGrid) Bridge.playGrid(obj.id);
    else location.href='index.html#grid='+encodeURIComponent(obj.id)+'&auto=1';
  }
  $('playBtn').onclick=playNow;

  // Boot
  (async function(){
    let rec=null;
    try{
      const r=await fetch(API+'/'+encodeURIComponent(itemId));
      if(r.ok) rec=await r.json();
    }catch(_){}
    if(!rec){
      rec={ id:itemId, title:'Blue Bossa', composer:'Kenny Dorham', style:'Bossa',
        grid_text:`A:
ùÑÜ Cm7 | Fm7 | Dm7b5 G7 | Cm7 |
| Cm7 | Fm7 | Dm7b5 G7 | Cm7 ùÑá

B: (Bridge)
| E‚ô≠m7 A‚ô≠7 | D‚ô≠Œî | Dm7b5 G7 | Cm7 |

A:
| Cm7 | Fm7 | Dm7b5 G7 | Cm7 | Fine

D.C. al Fine` };
    }
    $('id').value=rec.id||''; $('title').value=rec.title||''; $('author').value=rec.composer||''; $('style').value=rec.style||''; $('grid').value=rec.grid_text||'';
    renderPreview();
  })();
})();
</script>
</body>
</html>