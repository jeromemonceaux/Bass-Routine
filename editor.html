<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ã‰diteur â€” Netlify + Supabase</title>
  <style>
    body{margin:0;background:#0c0d10;color:#e9ebef;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:#0f1117d0;border-bottom:1px solid #262a31;backdrop-filter:blur(6px)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    a{color:inherit;text-decoration:none;border:1px solid #262a31;padding:6px 10px;border-radius:10px;background:#0f1117}
    main{max-width:1100px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
    @media(max-width:980px){main{grid-template-columns:1fr}}
    .card{background:#14161b;border:1px solid #262a31;border-radius:14px;overflow:hidden}
    .card h2{margin:0;padding:10px 12px;border-bottom:1px solid #262a31;font-size:15px}
    .content{padding:12px}
    input,select,button,textarea{border:1px solid #262a31;background:#0f1117;color:#e9ebef;border-radius:10px;padding:8px 10px;font-family:ui-monospace,Menlo,Consolas,monospace}
    textarea{width:100%;min-height:300px;white-space:pre;line-height:1.5}
    .badge{display:inline-block;border:1px solid #262a31;border-radius:999px;padding:2px 8px;font-size:11px;color:#c9ced6}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    details{position:relative} details>summary{list-style:none;cursor:pointer}
    .dropdown-menu{position:absolute;top:100%;left:0;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;background:#0f1117;border:1px solid #262a31;padding:8px;border-bottom-left-radius:10px;border-bottom-right-radius:10px;z-index:5}
    .chip{padding:6px 8px;border:1px solid #2a2f36;background:#10131a;border-radius:8px;cursor:pointer}
    .compas{background:#0f1117;border:1px solid #262a31;border-radius:12px;padding:10px}
    .grid{display:grid;gap:8px}
    .row{display:grid;grid-template-columns:repeat(var(--cols,4),1fr);gap:8px}
    .cell{position:relative;min-height:62px;display:flex;align-items:center;justify-content:center;text-align:center;padding:6px;border:1px solid #2a2f3a;border-radius:10px;font-family:ui-monospace,Menlo,Consolas,monospace;line-height:1.25}
    .cell small{position:absolute;top:6px;left:8px;opacity:.55;font-size:10px}
    .cell .multi{display:flex;flex-direction:column;gap:2px;white-space:pre-wrap}
    .cell.empty{opacity:.6;font-style:italic}
    .bracketL::before{content:'ğ„†';position:absolute;left:-14px;top:50%;transform:translateY(-50%);font-size:18px}
    .bracketR::after{content:'ğ„‡';position:absolute;right:-14px;top:50%;transform:translateY(-50%);font-size:18px}
  </style>
</head>
<body>
<header><div class="wrap"><a href="index.html">â† BibliothÃ¨que</a><h1 style="margin-left:8px;font-size:18px">Ã‰diteur</h1><span id="saveStatus" style="margin-left:auto" class="badge">Â </span></div></header>
<main>
  <section class="card">
    <h2>MÃ©tadonnÃ©es</h2>
    <div class="content">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><div class="badge">ID</div><input id="id"></div>
        <div><div class="badge">Titre</div><input id="title"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <div><div class="badge">Auteur</div><input id="author"></div>
        <div><div class="badge">Style</div><input id="style"></div>
      </div>
      <div style="margin-top:8px"><div class="badge">Commentaire</div><input id="comment" placeholder="Tempo, tonalitÃ©, mÃ©moâ€¦"></div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <span class="badge">Mesures/ligne</span><select id="cols"><option>2</option><option>3</option><option selected>4</option><option>8</option></select>
        <button id="saveDb" class="badge">Enregistrer (DB)</button>
        <button id="saveLocal" class="badge">Enregistrer (local)</button>
        <span id="keyBadge" class="badge">TonalitÃ©Â : â€”</span>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Grille</h2>
    <div class="content">
      <div class="toolbar" id="toolbar">
        <details><summary>Mesures â–¾</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="ğ„†">ğ„†</button>
            <button class="chip" data-insert="ğ„‡">ğ„‡</button>
            <button class="chip" data-insert=" | ">|</button>
          </div>
        </details>
        <details><summary>Accords â–¾</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="â™­">â™­</button><button class="chip" data-insert="â™¯">â™¯</button>
            <button class="chip" data-insert="Ã¸">Ã¸</button><button class="chip" data-insert="Î”">Î”</button>
            <button class="chip" data-insert="Â°">Â°</button><button class="chip" data-insert="sus4">sus4</button>
            <button class="chip" data-insert="sus2">sus2</button><button class="chip" data-insert="add9">add9</button>
            <button class="chip" data-insert="(alt)">(alt)</button><button class="chip" data-insert="/Bâ™­">/Bâ™­</button>
            <button class="chip" data-insert="(â™­9â™¯9â™¯11â™­13)">(â™­9â™¯9â™¯11â™­13)</button>
          </div>
        </details>
        <details><summary>Structure â–¾</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="A:">A:</button><button class="chip" data-insert="B:">B:</button><button class="chip" data-insert="C:">C:</button>
            <button class="chip" data-insert="Intro:">Intro:</button><button class="chip" data-insert="Bridge:">Bridge:</button>
            <button class="chip" data-insert="D.S. al Coda">D.S. al Coda</button><button class="chip" data-insert="D.S. al Fine">D.S. al Fine</button>
            <button class="chip" data-insert="D.C. al Coda">D.C. al Coda</button><button class="chip" data-insert="D.C. al Fine">D.C. al Fine</button>
            <button class="chip" data-insert="To Coda">To Coda</button><button class="chip" data-insert="Segno ğ„‹">Segno ğ„‹</button><button class="chip" data-insert="Coda ğ„Œ">Coda ğ„Œ</button><button class="chip" data-insert="Fine">Fine</button>
          </div>
        </details>
      </div>
      <textarea id="grid" spellcheck="false"></textarea>
      <div id="validation" class="badge" style="margin-top:6px"></div>
    </div>
  </section>

  <section class="card">
    <h2>AperÃ§us</h2>
    <div class="content">
      <div class="badge">Texte normalisÃ©</div>
      <div id="preview" style="white-space:pre-wrap;background:#0f1117;border:1px solid #262a31;border-radius:12px;padding:10px;min-height:140px"></div>
      <div style="height:8px"></div>
      <div class="badge">Rendu â€œcompasâ€</div>
      <div id="compas" class="compas"></div>
    </div>
  </section>
</main>

<script>
const $=(id)=>document.getElementById(id);
const params=new URLSearchParams(location.search); const itemId=params.get('id');
const API='/api/library'; const KEY_PREFIX='jazzgrid:';

let LIBRARY=[], current=null;

const DIR_RE=/(D\.?S\.?\s*al\s*Coda|D\.?S\.?\s*al\s*Fine|D\.?C\.?\s*al\s*Coda|D\.?C\.?\s*al\s*Fine|To\s*Coda|Fine|Segno\s*ğ„‹|Segno|Coda\s*ğ„Œ|Coda|ğ„‹|ğ„Œ)/i;
function sectionFromLine(line){ const m=line.match(/^\s*[\[(]?(Intro|A\d*|A|B\d*|B|C|D|Bridge|Solo|Solos|Refrain|Coda|Segno)\s*[:\])]?\s*$/i); return m?m[1].toUpperCase():null; }
function normalizeChord(s){ let x=s.trim(); x=x.replace(/^([A-Ga-g])-(?!\d)/,(_,r)=>r.toUpperCase()+'m').replace(/#/g,'â™¯'); const lone=/^(bb|Bb|BB)$/; if(lone.test(x)) return 'Bâ™­'; const m=x.match(/^([A-Ga-g])([bâ™­#â™¯]?)(.*)$/); if(m){ let [_,r,a,rest]=m; r=r.toUpperCase(); if(a==='b') a='â™­'; if(a==='#') a='â™¯'; rest=rest.replace(/maj/gi,'Î”').replace(/\bM7\b/g,'Î”7').replace(/dim/gi,'Â°').replace(/\bo\b(?=\d|\(|$)/g,'Â°').replace(/min/gi,'m').replace(/-7/g,'m7').replace(/m7b5/gi,'m7â™­5').replace(/b(?=\d)/g,'â™­').replace(/\+(?=\d)/g,'â™¯').replace(/add\s*(\d+)/gi,'add$1').replace(/sus\s*(2|4)/gi,'sus$1').replace(/alt/gi,'alt'); x=r+(a||'')+rest; } x=x.replace(/\( *([^)]*) *\)/g,(_,i)=>'('+i.replace(/b(?=\d)/g,'â™­').replace(/#(?=\d)/g,'â™¯').replace(/\s+/g,'').replace(/,/g,'')+')'); x=x.replace(/\/(.)(b|#)/g,(_,n,a)=>'/'+n.toUpperCase()+(a==='b'?'â™­':'â™¯')); return x; }
function isRecognizedChord(s){ const re=new RegExp('^[A-G](?:[â™¯â™­])?(?:m|Î”|Â°|Ã¸|dim|maj)?(?:6|7|9|11|13)?(?:sus[24])?(?:add(?:9|11|13))?(?:[â™­â™¯]?\d{1,2})*(?:\((?:alt|[â™­â™¯]?\d{1,2})+(?:[â™­â™¯]?\d{1,2})*\))?(?:\/[A-G](?:[â™¯â™­])?)?$','u'); return re.test(s); }
function splitIntoChordTokens(str){ const raw=str.trim().split(/\s+/); const out=[]; for(const b of raw){ if(!b) continue; if(/^\(.*\)$/.test(b) && out.length && out[out.length-1].type==='chord'){ out[out.length-1].value += b; } else if(/^[()]+$/.test(b)){ out.push({type:'literal', value:b}); } else out.push({type:'chord', value:b}); } return out; }

function normalizeGrid(text){
  const lines=text.split(/\r?\n/); let left=0,right=0,htmlLines=[],parse={measures:[]}, repeats=[]; let currentSection=null;
  for(const raw of lines){
    if(!raw.trim()){ htmlLines.push(''); continue; }
    const sec=sectionFromLine(raw); if(sec){ currentSection=sec.replace(/\d+/g,''); htmlLines.push('<span class="badge">â–¶ '+escapeHtml(currentSection)+'</span>'); continue; }
    let line=raw.replace(/\s+/g,' ').trim();
    const startsRepeat=/ğ„†/.test(line), endsRepeat=/ğ„‡/.test(line);
    left+=(line.match(/ğ„†/g)||[]).length; right+=(line.match(/ğ„‡/g)||[]).length;
    line=line.replace(/ğ„†\s*(?!\|)/g,'ğ„† | ').replace(/(?<!\|)\s*ğ„‡/g,' | ğ„‡');
    const parts=[]; let bar=[];
    line.split(/(\|ğ„†|ğ„‡)/g).filter(Boolean).forEach(tok=>{
      const t=tok.trim(); if(!t) return;
      if(t==='|'){ parse.measures.push({section:currentSection, items:[...bar]}); bar=[]; parts.push('|'); return; }
      if(t==='ğ„†'||t==='ğ„‡'){ parts.push(t); return; }
      let rest=t, m;
      while((m=rest.match(DIR_RE))){
        const idx=m.index; const dir=m[0];
        const before=rest.slice(0,idx).trim(); if(before){ splitIntoChordTokens(before).forEach(x=>{ const n=normalizeChord(x.value); const ok=isRecognizedChord(n); parts.push(ok?escapeHtml(n):'<span style="border-bottom:2px dotted #f7c87a">'+escapeHtml(n)+'</span>'); if(ok) bar.push(n); }); }
        parts.push('<span class="badge">'+normalizeDirective(dir)+'</span>');
        rest=rest.slice(idx+dir.length).trim();
      }
      if(rest){ splitIntoChordTokens(rest).forEach(x=>{ const n=normalizeChord(x.value); const ok=isRecognizedChord(n); parts.push(ok?escapeHtml(n):'<span style="border-bottom:2px dotted #f7c87a">'+escapeHtml(n)+'</span>'); if(ok) bar.push(n); }); }
    });
    if(bar.length){ parse.measures.push({section:currentSection, items:[...bar]}); bar=[]; }
    if(startsRepeat) repeats.push({pos: parse.measures.length, type:'L'});
    if(endsRepeat) repeats.push({pos: parse.measures.length, type:'R'});
    htmlLines.push(parts.join(' '));
  }
  return {html:htmlLines.join('\n'), parse, repeats, badges:[]};
}
function normalizeDirective(d){ let s=d.replace(/\s+/g,' ').trim(); s=s.replace(/D\.?S\.?/i,'D.S.').replace(/D\.?C\.?/i,'D.C.'); s=s.replace(/al\s*Coda/i,'al Coda').replace(/al\s*Fine/i,'al Fine'); s=s.replace(/To\s*Coda/i,'To Coda'); return s; }
function escapeHtml(s){ return (''+s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// compas
function updateCompas(parse, repeats){
  const colsN=parseInt($('cols').value,10)||4;
  const container=$('compas'); container.innerHTML='';
  const grid=document.createElement('div'); grid.className='grid'; grid.style.setProperty('--cols', colsN);
  let currentSection=null, rowEl=null, cellCount=0, mi=0;
  const repsL=new Set((repeats||[]).filter(r=>r.type==='L').map(r=>r.pos));
  const repsR=new Set((repeats||[]).filter(r=>r.type==='R').map(r=>r.pos));
  function newRow(){ rowEl=document.createElement('div'); rowEl.className='row'; grid.appendChild(rowEl); cellCount=0; }
  (parse.measures||[]).forEach(m=>{
    if(m.section!==currentSection){ currentSection=m.section; const sec=document.createElement('div'); sec.textContent=currentSection?('Section '+currentSection):'Section'; sec.className='badge'; grid.appendChild(sec); newRow(); }
    if(!rowEl || cellCount>=colsN) newRow();
    mi++;
    const cell=document.createElement('div'); cell.className='cell';
    const list=document.createElement('div'); list.className='multi';
    if(m.items && m.items.length){ m.items.forEach(ch=>{ const line=document.createElement('div'); line.textContent=ch; list.appendChild(line); }); }
    else { cell.classList.add('empty'); const line=document.createElement('div'); line.textContent='â€”'; list.appendChild(line); }
    const num=document.createElement('small'); num.textContent=mi;
    if(repsL.has(mi)) cell.classList.add('bracketL');
    if(repsR.has(mi)) cell.classList.add('bracketR');
    cell.appendChild(num); cell.appendChild(list); rowEl.appendChild(cell); cellCount++;
  });
  container.appendChild(grid);
}

// tonalitÃ©
const NOTES_SHARP=['C','Câ™¯','D','Dâ™¯','E','F','Fâ™¯','G','Gâ™¯','A','Aâ™¯','B']; const NOTES_FLAT=['C','Dâ™­','D','Eâ™­','E','F','Gâ™­','G','Aâ™­','A','Bâ™­','B'];
function noteToIndex(note){ const n=note.toUpperCase(); const map={'C':0,'B#':0,'Câ™¯':1,'DB':1,'D':2,'Dâ™¯':3,'EB':3,'E':4,'FB':4,'F':5,'E#':5,'Fâ™¯':6,'GB':6,'G':7,'Gâ™¯':8,'AB':8,'A':9,'Aâ™¯':10,'BB':10,'B':11,'CB':11}; return map[n.replace('â™­','B').replace('â™¯','#')] ?? null; }
function indexToNote(i){ i=(i%12+12)%12; return [1,3,6,8,10].includes(i)?NOTES_FLAT[i]:NOTES_SHARP[i]; }
const SCALE_MAJOR=[0,2,4,5,7,9,11], SCALE_MINOR=[0,2,3,5,7,8,10];
function detectKey(parse){
  const counts=Array(12).fill(0);
  (parse.measures||[]).forEach(m=> (m.items||[]).forEach(sym=>{ const mm=sym.match(/^([A-G])([â™­â™¯]?)/); if(mm){ const r=(mm[1]+(mm[2]||'')).replace('â™­','b').replace('â™¯','#'); const idx=noteToIndex(r); if(idx!=null) counts[idx]++; } }));
  let best=null, second=null;
  for(let i=0;i<12;i++){ for(const minor of [false,true]){
    const scale=minor?SCALE_MINOR:SCALE_MAJOR;
    let s=0; for(let pc=0;pc<12;pc++){ if(counts[pc]){ const rel=(pc-i+12)%12; if(scale.includes(rel)) s+=counts[pc]; } }
    s+=counts[(i+7)%12]*2; s+=Math.floor(counts[(i+2)%12]*0.5);
    const cand={i,minor,score:s};
    if(!best || s>best.score){ second=best; best=cand; } else if(!second || s>second.score){ second=cand; }
  }}
  if(!best) return {label:'â€”', uncertain:true};
  const uncertain = !second || (best.score - second.score) < Math.max(1, best.score*0.08);
  return {label:indexToNote(best.i)+(best.minor?'m':'' ) + (uncertain?' ?':''), uncertain};
}

// API
async function loadFromDB(){
  const r=await fetch(API); if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}
async function saveOneToDB(item){
  const r=await fetch(API + '/' + encodeURIComponent(item.id), {
    method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(item)
  });
  if(!r.ok){ const t=await r.text(); throw new Error('HTTP '+r.status+' '+t); }
  return true;
}

function update(){
  const norm=normalizeGrid($('grid').value);
  $('preview').innerHTML=norm.html;
  const kd=detectKey(norm.parse);
  $('keyBadge').textContent='TonalitÃ© : '+(kd.label||'â€”'); $('keyBadge').className='badge'+(kd.uncertain?' warn':'');
  updateCompas(norm.parse, norm.repeats);
  $('validation').textContent='';
}

document.addEventListener('click',(e)=>{
  const btn=e.target.closest('[data-insert]'); if(btn){ e.preventDefault(); const ta=$('grid'); ta.focus(); const s=ta.selectionStart, ed=ta.selectionEnd, v=ta.value; ta.value=v.slice(0,s)+btn.dataset.insert+v.slice(ed); const pos=(s||0)+btn.dataset.insert.length; ta.selectionStart=ta.selectionEnd=pos; const d=btn.closest('details'); if(d) d.removeAttribute('open'); update(); return; }
  document.querySelectorAll('details[open]').forEach(d=>{ if(!d.contains(e.target)) d.removeAttribute('open'); });
});
document.getElementById('cols').onchange=update;
document.getElementById('saveLocal').onclick=()=>{
  const obj={ id:$('id').value.trim(), title:$('title').value.trim(), composer:$('author').value.trim(), style:$('style').value.trim(), grid_text:$('grid').value };
  localStorage.setItem(KEY_PREFIX+obj.id, JSON.stringify(obj));
  $('saveStatus').textContent='EnregistrÃ© (local) âœ”'; setTimeout(()=>{$('saveStatus').textContent='Â ';},1200);
};
document.getElementById('saveDb').onclick=async()=>{
  const obj={ id:$('id').value.trim(), title:$('title').value.trim(), composer:$('author').value.trim(), style:$('style').value.trim(), grid_text:$('grid').value };
  if(!obj.id){ alert('ID requis'); return; }
  try{ await saveOneToDB(obj); $('saveStatus').textContent='EnregistrÃ© (DB) âœ”'; setTimeout(()=>{$('saveStatus').textContent='Â ';},1200); }catch(e){ alert(e.message); }
};

async function boot(){
  try{ LIBRARY = await loadFromDB(); }catch(_){ LIBRARY=[]; }
  let it = (LIBRARY||[]).find(x=>x.id===itemId);
  if(!it){ it={ id: itemId || 'temp', title:'Blue Bossa', composer:'Kenny Dorham', style:'Bossa', grid_text:`A:
ğ„† Cm7 | Fm7 | Dm7b5 G7 | Cm7 |
| Cm7 | Fm7 | Dm7b5 G7 | Cm7 ğ„‡

B: (Bridge)
| Eâ™­m7 Aâ™­7 | Dâ™­Î” | Dm7b5 G7 | Cm7 |

A:
| Cm7 | Fm7 | Dm7b5 G7 | Cm7 | Fine

D.C. al Fine`}; }
  const local = localStorage.getItem(KEY_PREFIX+it.id); if(local){ try{ const d=JSON.parse(local); it={...it, ...d}; }catch(_){ }
  }
  current=it;
  $('id').value=it.id||''; $('title').value=it.title||''; $('author').value=it.composer||''; $('style').value=it.style||''; $('grid').value=it.grid_text||'';
  update();
}
boot();
</script>
</body>
</html>
