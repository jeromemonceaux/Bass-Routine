<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>√âditeur ‚Äî Bass Routine</title>
  <style>
    body{margin:0;background:#0c0d10;color:#e9ebef;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:#0f1117d0;border-bottom:1px solid #262a31;backdrop-filter:blur(6px)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    a{color:inherit;text-decoration:none;border:1px solid #262a31;padding:6px 10px;border-radius:10px;background:#0f1117}
    main{max-width:1100px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
    @media(max-width:980px){main{grid-template-columns:1fr}}
    .card{background:#14161b;border:1px solid #262a31;border-radius:14px;overflow:hidden}
    .card h2{margin:0;padding:10px 12px;border-bottom:1px solid #262a31;font-size:15px}
    .content{padding:12px}
    input,select,button,textarea{border:1px solid #262a31;background:#0f1117;color:#e9ebef;border-radius:10px;padding:8px 10px;font-family:ui-monospace,Menlo,Consolas,monospace}
    textarea{width:100%;min-height:300px;white-space:pre;line-height:1.5}
    .badge{display:inline-block;border:1px solid #262a31;border-radius:999px;padding:2px 8px;font-size:11px;color:#c9ced6}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    details{position:relative} details>summary{list-style:none;cursor:pointer}
    .dropdown-menu{position:absolute;top:100%;left:0;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;background:#0f1117;border:1px solid #262a31;padding:8px;border-bottom-left-radius:10px;border-bottom-right-radius:10px;z-index:5}
    .chip{padding:6px 8px;border:1px solid #2a2f36;background:#10131a;border-radius:8px;cursor:pointer}
    .compas{background:#0f1117;border:1px solid #262a31;border-radius:12px;padding:10px}
    .grid{display:grid;gap:8px}
    .row{display:grid;grid-template-columns:repeat(var(--cols,4),1fr);gap:8px}
    .cell{position:relative;min-height:62px;display:flex;align-items:center;justify-content:center;text-align:center;padding:6px;border:1px solid #2a2f3a;border-radius:10px;font-family:ui-monospace,Menlo,Consolas,monospace;line-height:1.25}
    .cell small{position:absolute;top:6px;left:8px;opacity:.55;font-size:10px}
    .cell .multi{display:flex;flex-direction:column;gap:2px;white-space:pre-wrap}
    .cell.empty{opacity:.6;font-style:italic}
    .bracketL::before{content:'ùÑÜ';position:absolute;left:-14px;top:50%;transform:translateY(-50%);font-size:18px}
    .bracketR::after{content:'ùÑá';position:absolute;right:-14px;top:50%;transform:translateY(-50%);font-size:18px}
    dialog{border:none;border-radius:12px;background:#14161b;color:#e9ebef;max-width:720px;width:90%}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #262a31}
    .modal-body{padding:12px;max-height:60vh;overflow:auto}
    .pitem{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:8px;border:1px solid #2a2f36;border-radius:10px;margin-bottom:8px;background:#0f1117}
  </style>
</head>
<body>
<header><div class="wrap"><a href="library.html">‚Üê Biblioth√®que</a><h1 style="margin-left:8px;font-size:18px">√âditeur</h1><span id="saveStatus" style="margin-left:auto" class="badge"> </span></div></header>
<main>
  <section class="card">
    <h2>M√©tadonn√©es</h2>
    <div class="content">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><div class="badge">ID</div><input id="id"></div>
        <div><div class="badge">Titre</div><input id="title"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <div><div class="badge">Auteur</div><input id="author"></div>
        <div><div class="badge">Style</div><input id="style"></div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <span class="badge">Mesures/ligne</span><select id="cols"><option>2</option><option>3</option><option selected>4</option><option>8</option></select>
        <button id="saveDb" class="badge">Enregistrer (DB)</button>
        <button id="saveLocal" class="badge">Enregistrer (local)</button>
        <button id="insertProg" class="badge">Ins√©rer progression</button>
        <button id="playInReader" class="badge">Jouer dans le lecteur</button>
        <span id="keyBadge" class="badge">Tonalit√© : ‚Äî</span>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Grille</h2>
    <div class="content">
      <div class="toolbar" id="toolbar">
        <details><summary>Mesures ‚ñæ</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="ùÑÜ">ùÑÜ</button>
            <button class="chip" data-insert="ùÑá">ùÑá</button>
            <button class="chip" data-insert=" | ">|</button>
          </div>
        </details>
        <details><summary>Accords ‚ñæ</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="‚ô≠">‚ô≠</button><button class="chip" data-insert="‚ôØ">‚ôØ</button>
            <button class="chip" data-insert="√∏">√∏</button><button class="chip" data-insert="Œî">Œî</button>
            <button class="chip" data-insert="¬∞">¬∞</button><button class="chip" data-insert="sus4">sus4</button>
            <button class="chip" data-insert="sus2">sus2</button><button class="chip" data-insert="add9">add9</button>
            <button class="chip" data-insert="(alt)">(alt)</button><button class="chip" data-insert="/B‚ô≠">/B‚ô≠</button>
            <button class="chip" data-insert="(‚ô≠9‚ôØ11)">(‚ô≠9‚ôØ11)</button>
          </div>
        </details>
        <details><summary>Structure ‚ñæ</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="A:">A:</button><button class="chip" data-insert="B:">B:</button><button class="chip" data-insert="C:">C:</button>
            <button class="chip" data-insert="Intro:">Intro:</button><button class="chip" data-insert="Bridge:">Bridge:</button>
            <button class="chip" data-insert="D.S. al Coda">D.S. al Coda</button><button class="chip" data-insert="D.S. al Fine">D.S. al Fine</button>
            <button class="chip" data-insert="D.C. al Coda">D.C. al Coda</button><button class="chip" data-insert="D.C. al Fine">D.C. al Fine</button>
            <button class="chip" data-insert="To Coda">To Coda</button><button class="chip" data-insert="Segno ùÑã">Segno ùÑã</button><button class="chip" data-insert="Coda ùÑå">Coda ùÑå</button><button class="chip" data-insert="Fine">Fine</button>
          </div>
        </details>
      </div>
      <textarea id="grid" spellcheck="false"></textarea>
      <div class="badge" style="margin-top:6px">Texte normalis√©</div>
      <pre id="preview" style="white-space:pre-wrap;background:#0f1117;border:1px solid #262a31;border-radius:12px;padding:10px;min-height:120px"></pre>
      <div style="height:8px"></div>
      <div class="badge">Rendu ‚Äúcompas‚Äù</div>
      <div id="compas" class="compas"></div>
    </div>
  </section>

  <section class="card">
    <h2>Aper√ßu structurel</h2>
    <div class="content"><div id="validation" class="badge"></div></div>
  </section>
</main>

<dialog id="progModal">
  <div class="modal-head">
    <div style="font-weight:700">Progressions (tag <code>prog</code>)</div>
    <button id="closeProg">Fermer</button>
  </div>
  <div class="modal-body" id="progList"></div>
</dialog>

<script src="js/grid/parse.js"></script>
<script>
const $=(id)=>document.getElementById(id);
const params=new URLSearchParams(location.search); const itemId=params.get('id');
const API='/api/library';

function escapeHtml(s){ return (''+s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function badge(cls,text){ return '<span class="badge '+cls+'">'+text+'</span>'; }

// --- Compas: rend sans mesures vides dues aux | de d√©but/fin ---
function updateCompasFromText(text){
  const parsed = window.GridParse.parse(text||'');
  const colsN = parseInt($('cols').value,10)||4;
  const container=$('compas'); container.innerHTML='';
  const grid=document.createElement('div'); grid.className='grid'; grid.style.setProperty('--cols', colsN);

  let rowEl=null, cellCount=0, mi=0;
  function newRow(){ rowEl=document.createElement('div'); rowEl.className='row'; grid.appendChild(rowEl); cellCount=0; }

  (parsed.bars||[]).forEach((measure)=>{
    if(!rowEl || cellCount>=colsN) newRow();
    mi++;
    const cell=document.createElement('div'); cell.className='cell';
    const list=document.createElement('div'); list.className='multi';
    if(measure && measure.length){ measure.forEach(ch=>{ const line=document.createElement('div'); line.textContent=ch; list.appendChild(line); }); }
    else { cell.classList.add('empty'); const line=document.createElement('div'); line.textContent='‚Äî'; list.appendChild(line); }
    const num=document.createElement('small'); num.textContent=mi;
    cell.appendChild(num); cell.appendChild(list); rowEl.appendChild(cell); cellCount++;
  });

  container.appendChild(grid);
}

// --- Preview "texte normalis√©" ---
function normalizeAndPreview(text){
  const norm = window.GridParse.normalizeText(text||'');
  $('preview').textContent = norm;
  updateCompasFromText(text||'');
}

// --- API ---
async function loadFromDB(){ const r=await fetch(API); if(!r.ok) throw new Error('HTTP '+r.status); return await r.json(); }
async function getOne(id){ const r=await fetch(API+'/'+encodeURIComponent(id)); if(r.status===404) return null; if(!r.ok) throw new Error('HTTP '+r.status); return await r.json(); }
async function saveOneToDB(item){
  const r=await fetch(API+'/'+encodeURIComponent(item.id),{
    method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(item)
  });
  if(!r.ok){ const t=await r.text(); throw new Error('HTTP '+r.status+' '+t); }
  return true;
}

// --- UI handlers ---
document.addEventListener('click',(e)=>{
  const btn=e.target.closest('[data-insert]'); if(btn){
    e.preventDefault();
    const ta=$('grid'); ta.focus();
    const s=ta.selectionStart, ed=ta.selectionEnd, v=ta.value;
    ta.value=v.slice(0,s)+btn.dataset.insert+v.slice(ed);
    const pos=(s||0)+btn.dataset.insert.length; ta.selectionStart=ta.selectionEnd=pos;
    const d=btn.closest('details'); if(d) d.removeAttribute('open');
    normalizeAndPreview(ta.value);
    return;
  }
  document.querySelectorAll('details[open]').forEach(d=>{ if(!d.contains(e.target)) d.removeAttribute('open'); });
});
$('cols').onchange=()=> normalizeAndPreview($('grid').value);

$('saveLocal').onclick=()=>{
  const obj={ id:$('id').value.trim(), title:$('title').value.trim(), composer:$('author').value.trim(), style:$('style').value.trim(), grid_text:$('grid').value };
  localStorage.setItem('jazzgrid:'+obj.id, JSON.stringify(obj));
  $('saveStatus').textContent='Enregistr√© (local) ‚úî'; setTimeout(()=>{$('saveStatus').textContent=' ';},1200);
};
$('saveDb').onclick=async()=>{
  const obj={ id:$('id').value.trim(), title:$('title').value.trim(), composer:$('author').value.trim(), style:$('style').value.trim(), grid_text:$('grid').value };
  if(!obj.id){ alert('ID requis'); return; }
  try{ await saveOneToDB(obj); $('saveStatus').textContent='Enregistr√© (DB) ‚úî'; setTimeout(()=>{$('saveStatus').textContent=' ';},1200); }catch(e){ alert(e.message); }
};

// "Jouer dans le lecteur"
$('playInReader').onclick=()=>{
  const id = $('id').value.trim();
  if(!id){ alert('ID requis'); return; }
  // on sauvegarde d'abord en local (pratique quand on n‚Äôa pas encore push en DB)
  const obj={ id, title:$('title').value.trim(), composer:$('author').value.trim(), style:$('style').value.trim(), grid_text:$('grid').value };
  localStorage.setItem('jazzgrid:'+obj.id, JSON.stringify(obj));
  // ouvre le player
  window.open('index.html#grid='+encodeURIComponent(id), '_blank');
};

// Progressions (inchang√© sauf rendu)
const progModal=$('progModal'), progList=$('progList');
$('insertProg').onclick=async()=>{
  try{
    const lib=await loadFromDB();
    const progs=lib.filter(x=> (x?.tags||[]).includes('prog') || (x?.id||'').startsWith('prog:')).slice(0,500);
    progList.innerHTML=progs.map(p=>`<div class="pitem">
      <div><div style="font-weight:700">${escapeHtml(p.title||p.id)}</div><div class="muted">${escapeHtml((p.tags||[]).join(', '))}</div><pre style="white-space:pre-wrap;margin:6px 0 0">${escapeHtml(p.grid_text||'')}</pre></div>
      <div><button data-ins="${escapeHtml((p.grid_text||'').replaceAll('"','&quot;'))}">Ins√©rer</button></div>
    </div>`).join('') || '<div class="muted">Aucune progression <code>prog</code> trouv√©e.</div>';
    progModal.showModal();
  }catch(e){ alert(e.message); }
};
$('closeProg').onclick=()=>progModal.close();
progList?.addEventListener('click',(e)=>{
  const b=e.target.closest('button[data-ins]'); if(!b) return;
  const text=b.getAttribute('data-ins')||'';
  const ta=$('grid'); const cur=ta.selectionStart||ta.value.length; ta.value=ta.value.slice(0,cur)+ (cur? '\n':'' ) + text + '\n' + ta.value.slice(cur);
  normalizeAndPreview(ta.value); progModal.close();
});

// Boot
async function boot(){
  // DB puis fallback local
  let it = null;
  if (itemId) it = await getOne(itemId);
  if (!it) {
    const loc = localStorage.getItem('jazzgrid:'+itemId);
    if (loc) it = JSON.parse(loc);
  }
  if (!it) {
    it = { id:itemId||'temp', title:'Blue Bossa', composer:'Kenny Dorham', style:'Bossa',
      grid_text:`A:
ùÑÜ | Cm7 | Fm7 | Dm7‚ô≠5 G7 | Cm7 |
| Cm7 | Fm7 | Dm7‚ô≠5 G7 | Cm7 ùÑá

B (Bridge):
| E‚ô≠m7 A‚ô≠7 | D‚ô≠Œî | Dm7‚ô≠5 G7 | Cm7 |`
    };
  }
  $('id').value=it.id||''; $('title').value=it.title||''; $('author').value=it.composer||''; $('style').value=it.style||''; $('grid').value=it.grid_text||'';
  normalizeAndPreview($('grid').value);
}
boot();
</script>
</body>
</html>