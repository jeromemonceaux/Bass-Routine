<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bass‚ÄëRoutine ‚Äî √âditeur</title>
  <style>
    body{margin:0;background:#0c0d10;color:#e9ebef;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:#0f1117d0;border-bottom:1px solid #262a31;backdrop-filter:blur(6px)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    a{color:inherit;text-decoration:none;border:1px solid #262a31;padding:6px 10px;border-radius:10px;background:#0f1117}
    main{max-width:1100px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
    @media(max-width:980px){main{grid-template-columns:1fr}}
    .card{background:#14161b;border:1px solid #262a31;border-radius:14px;overflow:hidden}
    .card h2{margin:0;padding:10px 12px;border-bottom:1px solid #262a31;font-size:15px}
    .content{padding:12px}
    input,select,button,textarea{border:1px solid #262a31;background:#0f1117;color:#e9ebef;border-radius:10px;padding:8px 10px;font-family:ui-monospace,Menlo,Consolas,monospace}
    textarea{width:100%;min-height:300px;white-space:pre;line-height:1.5}
    .badge{display:inline-block;border:1px solid #262a31;border-radius:999px;padding:2px 8px;font-size:11px;color:#c9ced6}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    details{position:relative} details>summary{list-style:none;cursor:pointer}
    .dropdown-menu{position:absolute;top:100%;left:0;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;background:#0f1117;border:1px solid #262a31;padding:8px;border-bottom-left-radius:10px;border-bottom-right-radius:10px;z-index:5}
    .chip{padding:6px 8px;border:1px solid #2a2f36;background:#10131a;border-radius:8px;cursor:pointer}
    .compas{background:#0f1117;border:1px solid #262a31;border-radius:12px;padding:10px}
    .grid{display:grid;gap:8px}
    .row{display:grid;grid-template-columns:repeat(var(--cols,4),1fr);gap:8px}
    .cell{position:relative;min-height:62px;display:flex;align-items:center;justify-content:center;text-align:center;padding:6px;border:1px solid #2a2f3a;border-radius:10px;font-family:ui-monospace,Menlo,Consolas,monospace;line-height:1.25}
    .cell small{position:absolute;top:6px;left:8px;opacity:.55;font-size:10px}
    .cell .multi{display:flex;flex-direction:column;gap:2px;white-space:pre-wrap}
    .cell.empty{opacity:.6;font-style:italic}
    .bracketL::before{content:'ùÑÜ';position:absolute;left:-14px;top:50%;transform:translateY(-50%);font-size:18px}
    .bracketR::after{content:'ùÑá';position:absolute;right:-14px;top:50%;transform:translateY(-50%);font-size:18px}

    /* simple modal for progressions */
    dialog{border:none;border-radius:12px;background:#14161b;color:#e9ebef;max-width:720px;width:90%}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #262a31}
    .modal-body{padding:12px;max-height:60vh;overflow:auto}
    .pitem{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:8px;border:1px solid #2a2f36;border-radius:10px;margin-bottom:8px;background:#0f1117}
  </style>
</head>
<body>
<header><div class="wrap"><a href="index.html">‚Üê Biblioth√®que</a><h1 style="margin-left:8px;font-size:18px">√âditeur</h1><span id="saveStatus" style="margin-left:auto" class="badge">¬†</span></div></header>
<main>
  <section class="card">
    <h2>M√©tadonn√©es</h2>
    <div class="content">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><div class="badge">ID</div><input id="id"></div>
        <div><div class="badge">Titre</div><input id="title"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <div><div class="badge">Auteur</div><input id="author"></div>
        <div><div class="badge">Style</div><input id="style"></div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <span class="badge">Mesures/ligne</span><select id="cols"><option>2</option><option>3</option><option selected>4</option><option>8</option></select>
        <button id="saveDb" class="badge">Enregistrer (DB)</button>
        <button id="saveLocal" class="badge">Enregistrer (local)</button>
        <button id="insertProg" class="badge">Ins√©rer progression</button>
        <span id="keyBadge" class="badge">Tonalit√©¬†: ‚Äî</span>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Grille</h2>
    <div class="content">
      <div class="toolbar" id="toolbar">
        <details><summary>Mesures ‚ñæ</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="ùÑÜ">ùÑÜ</button>
            <button class="chip" data-insert="ùÑá">ùÑá</button>
            <button class="chip" data-insert=" | ">|</button>
          </div>
        </details>
        <details><summary>Accords ‚ñæ</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="‚ô≠">‚ô≠</button><button class="chip" data-insert="‚ôØ">‚ôØ</button>
            <button class="chip" data-insert="√∏">√∏</button><button class="chip" data-insert="Œî">Œî</button>
            <button class="chip" data-insert="¬∞">¬∞</button><button class="chip" data-insert="sus4">sus4</button>
            <button class="chip" data-insert="sus2">sus2</button><button class="chip" data-insert="add9">add9</button>
            <button class="chip" data-insert="(alt)">(alt)</button><button class="chip" data-insert="/B‚ô≠">/B‚ô≠</button>
            <button class="chip" data-insert="(‚ô≠9‚ôØ9‚ôØ11‚ô≠13)">(‚ô≠9‚ôØ9‚ôØ11‚ô≠13)</button>
          </div>
        </details>
        <details><summary>Structure ‚ñæ</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="A:">A:</button><button class="chip" data-insert="B:">B:</button><button class="chip" data-insert="C:">C:</button>
            <button class="chip" data-insert="Intro:">Intro:</button><button class="chip" data-insert="Bridge:">Bridge:</button>
            <button class="chip" data-insert="D.S. al Coda">D.S. al Coda</button><button class="chip" data-insert="D.S. al Fine">D.S. al Fine</button>
            <button class="chip" data-insert="D.C. al Coda">D.C. al Coda</button><button class="chip" data-insert="D.C. al Fine">D.C. al Fine</button>
            <button class="chip" data-insert="To Coda">To Coda</button><button class="chip" data-insert="Segno ùÑã">Segno ùÑã</button><button class="chip" data-insert="Coda ùÑå">Coda ùÑå</button><button class="chip" data-insert="Fine">Fine</button>
          </div>
        </details>
      </div>
      <textarea id="grid" spellcheck="false"></textarea>
      <div id="validation" class="badge" style="margin-top:6px"></div>
    </div>
  </section>

  <section class="card">
    <h2>Aper√ßus</h2>
    <div class="content">
      <div class="badge">Texte normalis√©</div>
      <div id="preview" style="white-space:pre-wrap;background:#0f1117;border:1px solid #262a31;border-radius:12px;padding:10px;min-height:140px"></div>
      <div style="height:8px"></div>
      <div class="badge">Rendu ‚Äúcompas‚Äù</div>
      <div id="compas" class="compas"></div>
    </div>
  </section>
</main>

<dialog id="progModal">
  <div class="modal-head">
    <div style="font-weight:700">Progressions (tag <code>prog</code>)</div>
    <button id="closeProg">Fermer</button>
  </div>
  <div class="modal-body" id="progList"></div>
</dialog>

<script>
const $=(id)=>document.getElementById(id);
const params=new URLSearchParams(location.search); const itemId=params.get('id');
const API='/api/library'; const KEY_PREFIX='jazzgrid:';
let LIBRARY=[], current=null;

function escapeHtml(s){ return (''+s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function badge(cls,text){ return '<span class="badge '+cls+'">'+text+'</span>'; }

// Simple parser for preview/compas (abr√©g√©)
const DIR_RE=/(D\.?S\.?\s*al\s*Coda|D\.?S\.?\s*al\s*Fine|D\.?C\.?\s*al\s*Coda|D\.?C\.?\s*al\s*Fine|To\s*Coda|Fine|Segno\s*ùÑã|Segno|Coda\s*ùÑå|Coda|ùÑã|ùÑå)/i;
function sectionFromLine(line){ const m=line.match(/^\s*[\[(]?(Intro|A\d*|A|B\d*|B|C|D|Bridge|Solo|Solos|Refrain|Coda|Segno)\s*[:\])]?\s*$/i); return m?m[1].toUpperCase():null; }
function normalizeChord(s){ let x=s.trim(); x=x.replace(/^([A-Ga-g])-(?!\d)/,(_,r)=>r.toUpperCase()+'m').replace(/#/g,'‚ôØ'); const lone=/^(bb|Bb|BB)$/; if(lone.test(x)) return 'B‚ô≠'; const m=x.match(/^([A-Ga-g])([b‚ô≠#‚ôØ]?)(.*)$/); if(m){ let [_,r,a,rest]=m; r=r.toUpperCase(); if(a==='b') a='‚ô≠'; if(a==='#') a='‚ôØ'; rest=rest.replace(/maj/gi,'Œî').replace(/\bM7\b/g,'Œî7').replace(/dim/gi,'¬∞').replace(/\bo\b(?=\d|\(|$)/g,'¬∞').replace(/min/gi,'m').replace(/-7/g,'m7').replace(/m7b5/gi,'m7‚ô≠5').replace(/b(?=\d)/g,'‚ô≠').replace(/\+(?=\d)/g,'‚ôØ'); x=r+(a||'')+rest; } x=x.replace(/\( *([^)]*) *\)/g,(_,i)=>'('+i.replace(/b(?=\d)/g,'‚ô≠').replace(/#(?=\d)/g,'‚ôØ').replace(/\s+/g,'').replace(/,/g,'')+')'); x=x.replace(/\/(.)(b|#)/g,(_,n,a)=>'/'+n.toUpperCase()+(a==='b'?'‚ô≠':'‚ôØ')); return x; }
function isRecognizedChord(s){ const re=new RegExp('^[A-G](?:[‚ôØ‚ô≠])?(?:m|Œî|¬∞|√∏|dim|maj)?(?:6|7|9|11|13)?(?:sus[24])?(?:add(?:9|11|13))?(?:[‚ô≠‚ôØ]?\d{1,2})*(?:\((?:alt|[‚ô≠‚ôØ]?\d{1,2})+(?:[‚ô≠‚ôØ]?\d{1,2})*\))?(?:\/[A-G](?:[‚ôØ‚ô≠])?)?$','u'); return re.test(s); }
function splitIntoChordTokens(str){ const raw=str.trim().split(/\s+/); const out=[]; for(const b of raw){ if(!b) continue; if(/^\(.*\)$/.test(b) && out.length && out[out.length-1].type==='chord'){ out[out.length-1].value += b; } else if(/^[()]+$/.test(b)){ out.push({type:'literal', value:b}); } else out.push({type:'chord', value:b}); } return out; }
function normalizeGrid(text){
  const lines=text.split(/\r?\n/); let htmlLines=[],parse={measures:[]}, repeats=[]; let currentSection=null,left=0,right=0;
  for(const raw of lines){
    if(!raw.trim()){ htmlLines.push(''); continue; }
    const sec=sectionFromLine(raw); if(sec){ currentSection=sec.replace(/\d+/g,''); htmlLines.push('<span class="badge">‚ñ∂ '+escapeHtml(currentSection)+'</span>'); continue; }
    let line=raw.replace(/\s+/g,' ').trim();
    const startsRepeat=/ùÑÜ/.test(line), endsRepeat=/ùÑá/.test(line);
    left+=(line.match(/ùÑÜ/g)||[]).length; right+=(line.match(/ùÑá/g)||[]).length;
    line=line.replace(/ùÑÜ\s*(?!\|)/g,'ùÑÜ | ').replace(/(?<!\|)\s*ùÑá/g,' | ùÑá');
    const parts=[]; let bar=[];
    line.split(/(\|ùÑÜ|ùÑá)/g).filter(Boolean).forEach(tok=>{
      const t=tok.trim(); if(!t) return;
      if(t==='|'){ parse.measures.push({section:currentSection, items:[...bar]}); bar=[]; parts.push('|'); return; }
      if(t==='ùÑÜ'||t==='ùÑá'){ parts.push(t); return; }
      let rest=t, m;
      while((m=rest.match(DIR_RE))){
        const idx=m.index; const dir=m[0];
        const before=rest.slice(0,idx).trim(); if(before){ splitIntoChordTokens(before).forEach(x=>{ const n=normalizeChord(x.value); const ok=isRecognizedChord(n); parts.push(ok?escapeHtml(n):'<span style="border-bottom:2px dotted #f7c87a">'+escapeHtml(n)+'</span>'); if(ok) bar.push(n); }); }
        parts.push('<span class="badge">'+dir+'</span>');
        rest=rest.slice(idx+dir.length).trim();
      }
      if(rest){ splitIntoChordTokens(rest).forEach(x=>{ const n=normalizeChord(x.value); const ok=isRecognizedChord(n); parts.push(ok?escapeHtml(n):'<span style="border-bottom:2px dotted #f7c87a">'+escapeHtml(n)+'</span>'); if(ok) bar.push(n); }); }
    });
    if(bar.length){ parse.measures.push({section:currentSection, items:[...bar]}); bar=[]; }
    if(startsRepeat) repeats.push({pos: parse.measures.length, type:'L'});
    if(endsRepeat) repeats.push({pos: parse.measures.length, type:'R'});
    htmlLines.push(parts.join(' '));
  }
  return {html:htmlLines.join('\n'), parse, repeats, badges:[]};
}
function updateCompas(parse, repeats){
  const colsN=parseInt($('cols').value,10)||4;
  const container=$('compas'); container.innerHTML='';
  const grid=document.createElement('div'); grid.className='grid'; grid.style.setProperty('--cols', colsN);
  let currentSection=null, rowEl=null, cellCount=0, mi=0;
  const repsL=new Set((repeats||[]).filter(r=>r.type==='L').map(r=>r.pos));
  const repsR=new Set((repeats||[]).filter(r=>r.type==='R').map(r=>r.pos));
  function newRow(){ rowEl=document.createElement('div'); rowEl.className='row'; grid.appendChild(rowEl); cellCount=0; }
  (parse.measures||[]).forEach(m=>{
    if(m.section!==currentSection){ currentSection=m.section; const sec=document.createElement('div'); sec.textContent=currentSection?('Section '+currentSection):'Section'; sec.className='badge'; grid.appendChild(sec); newRow(); }
    if(!rowEl || cellCount>=colsN) newRow();
    mi++;
    const cell=document.createElement('div'); cell.className='cell';
    const list=document.createElement('div'); list.className='multi';
    if(m.items && m.items.length){ m.items.forEach(ch=>{ const line=document.createElement('div'); line.textContent=ch; list.appendChild(line); }); }
    else { cell.classList.add('empty'); const line=document.createElement('div'); line.textContent='‚Äî'; list.appendChild(line); }
    const num=document.createElement('small'); num.textContent=mi;
    if(repsL.has(mi)) cell.classList.add('bracketL');
    if(repsR.has(mi)) cell.classList.add('bracketR');
    cell.appendChild(num); cell.appendChild(list); rowEl.appendChild(cell); cellCount++;
  });
  container.appendChild(grid);
}

// Key heuristic (compact)
const NOTES_SHARP=['C','C‚ôØ','D','D‚ôØ','E','F','F‚ôØ','G','G‚ôØ','A','A‚ôØ','B']; const NOTES_FLAT=['C','D‚ô≠','D','E‚ô≠','E','F','G‚ô≠','G','A‚ô≠','A','B‚ô≠','B'];
function noteToIndex(note){ const n=note.toUpperCase(); const map={'C':0,'B#':0,'C‚ôØ':1,'DB':1,'D':2,'D‚ôØ':3,'EB':3,'E':4,'FB':4,'F':5,'E#':5,'F‚ôØ':6,'GB':6,'G':7,'G‚ôØ':8,'AB':8,'A':9,'A‚ôØ':10,'BB':10,'B':11,'CB':11}; return map[n.replace('‚ô≠','B').replace('‚ôØ','#')] ?? null; }
function indexToNote(i){ i=(i%12+12)%12; return [1,3,6,8,10].includes(i)?NOTES_FLAT[i]:NOTES_SHARP[i]; }
const SCALE_MAJOR=[0,2,4,5,7,9,11], SCALE_MINOR=[0,2,3,5,7,8,10];
function detectKey(parse){
  const counts=Array(12).fill(0);
  (parse.measures||[]).forEach(m=> (m.items||[]).forEach(sym=>{ const mm=sym.match(/^([A-G])([‚ô≠‚ôØ]?)/); if(mm){ const r=(mm[1]+(mm[2]||'')).replace('‚ô≠','b').replace('‚ôØ','#'); const idx=noteToIndex(r); if(idx!=null) counts[idx]++; } }));
  let best=null, second=null;
  for(let i=0;i<12;i++){ for(const minor of [false,true]){
    const scale=minor?SCALE_MINOR:SCALE_MAJOR;
    let s=0; for(let pc=0;pc<12;pc++){ if(counts[pc]){ const rel=(pc-i+12)%12; if(scale.includes(rel)) s+=counts[pc]; } }
    s+=counts[(i+7)%12]*2; s+=Math.floor(counts[(i+2)%12]*0.5);
    const cand={i,minor,score:s};
    if(!best || s>best.score){ second=best; best=cand; } else if(!second || s>second.score){ second=cand; }
  }}
  if(!best) return {label:'‚Äî', uncertain:true};
  const uncertain = !second || (best.score - second.score) < Math.max(1, best.score*0.08);
  return {label:indexToNote(best.i)+(best.minor?'m':'' ) + (uncertain?' ?':''), uncertain};
}

function update(){ const norm=normalizeGrid($('grid').value); $('preview').innerHTML=norm.html; const kd=detectKey(norm.parse); $('keyBadge').textContent='Tonalit√© : '+(kd.label||'‚Äî'); $('keyBadge').className='badge'+(kd.uncertain?' warn':''); updateCompas(norm.parse, norm.repeats); }

document.addEventListener('click',(e)=>{
  const btn=e.target.closest('[data-insert]'); if(btn){ e.preventDefault(); const ta=$('grid'); ta.focus(); const s=ta.selectionStart, ed=ta.selectionEnd, v=ta.value; ta.value=v.slice(0,s)+btn.dataset.insert+v.slice(ed); const pos=(s||0)+btn.dataset.insert.length; ta.selectionStart=ta.selectionEnd=pos; const d=btn.closest('details'); if(d) d.removeAttribute('open'); update(); return; }
  document.querySelectorAll('details[open]').forEach(d=>{ if(!d.contains(e.target)) d.removeAttribute('open'); });
});
document.getElementById('cols').onchange=update;

const API='/api/library';
async function loadFromDB(){ const r=await fetch(API); if(!r.ok) throw new Error('HTTP '+r.status); return await r.json(); }
async function saveOneToDB(item){ const r=await fetch(API+'/'+encodeURIComponent(item.id),{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(item)}); if(!r.ok){ const t=await r.text(); throw new Error('HTTP '+r.status+' '+t); } return true; }

document.getElementById('saveLocal').onclick=()=>{
  const obj={ id:$('id').value.trim(), title:$('title').value.trim(), composer:$('author').value.trim(), style:$('style').value.trim(), grid_text:$('grid').value };
  localStorage.setItem('jazzgrid:'+obj.id, JSON.stringify(obj));
  $('saveStatus').textContent='Enregistr√© (local) ‚úî'; setTimeout(()=>{$('saveStatus').textContent='¬†';},1200);
};
document.getElementById('saveDb').onclick=async()=>{
  const obj={ id:$('id').value.trim(), title:$('title').value.trim(), composer:$('author').value.trim(), style:$('style').value.trim(), grid_text:$('grid').value };
  if(!obj.id){ alert('ID requis'); return; }
  try{ await saveOneToDB(obj); $('saveStatus').textContent='Enregistr√© (DB) ‚úî'; setTimeout(()=>{$('saveStatus').textContent='¬†';},1200); }catch(e){ alert(e.message); }
};

// Progression modal
const progModal=$('progModal'), progList=$('progList');
$('insertProg').onclick=async()=>{
  try{
    const lib=await loadFromDB();
    const progs=lib.filter(x=> (x?.tags||[]).includes('prog') || (x?.id||'').startsWith('prog:')).slice(0,500);
    progList.innerHTML=progs.map(p=>`<div class="pitem">
      <div><div style="font-weight:700">${escapeHtml(p.title||p.id)}</div><div class="muted">${escapeHtml((p.tags||[]).join(', '))}</div><pre style="white-space:pre-wrap;margin:6px 0 0">${escapeHtml(p.grid_text||'')}</pre></div>
      <div><button data-ins="${escapeHtml((p.grid_text||'').replaceAll('"','&quot;'))}">Ins√©rer</button></div>
    </div>`).join('') || '<div class="muted">Aucune progression avec tag <code>prog</code> trouv√©e.</div>';
    progModal.showModal();
  }catch(e){ alert(e.message); }
};
$('closeProg').onclick=()=>progModal.close();
progList?.addEventListener('click',(e)=>{
  const b=e.target.closest('button[data-ins]'); if(!b) return;
  const text=b.getAttribute('data-ins')||'';
  const ta=$('grid'); const cur=ta.selectionStart||ta.value.length; ta.value=ta.value.slice(0,cur)+ (cur? '\n':'' ) + text + '\n' + ta.value.slice(cur);
  update(); progModal.close();
});

async function boot(){
  let lib=[]; try{ lib=await loadFromDB(); }catch(_){}
  const it = lib.find(x=>x.id===itemId) || { id:itemId||'temp', title:'Blue Bossa', composer:'Kenny Dorham', style:'Bossa', grid_text:`A:
ùÑÜ Cm7 | Fm7 | Dm7b5 G7 | Cm7 |
| Cm7 | Fm7 | Dm7b5 G7 | Cm7 ùÑá

B: (Bridge)
| E‚ô≠m7 A‚ô≠7 | D‚ô≠Œî | Dm7b5 G7 | Cm7 |

A:
| Cm7 | Fm7 | Dm7b5 G7 | Cm7 | Fine

D.C. al Fine` };
  $('id').value=it.id||''; $('title').value=it.title||''; $('author').value=it.composer||''; $('style').value=it.style||''; $('grid').value=it.grid_text||'';
  update();
}
boot();
</script>
</body>
</html>
