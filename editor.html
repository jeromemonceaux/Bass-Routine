<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bass-Routine — Éditeur</title>
  <style>
    body{margin:0;background:#0c0d10;color:#e9ebef;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:#0f1117d0;border-bottom:1px solid #262a31;backdrop-filter:blur(6px)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    a{color:inherit;text-decoration:none;border:1px solid #262a31;padding:6px 10px;border-radius:10px;background:#0f1117}
    main{max-width:1100px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
    @media(max-width:980px){main{grid-template-columns:1fr}}
    .card{background:#14161b;border:1px solid #262a31;border-radius:14px;overflow:hidden}
    .card h2{margin:0;padding:10px 12px;border-bottom:1px solid #262a31;font-size:15px}
    .content{padding:12px}
    input,select,button,textarea{border:1px solid #262a31;background:#0f1117;color:#e9ebef;border-radius:10px;padding:8px 10px;font-family:ui-monospace,Menlo,Consolas,monospace}
    textarea{width:100%;min-height:300px;white-space:pre;line-height:1.5}
    .badge{display:inline-block;border:1px solid #262a31;border-radius:999px;padding:2px 8px;font-size:11px;color:#c9ced6}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    details{position:relative} details>summary{list-style:none;cursor:pointer}
    .dropdown-menu{position:absolute;top:100%;left:0;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;background:#0f1117;border:1px solid #262a31;padding:8px;border-bottom-left-radius:10px;border-bottom-right-radius:10px;z-index:5}
    .chip{padding:6px 8px;border:1px solid #2a2f36;background:#10131a;border-radius:8px;cursor:pointer}
    .compas{background:#0f1117;border:1px solid #262a31;border-radius:12px;padding:10px}
    .grid{display:grid;gap:8px}
    .row{display:grid;grid-template-columns:repeat(var(--cols,4),1fr);gap:8px}
    .cell{position:relative;min-height:62px;display:flex;align-items:center;justify-content:center;text-align:center;padding:6px;border:1px solid #2a2f3a;border-radius:10px;font-family:ui-monospace,Menlo,Consolas,monospace;line-height:1.25}
    .cell small{position:absolute;top:6px;left:8px;opacity:.55;font-size:10px}
    .cell .multi{display:flex;flex-direction:column;gap:2px;white-space:pre-wrap}
    .cell.empty{opacity:.6;font-style:italic}
    .bracketL::before{content:'𝄆';position:absolute;left:-14px;top:50%;transform:translateY(-50%);font-size:18px}
    .bracketR::after{content:'𝄇';position:absolute;right:-14px;top:50%;transform:translateY(-50%);font-size:18px}
  </style>
</head>
<body>
<header><div class="wrap"><a href="index.html">← Bass-Routine</a><h1 style="margin-left:8px;font-size:18px">Éditeur</h1><span id="saveStatus" style="margin-left:auto" class="badge"> </span></div></header>
<main>
  <section class="card">
    <h2>Métadonnées</h2>
    <div class="content">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><div class="badge">ID</div><input id="id"></div>
        <div><div class="badge">Titre</div><input id="title"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <div><div class="badge">Auteur</div><input id="author"></div>
        <div><div class="badge">Style</div><input id="style"></div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <span class="badge">Mesures/ligne</span><select id="cols"><option>2</option><option>3</option><option selected>4</option><option>8</option></select>
        <button id="saveDb" class="badge">Enregistrer (DB)</button>
        <button id="saveLocal" class="badge">Enregistrer (local)</button>
        <span id="keyBadge" class="badge">Tonalité : —</span>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Grille</h2>
    <div class="content">
      <div class="toolbar" id="toolbar">
        <details><summary>Mesures ▾</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="𝄆">𝄆</button>
            <button class="chip" data-insert="𝄇">𝄇</button>
            <button class="chip" data-insert=" | ">|</button>
          </div>
        </details>
        <details><summary>Accords ▾</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="♭">♭</button><button class="chip" data-insert="♯">♯</button>
            <button class="chip" data-insert="ø">ø</button><button class="chip" data-insert="Δ">Δ</button>
            <button class="chip" data-insert="°">°</button><button class="chip" data-insert="sus4">sus4</button>
            <button class="chip" data-insert="sus2">sus2</button><button class="chip" data-insert="add9">add9</button>
            <button class="chip" data-insert="(alt)">(alt)</button><button class="chip" data-insert="/B♭">/B♭</button>
            <button class="chip" data-insert="(♭9♯9♯11♭13)">(♭9♯9♯11♭13)</button>
          </div>
        </details>
        <details><summary>Structure ▾</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="A:">A:</button><button class="chip" data-insert="B:">B:</button><button class="chip" data-insert="C:">C:</button>
            <button class="chip" data-insert="Intro:">Intro:</button><button class="chip" data-insert="Bridge:">Bridge:</button>
            <button class="chip" data-insert="D.S. al Coda">D.S. al Coda</button><button class="chip" data-insert="D.S. al Fine">D.S. al Fine</button>
            <button class="chip" data-insert="D.C. al Coda">D.C. al Coda</button><button class="chip" data-insert="D.C. al Fine">D.C. al Fine</button>
            <button class="chip" data-insert="To Coda">To Coda</button><button class="chip" data-insert="Segno 𝄋">Segno 𝄋</button><button class="chip" data-insert="Coda 𝄌">Coda 𝄌</button><button class="chip" data-insert="Fine">Fine</button>
          </div>
        </details>
      </div>
      <textarea id="grid" spellcheck="false"></textarea>
      <div id="validation" class="badge" style="margin-top:6px"></div>
    </div>
  </section>

  <section class="card">
    <h2>Aperçus</h2>
    <div class="content">
      <div class="badge">Texte normalisé</div>
      <div id="preview" style="white-space:pre-wrap;background:#0f1117;border:1px solid #262a31;border-radius:12px;padding:10px;min-height:140px"></div>
      <div style="height:8px"></div>
      <div class="badge">Rendu “compas”</div>
      <div id="compas" class="compas"></div>
    </div>
  </section>
</main>

<script>
const $=(id)=>document.getElementById(id);
const params=new URLSearchParams(location.search); const itemId=params.get('id');
const API='/api/library'; const KEY_PREFIX='jazzgrid:';
let LIBRARY=[], current=null;

// Parser helpers
const DIR_RE=/(D\\.?S\\.?\\s*al\\s*Coda|D\\.?S\\.?\\s*al\\s*Fine|D\\.?C\\.?\\s*al\\s*Coda|D\\.?C\\.?\\s*al\\s*Fine|To\\s*Coda|Fine|Segno\\s*𝄋|Segno|Coda\\s*𝄌|Coda|𝄋|𝄌)/i;
function sectionFromLine(line){ const m=line.match(/^\\s*[\\[(]?(Intro|A\\d*|A|B\\d*|B|C|D|Bridge|Solo|Solos|Refrain|Coda|Segno)\\s*[:\\])]?\\s*$/i); return m?m[1].toUpperCase():null; }
function normalizeChord(s){
  let x=s.trim();
  x=x.replace(/^([A-Ga-g])-(?!\\d)/,(_,r)=>r.toUpperCase()+'m');
  x=x.replace(/#/g,'♯');
  if(/^(bb|Bb|BB)$/.test(x)) return 'B♭';
  const m=x.match(/^([A-Ga-g])([b♭#♯]?)(.*)$/);
  if(m){
    let [_,r,a,rest]=m; r=r.toUpperCase();
    if(a==='b') a='♭'; if(a==='#') a='♯';
    rest=rest.replace(/maj/gi,'Δ').replace(/\\bM7\\b/g,'Δ7').replace(/dim/gi,'°')
             .replace(/\\bo\\b(?=\\d|\\(|$)/g,'°').replace(/min/gi,'m').replace(/-7/g,'m7')
             .replace(/m7b5/gi,'m7♭5').replace(/b(?=\\d)/g,'♭').replace(/\\+(?=\\d)/g,'♯')
             .replace(/add\\s*(\\d+)/gi,'add$1').replace(/sus\\s*(2|4)/gi,'sus$1').replace(/alt/gi,'alt');
    x=r+(a||'')+rest;
  }
  x=x.replace(/\\( *([^)]*) *\\)/g,(_,i)=>'('+i.replace(/b(?=\\d)/g,'♭').replace(/#(?=\\d)/g,'♯').replace(/\\s+/g,'').replace(/,/g,'')+')');
  x=x.replace(/\\/(.)(b|#)/g,(_,n,a)=>'/'+n.toUpperCase()+(a==='b'?'♭':'♯'));
  return x;
}
function isRecognizedChord(s){
  const re=new RegExp('^[A-G](?:[♯♭])?(?:m|Δ|°|ø|dim|maj)?(?:6|7|9|11|13)?(?:sus[24])?(?:add(?:9|11|13))?(?:[♭♯]?\\d{1,2})*(?:\\((?:alt|[♭♯]?\\d{1,2})+(?:[♭♯]?\\d{1,2})*\\))?(?:\\/[A-G](?:[♯♭])?)?$','u');
  return re.test(s);
}
function splitIntoChordTokens(str){
  const raw=str.trim().split(/\\s+/); const out=[];
  for(const b of raw){
    if(!b) continue;
    if(/^\\(.*\\)$/.test(b) && out.length && out[out.length-1].type==='chord'){ out[out.length-1].value+=b; }
    else if(/^[()]+$/.test(b)){ out.push({type:'literal', value:b}); }
    else out.push({type:'chord', value:b});
  }
  return out;
}
function normalizeGrid(text){
  const lines=text.split(/\\r?\\n/); let htmlLines=[],parse={measures:[]}, repeats=[]; let currentSection=null;
  for(const raw of lines){
    if(!raw.trim()){ htmlLines.push(''); continue; }
    const sec=sectionFromLine(raw); if(sec){ currentSection=sec.replace(/\\d+/g,''); htmlLines.push('<span class="badge">▶ '+sec.toUpperCase().replace(/\\d+/g,'')+'</span>'); continue; }
    let line=raw.replace(/\\s+/g,' ').trim();
    const startsRepeat=/𝄆/.test(line), endsRepeat=/𝄇/.test(line);
    line=line.replace(/𝄆\\s*(?!\\|)/g,'𝄆 | ').replace(/(?<!\\|)\\s*𝄇/g,' | 𝄇');
    const parts=[]; let bar=[];
    line.split(/(\\|𝄆|𝄇)/g).filter(Boolean).forEach(tok=>{
      const t=tok.trim(); if(!t) return;
      if(t==='|'){ parse.measures.push({section:currentSection, items:[...bar]}); bar=[]; parts.push('|'); return; }
      if(t==='𝄆'||t==='𝄇'){ parts.push(t); return; }
      let rest=t, m;
      while((m=rest.match(DIR_RE))){
        const idx=m.index; const dir=m[0];
        const before=rest.slice(0,idx).trim();
        if(before){
          splitIntoChordTokens(before).forEach(x=>{
            const n=normalizeChord(x.value); const ok=isRecognizedChord(n);
            parts.push(ok?n:'<span style="border-bottom:2px dotted #f7c87a">'+n+'</span>'); if(ok) bar.push(n);
          });
        }
        parts.push('<span class="badge">'+dir+'</span>');
        rest=rest.slice(idx+dir.length).trim();
      }
      if(rest){
        splitIntoChordTokens(rest).forEach(x=>{
          const n=normalizeChord(x.value); const ok=isRecognizedChord(n);
          parts.push(ok?n:'<span style="border-bottom:2px dotted #f7c87a">'+n+'</span>'); if(ok) bar.push(n);
        });
      }
    });
    if(bar.length){ parse.measures.push({section:currentSection, items:[...bar]}); bar=[]; }
    if(startsRepeat) repeats.push({pos: parse.measures.length, type:'L'});
    if(endsRepeat) repeats.push({pos: parse.measures.length, type:'R'});
    htmlLines.push(parts.join(' '));
  }
  return {html:htmlLines.join('\\n'), parse, repeats};
}
function updateCompas(parse, repeats){
  const colsN=parseInt(document.getElementById('cols').value,10)||4;
  const container=document.getElementById('compas'); container.innerHTML='';
  const grid=document.createElement('div'); grid.className='grid'; grid.style.setProperty('--cols', colsN);
  let currentSection=null, rowEl=null, cellCount=0, mi=0;
  const repsL=new Set((repeats||[]).filter(r=>r.type==='L').map(r=>r.pos));
  const repsR=new Set((repeats||[]).filter(r=>r.type==='R').map(r=>r.pos));
  function newRow(){ rowEl=document.createElement('div'); rowEl.className='row'; grid.appendChild(rowEl); cellCount=0; }
  (parse.measures||[]).forEach(m=>{
    if(m.section!==currentSection){ currentSection=m.section; const sec=document.createElement('div'); sec.textContent=currentSection?('Section '+currentSection):'Section'; sec.className='badge'; grid.appendChild(sec); newRow(); }
    if(!rowEl || cellCount>=colsN) newRow();
    mi++;
    const cell=document.createElement('div'); cell.className='cell';
    const list=document.createElement('div'); list.className='multi';
    if(m.items && m.items.length){ m.items.forEach(ch=>{ const line=document.createElement('div'); line.textContent=ch; list.appendChild(line); }); }
    else { cell.classList.add('empty'); const line=document.createElement('div'); line.textContent='—'; list.appendChild(line); }
    const num=document.createElement('small'); num.textContent=mi; cell.appendChild(num);
    if(repsL.has(mi)) cell.classList.add('bracketL');
    if(repsR.has(mi)) cell.classList.add('bracketR');
    cell.appendChild(list); rowEl.appendChild(cell); cellCount++;
  });
  container.appendChild(grid);
}

async function loadFromDB(){ const r=await fetch('/api/library'); if(!r.ok) throw new Error('HTTP '+r.status); return await r.json(); }
async function saveOneToDB(item){ const r=await fetch('/api/library/'+encodeURIComponent(item.id),{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(item)}); if(!r.ok){ const t=await r.text(); throw new Error('HTTP '+r.status+' '+t); } return true; }

function update(){
  const norm=normalizeGrid(document.getElementById('grid').value);
  document.getElementById('preview').innerHTML=norm.html;
  updateCompas(norm.parse, norm.repeats);
}

document.addEventListener('click',(e)=>{
  const btn=e.target.closest('[data-insert]'); if(btn){
    e.preventDefault();
    const ta=document.getElementById('grid'); ta.focus();
    const s=ta.selectionStart, ed=ta.selectionEnd, v=ta.value;
    ta.value=v.slice(0,s)+btn.dataset.insert+v.slice(ed);
    const pos=(s||0)+btn.dataset.insert.length; ta.selectionStart=ta.selectionEnd=pos;
    const d=btn.closest('details'); if(d) d.removeAttribute('open'); update(); return;
  }
  document.querySelectorAll('details[open]').forEach(d=>{ if(!d.contains(e.target)) d.removeAttribute('open'); });
});

document.getElementById('cols').onchange=update;
document.getElementById('saveLocal').onclick=()=>{
  const obj={ id:document.getElementById('id').value.trim(), title:document.getElementById('title').value.trim(), composer:document.getElementById('author').value.trim(), style:document.getElementById('style').value.trim(), grid_text:document.getElementById('grid').value };
  localStorage.setItem(KEY_PREFIX+obj.id, JSON.stringify(obj));
  document.getElementById('saveStatus').textContent='Enregistré (local) ✔'; setTimeout(()=>{document.getElementById('saveStatus').textContent=' ';},1200);
};
document.getElementById('saveDb').onclick=async()=>{
  const obj={ id:document.getElementById('id').value.trim(), title:document.getElementById('title').value.trim(), composer:document.getElementById('author').value.trim(), style:document.getElementById('style').value.trim(), grid_text:document.getElementById('grid').value };
  if(!obj.id){ alert('ID requis'); return; }
  try{ await saveOneToDB(obj); document.getElementById('saveStatus').textContent='Enregistré (DB) ✔'; setTimeout(()=>{document.getElementById('saveStatus').textContent=' ';},1200); }catch(e){ alert(e.message); }
};

async function boot(){
  let lib=[]; try{ lib=await loadFromDB(); }catch(_){}
  const it = lib.find(x=>x.id===itemId) || { id:itemId||'temp', title:'Blue Bossa', composer:'Kenny Dorham', style:'Bossa', grid_text:`A:
𝄆 Cm7 | Fm7 | Dm7b5 G7 | Cm7 |
| Cm7 | Fm7 | Dm7b5 G7 | Cm7 𝄇

B: (Bridge)
| E♭m7 A♭7 | D♭Δ | Dm7b5 G7 | Cm7 |

A:
| Cm7 | Fm7 | Dm7b5 G7 | Cm7 | Fine

D.C. al Fine` };
  document.getElementById('id').value=it.id||'';
  document.getElementById('title').value=it.title||'';
  document.getElementById('author').value=it.composer||'';
  document.getElementById('style').value=it.style||'';
  document.getElementById('grid').value=it.grid_text||'';
  update();
}
boot();
</script>
</body>
</html>
