<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>√âditeur ‚Äî Bass-Routine</title>
  <style>
    body{margin:0;background:#0c0d10;color:#e9ebef;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:#0f1117d0;border-bottom:1px solid #262a31;backdrop-filter:blur(6px)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    a{color:inherit;text-decoration:none;border:1px solid #262a31;padding:6px 10px;border-radius:10px;background:#0f1117}
    main{max-width:1100px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
    @media(max-width:980px){main{grid-template-columns:1fr}}
    .card{background:#14161b;border:1px solid #262a31;border-radius:14px;overflow:hidden}
    .card h2{margin:0;padding:10px 12px;border-bottom:1px solid #262a31;font-size:15px}
    .content{padding:12px}
    input,select,button,textarea{border:1px solid #262a31;background:#0f1117;color:#e9ebef;border-radius:10px;padding:8px 10px;font-family:ui-monospace,Menlo,Consolas,monospace}
    textarea{width:100%;min-height:300px;white-space:pre;line-height:1.5}
    .badge{display:inline-block;border:1px solid #262a31;border-radius:999px;padding:2px 8px;font-size:11px;color:#c9ced6}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    details{position:relative} details>summary{list-style:none;cursor:pointer}
    .dropdown-menu{position:absolute;top:100%;left:0;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;background:#0f1117;border:1px solid #262a31;padding:8px;border-bottom-left-radius:10px;border-bottom-right-radius:10px;z-index:5}
    .chip{padding:6px 8px;border:1px solid #2a2f36;background:#10131a;border-radius:8px;cursor:pointer}
    .compas{background:#0f1117;border:1px solid #262a31;border-radius:12px;padding:10px}
    .grid{display:grid;gap:8px}
    .row{display:grid;grid-template-columns:repeat(var(--cols,4),1fr);gap:8px}
    .cell{position:relative;min-height:62px;display:flex;align-items:center;justify-content:center;text-align:center;padding:6px;border:1px solid #2a2f3a;border-radius:10px;font-family:ui-monospace,Menlo,Consolas,monospace;line-height:1.25}
    .cell small{position:absolute;top:6px;left:8px;opacity:.55;font-size:10px}
    .cell .multi{display:flex;flex-direction:column;gap:2px;white-space:pre-wrap}
    .cell.empty{opacity:.6;font-style:italic}
    .bracketL::before{content:'ùÑÜ';position:absolute;left:-14px;top:50%;transform:translateY(-50%);font-size:18px}
    .bracketR::after{content:'ùÑá';position:absolute;right:-14px;top:50%;transform:translateY(-50%);font-size:18px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <a href="library.html">‚Üê Biblioth√®que</a>
    <h1 style="margin-left:8px;font-size:18px">√âditeur</h1>
    <span id="saveStatus" style="margin-left:auto" class="badge"> </span>
    <button id="playBtn" class="badge">‚ñ∂ Jouer dans le lecteur</button>
  </div>
</header>

<main>
  <section class="card">
    <h2>M√©tadonn√©es</h2>
    <div class="content">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><div class="badge">ID</div><input id="id"></div>
        <div><div class="badge">Titre</div><input id="title"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <div><div class="badge">Auteur</div><input id="author"></div>
        <div><div class="badge">Style</div><input id="style"></div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <span class="badge">Mesures/ligne</span><select id="cols"><option>2</option><option>3</option><option selected>4</option><option>8</option></select>
        <button id="saveDb" class="badge">Enregistrer (DB)</button>
        <button id="saveLocal" class="badge">Enregistrer (local)</button>
        <span id="keyBadge" class="badge">Tonalit√© : ‚Äî</span>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Grille</h2>
    <div class="content">
      <div class="toolbar" id="toolbar">
        <details><summary>Mesures ‚ñæ</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="ùÑÜ">ùÑÜ</button>
            <button class="chip" data-insert="ùÑá">ùÑá</button>
            <button class="chip" data-insert=" | ">|</button>
          </div>
        </details>
        <details><summary>Accords ‚ñæ</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="‚ô≠">‚ô≠</button><button class="chip" data-insert="‚ôØ">‚ôØ</button>
            <button class="chip" data-insert="√∏">√∏</button><button class="chip" data-insert="Œî">Œî</button>
            <button class="chip" data-insert="¬∞">¬∞</button><button class="chip" data-insert="sus4">sus4</button>
            <button class="chip" data-insert="sus2">sus2</button><button class="chip" data-insert="add9">add9</button>
            <button class="chip" data-insert="(alt)">(alt)</button><button class="chip" data-insert="/B‚ô≠">/B‚ô≠</button>
            <button class="chip" data-insert="(‚ô≠9‚ôØ11)">(‚ô≠9‚ôØ11)</button>
          </div>
        </details>
        <details><summary>Structure ‚ñæ</summary>
          <div class="dropdown-menu">
            <button class="chip" data-insert="A:">A:</button><button class="chip" data-insert="B:">B:</button><button class="chip" data-insert="C:">C:</button>
            <button class="chip" data-insert="Intro:">Intro:</button><button class="chip" data-insert="Bridge:">Bridge:</button>
            <button class="chip" data-insert="D.S. al Coda">D.S. al Coda</button><button class="chip" data-insert="D.S. al Fine">D.S. al Fine</button>
            <button class="chip" data-insert="D.C. al Coda">D.C. al Coda</button><button class="chip" data-insert="D.C. al Fine">D.C. al Fine</button>
            <button class="chip" data-insert="To Coda">To Coda</button><button class="chip" data-insert="Segno ùÑã">Segno ùÑã</button><button class="chip" data-insert="Coda ùÑå">Coda ùÑå</button><button class="chip" data-insert="Fine">Fine</button>
          </div>
        </details>
      </div>
      <textarea id="grid" spellcheck="false"></textarea>
      <div id="validation" class="badge" style="margin-top:6px"></div>
    </div>
  </section>

  <section class="card">
    <h2>Aper√ßus</h2>
    <div class="content">
      <div class="badge">Texte normalis√©</div>
      <div id="preview" style="white-space:pre-wrap;background:#0f1117;border:1px solid #262a31;border-radius:12px;padding:10px;min-height:140px"></div>
      <div style="height:8px"></div>
      <div class="badge">Rendu ‚Äúcompas‚Äù</div>
      <div id="compas" class="compas"></div>
    </div>
  </section>
</main>

<!-- D√©pendances -->
<script src="js/grid/parse.js"></script>
<script src="js/grid/grid-bridge.js"></script>

<script>
(function(){
  'use strict';

  // --- Utils ---
  const $ = (id)=>document.getElementById(id);
  const params = new URLSearchParams(location.search);
  const itemId = params.get('id') || 'temp';
  const API = '/api/library';
  const escapeHtml = s => (''+s)
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

  // --- Normalisation ‚Äúcompas‚Äù (corrig√©e, sans mesures fant√¥mes) ---
  function updateCompas(parse, repeats){
    const colsN = parseInt(($('cols')||{}).value,10) || 4;
    const container = $('compas'); if (!container) return;
    container.innerHTML = '';

    // 1) Normalise mesures depuis parseur (bars) ou ancien format (measures/items)
    let measures = [];
    if (parse && Array.isArray(parse.bars)) {
      measures = parse.bars.map(arr => ({ section: null, items: Array.isArray(arr) ? arr : [] }));
    } else if (parse && Array.isArray(parse.measures)) {
      measures = parse.measures.map(m => ({ section: m.section || null, items: Array.isArray(m.items)? m.items : [] }));
    }

    // 2) Sections √©ventuelles
    let sections = Array.isArray(parse && parse.sections) ? parse.sections.slice().sort((a,b)=>a.index-b.index) : [];
    let nextSecIdx = 0; let nextSec = sections[0];

    // 3) Reprises (L/R)
    const repsL = new Set(), repsR = new Set();
    const R = (repeats && typeof repeats === 'object' && !Array.isArray(repeats)) ? repeats : null;
    const arrRep = Array.isArray(repeats) ? repeats : null;
    if (arrRep){
      arrRep.forEach(r=>{ if(r?.type==='L') repsL.add(r.pos); else if(r?.type==='R') repsR.add(r.pos); });
    } else if (R){
      (R.L||[]).forEach(p=>repsL.add(p)); (R.R||[]).forEach(p=>repsR.add(p));
    } else if (parse && parse.repeats){
      (parse.repeats.L||[]).forEach(p=>repsL.add(p)); (parse.repeats.R||[]).forEach(p=>repsR.add(p));
    }

    // 4) Grille
    const grid = document.createElement('div');
    grid.className = 'grid';
    grid.style.setProperty('--cols', colsN);

    let rowEl = null, cellCount = 0, mi = 0;
    function newRow(){ rowEl = document.createElement('div'); rowEl.className = 'row'; grid.appendChild(rowEl); cellCount = 0; }

    measures.forEach((m, idx) => {
      // Section (depuis parse.sections)‚Ä¶
      if (nextSec && (idx+1) === nextSec.index) {
        const sec = document.createElement('div');
        sec.textContent = 'Section ' + (nextSec.label || '');
        sec.className = 'badge';
        grid.appendChild(sec);
        newRow();
        nextSecIdx++; nextSec = sections[nextSecIdx];
      }
      // ‚Ä¶ou depuis l‚Äôancien parse (section sur la mesure)
      else if (m.section && (idx === 0 || measures[idx-1].section !== m.section)) {
        const sec = document.createElement('div');
        sec.textContent = 'Section ' + m.section;
        sec.className = 'badge';
        grid.appendChild(sec);
        newRow();
      }

      if (!rowEl || cellCount >= colsN) newRow();
      mi++;

      const cell = document.createElement('div'); cell.className = 'cell';
      const list = document.createElement('div'); list.className = 'multi';

      // Filtre les tokens vides, s√©parateurs et artefacts
      const items = (m.items||[]).filter(ch => ch && ch!=='|' && ch!=='ùÑÜ' && ch!=='ùÑá');

      if (items.length){
        items.forEach(ch => { const d = document.createElement('div'); d.textContent = ch; list.appendChild(d); });
      } else {
        cell.classList.add('empty');
        const d = document.createElement('div'); d.textContent = '‚Äî'; list.appendChild(d);
      }

      const num = document.createElement('small'); num.textContent = mi;
      if (repsL.has(mi)) cell.classList.add('bracketL');
      if (repsR.has(mi)) cell.classList.add('bracketR');

      cell.appendChild(num); cell.appendChild(list);
      rowEl.appendChild(cell); cellCount++;
    });

    container.appendChild(grid);
  }

  // G√©n√®re un ‚Äútexte normalis√©‚Äù de secours √† partir des bars si le parseur ne fournit pas html
  function buildNormalizedText(res){
    if (res && typeof res.html === 'string' && res.html.trim()) return res.html;
    const bars = Array.isArray(res?.bars) ? res.bars : [];
    if (!bars.length) return '';
    const perLine = 4;
    const lines = [];
    for (let i=0; i<bars.length; i+=perLine){
      const chunk = bars.slice(i,i+perLine).map(m=>{
        const arr = Array.isArray(m) ? m : (m && m.chords) || [];
        return arr.length ? arr.join(' ') : '‚Äî';
      });
      lines.push('| '+chunk.join(' | ')+' |');
    }
    return escapeHtml(lines.join('\n'));
  }

  function normalizeAndPreview(){
    const text = ($('grid')?.value)||'';
    const res = (window.GridParse && typeof window.GridParse.parse==='function')
      ? window.GridParse.parse(text)
      : { html: escapeHtml(text), bars: [], repeats: {L:[],R:[]}, sections: [] };

    $('preview').innerHTML = buildNormalizedText(res);
    updateCompas(res, res.repeats||[]);
    // Petit indicateur : nombre de mesures d√©tect√©es
    $('keyBadge').textContent = 'Mesures : ' + (Array.isArray(res?.bars) ? res.bars.length : (Array.isArray(res?.measures)? res.measures.length : 0));
  }

  // Insertion via la palette
  document.addEventListener('click',(e)=>{
    const btn = e.target.closest('[data-insert]'); if(btn){
      e.preventDefault();
      const ta=$('grid'); ta.focus();
      const s=ta.selectionStart, ed=ta.selectionEnd, v=ta.value;
      const ins=btn.dataset.insert;
      ta.value=v.slice(0,s)+ins+v.slice(ed);
      const pos=(s||0)+ins.length; ta.selectionStart=ta.selectionEnd=pos;
      const d=btn.closest('details'); if(d) d.removeAttribute('open');
      normalizeAndPreview();
    }
    document.querySelectorAll('details[open]').forEach(d=>{ if(!d.contains(e.target)) d.removeAttribute('open'); });
  });
  $('cols').onchange = normalizeAndPreview;

  // Conversion DB -> objet bridge (pour le lecteur)
  function toBridgeGrid(rec){
    const parsed = (window.GridParse && window.GridParse.parse) ? window.GridParse.parse(rec.grid_text||'') : { bars: [] };
    return {
      id: rec.id,
      name: rec.title || rec.id,
      author: rec.composer || '',
      key: rec.key || null,
      mode: rec.mode || null,
      tpb: rec.tpb || 4,
      bars: Array.isArray(parsed.bars) ? parsed.bars : []
    };
  }

  function makeDbRecord(){
    return {
      id: $('id').value.trim(),
      title: $('title').value.trim(),
      composer: $('author').value.trim(),
      style: $('style').value.trim(),
      grid_text: $('grid').value
    };
  }

  // Save local
  $('saveLocal').onclick = function(){
    const obj = makeDbRecord();
    if(!obj.id){ alert('ID requis'); return; }
    localStorage.setItem('jazzgrid:'+obj.id, JSON.stringify(obj));
    // miroir local pour le lecteur
    if (window.Bridge && typeof Bridge.upsertLocalGrid==='function'){
      Bridge.upsertLocalGrid(toBridgeGrid(obj));
    }
    $('saveStatus').textContent='Enregistr√© (local) ‚úî'; setTimeout(()=>{$('saveStatus').textContent=' ';},1200);
  };

  // Save DB
  $('saveDb').onclick = async function(){
    const obj = makeDbRecord();
    if(!obj.id){ alert('ID requis'); return; }
    try{
      const r = await fetch(API+'/'+encodeURIComponent(obj.id),{
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(obj)
      });
      if(!r.ok){ const t=await r.text(); throw new Error('HTTP '+r.status+' '+t); }
      if (window.Bridge && typeof Bridge.upsertLocalGrid==='function'){
        Bridge.upsertLocalGrid(toBridgeGrid(obj));
      }
      $('saveStatus').textContent='Enregistr√© (DB) ‚úî'; setTimeout(()=>{$('saveStatus').textContent=' ';},1200);
    }catch(e){ alert(e.message); }
  };

  // Play (m√™me handler pour le bouton ent√™te et ‚Äî si tu le remets ‚Äî le bouton dans le formulaire)
  function doPlay(){
    const obj = makeDbRecord();
    if(!obj.id){ alert('ID requis'); return; }
    // Sauvegarde locale rapide (pour le lecteur)
    localStorage.setItem('jazzgrid:'+obj.id, JSON.stringify(obj));
    if (window.Bridge && typeof Bridge.upsertLocalGrid==='function'){
      Bridge.upsertLocalGrid(toBridgeGrid(obj));
    }
    if (window.Bridge && typeof Bridge.playGrid==='function'){
      Bridge.playGrid(obj.id); // redirige vers index.html#grid=<id>&auto=1
    } else {
      location.href = 'index.html#grid=' + encodeURIComponent(obj.id) + '&auto=1';
    }
  }
  $('playBtn').onclick = doPlay;
  // si tu gardes un second bouton dans le DOM :
  const playInReader = document.getElementById('playInReader');
  if (playInReader) playInReader.onclick = doPlay;

  // Boot : charge l‚Äôitem par ID (endpoint /api/library/:id), sinon fallback
  (async function boot(){
    const id = itemId;
    let rec = null;
    try{
      const r = await fetch(API+'/'+encodeURIComponent(id));
      if (r.ok) rec = await r.json();
    }catch(_){}
    if (!rec){
      rec = {
        id, title:'Blue Bossa', composer:'Kenny Dorham', style:'Bossa',
        grid_text:`A:
ùÑÜ Cm7 | Fm7 | Dm7b5 G7 | Cm7 |
| Cm7 | Fm7 | Dm7b5 G7 | Cm7 ùÑá

B: (Bridge)
| E‚ô≠m7 A‚ô≠7 | D‚ô≠Œî | Dm7b5 G7 | Cm7 |

A:
| Cm7 | Fm7 | Dm7b5 G7 | Cm7 | Fine

D.C. al Fine`
      };
    }
    $('id').value     = rec.id || '';
    $('title').value  = rec.title || '';
    $('author').value = rec.composer || '';
    $('style').value  = rec.style || '';
    $('grid').value   = rec.grid_text || '';
    normalizeAndPreview();
  })();

})();
</script>
</body>
</html>