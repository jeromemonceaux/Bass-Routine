<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Melodic Progressions v25</title>
<style>
  :root{
    --bg:#0f1115; --panel:#151922; --ink:#e8ecf1; --muted:#9aa4b2; --accent:#6ee7ff; --good:#72f1b8; --tile:#0f1320; --string:#b8996d;
    --chip-bg:var(--chip-bg); --btn-1:var(--chip-bg); --btn-2:#171e29; --border:#101620; --tile-border:#101620;
    --ticker-h: 102px; --header-h: 62px; --safe-bottom: calc(env(safe-area-inset-bottom) + 16px);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;z-index:20;background:var(--panel);border-bottom:1px solid var(--border);padding:6px 10px}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:nowrap}
  .left{display:flex;align-items:center;gap:8px;min-width:0;flex-wrap:nowrap}
  .chips{display:flex;gap:6px;align-items:center;min-width:0;flex-wrap:wrap}
  .chip{background:var(--chip-bg);border:1px solid var(--border);border-radius:12px;padding:6px 8px;font-weight:700;font-size:12px;white-space:nowrap}
  .btn{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg, var(--chip-bg), #171e29);color:var(--ink);padding:8px 10px;border-radius:10px;font-weight:800;cursor:pointer;-webkit-tap-highlight-color: transparent;font-size:14px}
  .iconbtn{padding:8px 10px; min-width:0}
  #playBtn{font-size:22px;padding:12px 16px;border-width:2px}
  #infBtn{font-size:18px;padding:10px 14px;border-width:2px}
  .toggled{outline:2px solid var(--good); box-shadow:0 0 0 2px rgba(114,241,184,.45) inset;}
  select,input[type=range],input[type=checkbox]{accent-color:var(--good);background:transparent;color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:6px 8px;font-weight:600}
  #err{display:none;position:fixed;top:62px;left:0;right:0;z-index:50;background:#3b0d0d;color:#ffe1e1;padding:8px 12px;font-weight:700}
  /* Fixed pulse next to chord */
  #pulseWrap{display:flex;align-items:center;gap:8px;justify-content:center;margin:6px 0 2px}
  #pulseDot{width:14px;height:14px;border-radius:50%;background:#444}
  #pulseDot.on{background:var(--good);box-shadow:0 0 10px var(--good)}
  main{min-height: calc(100svh - var(--header-h) - var(--ticker-h) - var(--safe-bottom));display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:6px 10px calc(var(--ticker-h) + var(--safe-bottom) + 2px);text-align:center}
  .big-row{display:flex;align-items:center;gap:10px;justify-content:center;margin-top:2px}
  .big-chord{font-weight:900;letter-spacing:.5px;margin:0 0 2px}
  .notes{color:var(--muted);margin:0 0 4px}
  .desc{color:var(--muted);font-size:12px;margin:2px 0 8px}
  .fretboard-wrap{width:100%;max-width:980px;margin:4px auto;background:var(--tile);border:1px solid var(--border);border-radius:12px;padding:6px}
  .ticker-wrap{position:fixed;bottom:0;left:0;right:0;z-index:30;background:var(--panel);border-top:1px solid var(--border);padding:6px 0 var(--safe-bottom)}
  /* Portrait => grid multi-line; Landscape => one line horizontal */
  .ticker{width:100%;max-width:980px;margin:0 auto;display:grid;grid-template-columns: repeat(2, minmax(0, 1fr));gap:8px;padding:6px;align-items:flex-start;overflow:auto;max-height:42vh}
  @media (orientation: landscape){ .ticker{display:flex;gap:8px;overflow-x:auto;overflow-y:hidden;max-height:unset;white-space:nowrap} }
  .measure{flex:0 0 auto;min-width:128px;background:var(--tile);border:1px solid var(--tile-border);border-radius:10px;padding:6px;position:relative}
  .measure.ghost{opacity:.35}
  .measure.active{box-shadow:0 0 0 2px rgba(114,241,184,.4) inset}
  .measure .num{position:absolute;top:-10px;left:8px;background:var(--panel);border-radius:8px;padding:2px 6px;font-size:11px;color:var(--muted);border:1px solid var(--border)}
  .mgrid{display:grid;grid-template-columns: 1fr;gap:6px}
  .halfgrid{display:grid;grid-template-columns: 1fr 1fr;gap:6px}
  .tile{min-height:36px;text-align:center;padding:8px;border-radius:8px;background:var(--tile);border:1px solid var(--tile-border);transition:background-color .15s ease;font-weight:900;opacity:.98;user-select:none;font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .tile.active{border-color:var(--good); box-shadow:0 0 0 2px rgba(114,241,184,.85) inset, 0 0 0 2px rgba(114,241,184,.25)}
  .tile.split2{outline:3px solid rgba(114,241,184,.9)}
  .tile:hover{background:var(--tile-hover)}
  @media (orientation: portrait){ 
    .big-chord{font-size: 8.4vw} .notes{font-size: 3.0vw}
    .topbar{flex-wrap:wrap}
    .left{flex-wrap:wrap}
    .btn, select, input[type=range]{font-size:13px;padding:6px 8px}
    .chip{font-size:11px;padding:5px 7px}
  }
  @media (orientation: landscape){ .big-chord{font-size: clamp(26px,4.4vw,52px)} .notes{font-size: clamp(10px,1.3vw,15px)} main{padding-top:4px} }
  /* Options */
  #optsOverlay{position:fixed;inset:0;z-index:40;display:none;background:rgba(0,0,0,.35)}
  #optsPanel{position:fixed;left:0;right:0;bottom:0;z-index:41;background:var(--panel);border-top-left-radius:14px;border-top-right-radius:14px;max-height:72vh; overflow:auto; padding:10px;border-top:1px solid var(--border);padding-bottom: calc(10px + var(--safe-bottom));}
  .panelHeader{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .grid{display:grid;gap:10px}
  .field{display:flex;flex-direction:column;gap:6px}
  .label{font-size:12px;color:var(--muted)}
  @media (min-width: 421px){ .grid{grid-template-columns: repeat(6, minmax(0,1fr))} }
  @media (max-width: 420px){ .grid{grid-template-columns: repeat(2, minmax(0,1fr))} .chip{display:none} }

  /* Theme palettes */
  [data-theme="light"]{
  --bg:#f9fbff; --panel:#ffffff; --ink:#0b1220; --muted:#5c6b80; --accent:#0b67d9; --good:#0aa770;
  --tile:#f2f5fb; --string:#8b6e4a; --chip-bg:#eef3fb; --btn-1:#f6f9ff; --btn-2:#e9f0fb;
  --border:#d7e0ea; --tile-border:#dfe6ef; --tile-hover:#ffffff;
  --fretline: rgba(0,0,0,.12); --fretdot: rgba(0,0,0,.14);
}
  [data-theme="jazz"]{
  --bg:#0d0b0a; --panel:#16110d; --ink:#f5ead3; --muted:#c7bca6; --accent:#f6c945; --good:#70e1b7;
  --tile:#1a1410; --string:#d0a46a; --chip-bg:#22170f; --btn-1:#241a12; --btn-2:#1b140e;
  --border:#3a2b1f; --tile-border:#3a2b1f; --tile-hover: rgba(246,201,69,.06);
  --fretline: rgba(246,201,69,.22); --fretdot: rgba(246,201,69,.20);
}


  /* Theme palettes */
  [data-theme="light"]{
  --bg:#f9fbff; --panel:#ffffff; --ink:#0b1220; --muted:#5c6b80; --accent:#0b67d9; --good:#0aa770;
  --tile:#f2f5fb; --string:#8b6e4a; --chip-bg:#eef3fb; --btn-1:#f6f9ff; --btn-2:#e9f0fb;
  --border:#d7e0ea; --tile-border:#dfe6ef; --tile-hover:#ffffff;
  --fretline: rgba(0,0,0,.12); --fretdot: rgba(0,0,0,.14);
}
  [data-theme="jazz"]{
  --bg:#0d0b0a; --panel:#16110d; --ink:#f5ead3; --muted:#c7bca6; --accent:#f6c945; --good:#70e1b7;
  --tile:#1a1410; --string:#d0a46a; --chip-bg:#22170f; --btn-1:#241a12; --btn-2:#1b140e;
  --border:#3a2b1f; --tile-border:#3a2b1f; --tile-hover: rgba(246,201,69,.06);
  --fretline: rgba(246,201,69,.22); --fretdot: rgba(246,201,69,.20);
}


  /* === Landscape chord meta to the right of the main chord === */
  @media (orientation: landscape){
    main{position:relative}
    .big-row{margin-bottom:2px}
    /* Notes to the right of big chord */
    #chordNotes{
      float:right;
      margin-left:16px;
      margin-right:6px;
      display:inline-block;
      font-weight:700;
    }
    /* Description overlays under the notes on the right to save vertical space */
    #descText{
      float:right;
      clear:right;
      margin-top:-2px;          /* slight overlay */
      margin-left:16px;
      margin-right:6px;
      opacity:.9;
      max-width:42ch;           /* avoid too wide lines */
      text-align:left;
    }
    /* Ensure the fretboard starts on a new row under the floated elements */
    .fretboard-wrap{clear:both}
  }

</style>
</head>
<body>
  <div id="grid-view"></div>

<header>
  <div class="topbar">
    <div class="left">
      <div class="chips">
        <div class="chip" id="scaleLabel">C major</div>
        <div class="chip" id="pentaLabel">Pentatonic: C D E G A</div>
      </div>
      <div class="chip">
        <label for="inspSel" style="font-size:12px;color:var(--muted);margin-right:6px;font-weight:600">Style</label>
        <select id="inspSel">
          <option value="yours" selected>Your sequence</option>
          <option value="ivviiv">I‚ÄìV‚Äìvi‚ÄìIV</option>
          <option value="iiviijazz">ii‚ÄìV‚ÄìI (jazz)</option>
          <option value="bossa">Bossa cycle</option>
          <option value="minorcolor">Minor color</option>
          <option value="neosoul">Neo-soul (diatonic)</option>
          <option value="generate">Generate (diatonic)</option>
        </select>
      </div>
    </div>
    <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
      <button class="btn iconbtn" id="randomBtn" title="Random progression">üé≤</button>
      <button class="btn iconbtn" id="playBtn" title="Play/Pause">‚ñ∂Ô∏é</button>
      <button class="btn iconbtn" id="infBtn" title="Infinite play (switch grid each cycle)">‚ñ∂Ô∏é‚ôæÔ∏é</button>
      <button class="btn iconbtn" id="optsBtn" title="Settings">‚öôÔ∏è</button>
    </div>
  </div>
</header>

<div id="err"></div>

<main>
  
  <div class="big-row">
    <div id="pulseWrap"><div id="pulseDot"></div></div>
    <div class="big-chord" id="bigChord">Cmaj7</div>
  </div>
  <div class="notes" id="chordNotes">C E G B</div>
  <div class="desc" id="descText">Inspired by your sequence</div>

  <div class="fretboard-wrap">
    <svg id="fretboard" viewBox="0 0 1000 200" preserveAspectRatio="xMidYMid meet" style="width:100%;height:auto;display:block"></svg>
  </div>
</main>

<div class="ticker-wrap" id="tickerWrap">
  <div class="ticker" id="ticker" aria-label="Progression (bars)"></div>
</div>

<!-- Options modal -->
<div id="optsOverlay"></div>
<div id="optsPanel" aria-modal="true" role="dialog" hidden>
  <div class="panelHeader">
    <strong>Settings</strong>
    <button class="btn iconbtn" id="closeOpts">‚úï</button>
  </div>
  <div class="grid">
    <div class="field"><span class="label">Language</span><select id="langSel"><option value="en" selected>English</option><option value="fr">Fran√ßais</option></select></div>
    <div class="field"><span class="label">Key</span><select id="keySel"></select></div>
    <div class="field"><span class="label">Mode</span><select id="modeSel"><option value="major">Major</option><option value="minor">Minor</option></select></div>
    <div class="field"><span class="label">Beats per bar</span><select id="tpmSel"><option value="4" selected>4/4</option><option value="3">3/4</option></select></div>
    <div class="field"><span class="label">Bars</span><select id="measuresSel"><option>4</option><option selected>8</option><option>12</option><option>16</option></select></div>
    <div class="field"><span class="label">BPM <span id="bpmVal">96</span></span><input type="range" id="bpm" min="40" max="220" value="96"></div>
    <div class="field"><span class="label">Style (theme)</span><select id="styleSel"><option value="dark" selected>Dark</option><option value="light">Light</option><option value="jazz">Jazz</option></select></div>
    <div class="field"><span class="label">Voicing</span><select id="voicingSel"><option value="close">Close position (top 3 strings)</option><option value="open">Open position (near nut)</option></select></div>
    <div class="field"><span class="label">Strings</span><select id="stringsSel"><option value="4" selected>4-string bass</option><option value="5">5-string bass</option></select></div>
    <div class="field"><span class="label">Chord packing</span><select id="packSel"><option value="auto" selected>Auto (ii‚ÄìV only)</option><option value="always">Always (two chords/bar)</option><option value="never">Never (one chord/bar)</option></select></div>
    <div class="field"><span class="label">Metronome</span>
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <span class="led" id="beatLed" style="width:12px;height:12px;border-radius:50%;background:#444"></span>
        <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="metroOn"> On</label>
        <span>Vol.</span>
        <input type="range" id="metroVol" min="0" max="100" value="92" style="flex:1;min-width:200px">
        <span style="color:var(--muted);font-size:12px">Accent: </span>
        <select id="accentSel"><option value="classic" selected>Classic (1)</option><option value="jazz">Jazz (2 & 4)</option></select>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  function showErr(msg){ var e=document.getElementById('err'); if(!e) return; e.style.display='block'; e.textContent='Error: '+msg; }
  window.addEventListener('error', function(ev){ showErr(ev.message); });
  window.addEventListener('unhandledrejection', function(ev){ try{ showErr((ev.reason && (ev.reason.message||ev.reason)) || 'Promise rejected'); }catch(e){ showErr('Promise rejected'); } });

  function el(id){ return document.getElementById(id); }
  var rootEl=document.documentElement;
  var langSel=el('langSel'), keySel=el('keySel'), modeSel=el('modeSel'), tpmSel=el('tpmSel'),
      measuresSel=el('measuresSel'), bpm=el('bpm'), bpmVal=el('bpmVal'),
      styleSel=el('styleSel'), voicingSel=el('voicingSel'), stringsSel=el('stringsSel'),
      packSel=el('packSel'), accentSel=el('accentSel'),
      playBtn=el('playBtn'), randomBtn=el('randomBtn'), optsBtn=el('optsBtn'),
      bigChord=el('bigChord'), chordNotes=el('chordNotes'),
      ticker=el('ticker'), tickerWrap=el('tickerWrap'),
      fretboard=el('fretboard'),
      metroOn=el('metroOn'), metroVol=el('metroVol'),
      beatLed=el('beatLed'), pulseDot=el('pulseDot'),
      optsOverlay=el('optsOverlay'), optsPanel=el('optsPanel'), closeOpts=el('closeOpts'),
      scaleLabel=el('scaleLabel'), pentaLabel=el('pentaLabel'),
      inspSel=el('inspSel'), descText=el('descText'),
      infBtn=el('infBtn');

  if(!keySel||!modeSel||!tpmSel||!measuresSel||!bpm||!playBtn||!ticker||!fretboard||!inspSel){
    showErr('Missing UI elements'); return;
  }

  /* ===== Library of 50 in-key progressions (diatonic by roman numerals) ===== */
  var PROG_DB = [
    {name:"Pop Four", desc:"Inspired by I‚ÄìV‚Äìvi‚ÄìIV", base:["Imaj7","V7","vi7","IVmaj7","Imaj7","V7","vi7","IVmaj7"], diatonic:true},
    {name:"Basic Turnaround", desc:"Inspired by jazz turnaround", base:["Imaj7","vi7","ii7","V7","Imaj7","vi7","ii7","V7"], diatonic:true},
    {name:"ii‚ÄìV‚ÄìI x2", desc:"Two ii‚ÄìV‚ÄìI cycles", base:["ii7","V7","Imaj7","vi7","ii7","V7","Imaj7","V7"], diatonic:true},
    {name:"Walk Up", desc:"Neo-soul color", base:["Imaj7","ii7","iii7","IVmaj7","vi7","V7","ii7","V7"], diatonic:true},
    {name:"Plagal Pop", desc:"IV emphasis", base:["Imaj7","IVmaj7","vi7","V7","Imaj7","IVmaj7","ii7","V7"], diatonic:true},
    {name:"Soul Step", desc:"vi‚ÄìIV‚ÄìI‚ÄìV vibe", base:["vi7","IVmaj7","Imaj7","V7","vi7","IVmaj7","Imaj7","V7"], diatonic:true},
    {name:"Circle Ease", desc:"iii‚Äìvi‚Äìii‚ÄìV", base:["iii7","vi7","ii7","V7","iii7","vi7","ii7","V7"], diatonic:true},
    {name:"Bossa Breeze", desc:"I‚Äìiii‚Äìvi‚Äìii", base:["Imaj7","iii7","vi7","ii7","Imaj7","iii7","vi7","ii7"], diatonic:true},
    {name:"Pop Lift", desc:"I‚ÄìV‚Äìvi‚ÄìV", base:["Imaj7","V7","vi7","V7","Imaj7","V7","vi7","V7"], diatonic:true},
    /* Minor-mode entries */
    {name:"Minor Cadence 1", desc:"ii‚ÄìV‚Äìi (minor)", base:["ii7","v7","i7","VImaj7","ii7","v7","i7","VImaj7"], diatonic:true, mode:"minor"},
    {name:"Minor Colors", desc:"i‚Äìiv‚Äìv‚Äìi", base:["i7","iv7","v7","i7","i7","VImaj7","IIImaj7","v7"], diatonic:true, mode:"minor"},
    {name:"Minor Motion", desc:"iv emphasis", base:["i7","iv7","i7","v7","i7","iv7","i7","VImaj7"], diatonic:true, mode:"minor"},
    {name:"Minor Walk", desc:"i‚ÄìVI‚ÄìIII‚Äìv", base:["i7","VImaj7","IIImaj7","v7","i7","VImaj7","IIImaj7","v7"], diatonic:true, mode:"minor"},
    {name:"Minor ii‚ÄìV Loop", desc:"ii‚ÄìV to i", base:["ii7","v7","i7","i7","ii7","v7","i7","VImaj7"], diatonic:true, mode:"minor"},
    /* More major */
    {name:"Rhythm Lite", desc:"Rhythm changes lite", base:["Imaj7","VImaj7","ii7","V7","Imaj7","VImaj7","ii7","V7"], diatonic:true},
    {name:"Diatonic Neo", desc:"I‚Äìii‚ÄìIV‚Äìiii", base:["Imaj7","ii7","IVmaj7","iii7","vi7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Sunset Pop", desc:"I‚Äìvi‚ÄìIV‚ÄìV", base:["Imaj7","vi7","IVmaj7","V7","Imaj7","vi7","IVmaj7","V7"], diatonic:true},
    {name:"Lift & Resolve", desc:"IV‚Äìiii‚Äìvi‚ÄìV", base:["IVmaj7","iii7","vi7","V7","Imaj7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Soft Bossa", desc:"I‚Äìvi‚Äìii‚ÄìV", base:["Imaj7","vi7","ii7","V7","Imaj7","vi7","ii7","V7"], diatonic:true},
    {name:"Cool Step", desc:"I‚Äìii‚Äìiii‚ÄìIV", base:["Imaj7","ii7","iii7","IVmaj7","vi7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Open Air", desc:"I‚ÄìIV‚Äìii‚ÄìV", base:["Imaj7","IVmaj7","ii7","V7","Imaj7","IVmaj7","ii7","V7"], diatonic:true},
    {name:"Gentle Cycle", desc:"iii‚Äìvi‚ÄìIV‚ÄìV", base:["iii7","vi7","IVmaj7","V7","Imaj7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Smooth Rail", desc:"ii‚ÄìV‚ÄìI‚Äìvi", base:["ii7","V7","Imaj7","vi7","ii7","V7","Imaj7","vi7"], diatonic:true},
    {name:"Neo Glide", desc:"vi‚Äìii‚ÄìV‚ÄìI", base:["vi7","ii7","V7","Imaj7","vi7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Lifted Neo", desc:"I‚Äìiii‚ÄìIV‚Äìii", base:["Imaj7","iii7","IVmaj7","ii7","Imaj7","vi7","ii7","V7"], diatonic:true},
    {name:"Smoove Pop", desc:"vi‚ÄìV‚ÄìIV‚ÄìV", base:["vi7","V7","IVmaj7","V7","Imaj7","vi7","ii7","V7"], diatonic:true},
    {name:"Velvet Walk", desc:"ii‚Äìiii‚ÄìIV‚ÄìV", base:["ii7","iii7","IVmaj7","V7","Imaj7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Gentle Rise", desc:"I‚Äìii‚ÄìV‚ÄìI", base:["Imaj7","ii7","V7","Imaj7","vi7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Late Night", desc:"iii‚Äìvi‚Äìii‚ÄìV alt", base:["iii7","vi7","ii7","V7","Imaj7","vi7","ii7","V7"], diatonic:true},
    {name:"Clean Cycle", desc:"I‚ÄìIV‚ÄìI‚ÄìV", base:["Imaj7","IVmaj7","Imaj7","V7","Imaj7","ii7","V7","Imaj7"], diatonic:true},
    {name:"City Lights", desc:"IV‚ÄìI‚Äìvi‚ÄìV", base:["IVmaj7","Imaj7","vi7","V7","IVmaj7","Imaj7","ii7","V7"], diatonic:true},
    {name:"Blue Sky", desc:"ii‚ÄìV‚ÄìIV‚ÄìV", base:["ii7","V7","IVmaj7","V7","Imaj7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Quiet Pop", desc:"I‚ÄìV‚Äìii‚ÄìIV", base:["Imaj7","V7","ii7","IVmaj7","Imaj7","V7","ii7","V7"], diatonic:true},
    {name:"Neo Flow", desc:"I‚Äìvi‚Äìii‚Äìiii", base:["Imaj7","vi7","ii7","iii7","IVmaj7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Summer Neo", desc:"iii‚ÄìIV‚ÄìI‚Äìii", base:["iii7","IVmaj7","Imaj7","ii7","vi7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Bright Rail", desc:"I‚ÄìV‚ÄìIV‚ÄìV", base:["Imaj7","V7","IVmaj7","V7","Imaj7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Cinematic", desc:"vi‚Äìiii‚ÄìIV‚Äìii", base:["vi7","iii7","IVmaj7","ii7","Imaj7","vi7","ii7","V7"], diatonic:true},
    {name:"Open Sky", desc:"IV‚Äìii‚ÄìI‚ÄìV", base:["IVmaj7","ii7","Imaj7","V7","IVmaj7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Warm Breeze", desc:"ii‚ÄìIV‚ÄìV‚ÄìI", base:["ii7","IVmaj7","V7","Imaj7","vi7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Glass Line", desc:"I‚Äìii‚Äìiii‚Äìvi", base:["Imaj7","ii7","iii7","vi7","ii7","V7","Imaj7","V7"], diatonic:true},
    {name:"Soft Motion", desc:"IV‚Äìiii‚Äìii‚ÄìI", base:["IVmaj7","iii7","ii7","Imaj7","vi7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Airy Neo", desc:"ii‚ÄìI‚Äìvi‚ÄìV", base:["ii7","Imaj7","vi7","V7","ii7","V7","Imaj7","V7"], diatonic:true},
    {name:"Dream Pop", desc:"I‚Äìvi‚Äìiii‚ÄìIV", base:["Imaj7","vi7","iii7","IVmaj7","Imaj7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Velvet Pop", desc:"IV‚Äìvi‚ÄìI‚ÄìV", base:["IVmaj7","vi7","Imaj7","V7","IVmaj7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Late Train", desc:"ii‚ÄìV‚ÄìI with tag", base:["ii7","V7","Imaj7","Imaj7","vi7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Morning Sun", desc:"I‚ÄìIV‚Äìvi‚ÄìV", base:["Imaj7","IVmaj7","vi7","V7","Imaj7","IVmaj7","ii7","V7"], diatonic:true},
    {name:"Silky Turn", desc:"iii‚Äìvi‚ÄìI‚ÄìIV", base:["iii7","vi7","Imaj7","IVmaj7","ii7","V7","Imaj7","V7"], diatonic:true},
    {name:"Easy Soul", desc:"vi‚ÄìI‚ÄìIV‚ÄìV", base:["vi7","Imaj7","IVmaj7","V7","vi7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Gentle Bossa", desc:"I‚Äìii‚Äìiii‚Äìii", base:["Imaj7","ii7","iii7","ii7","Imaj7","vi7","ii7","V7"], diatonic:true},
    {name:"Light & Air", desc:"I‚Äìii‚ÄìIV‚ÄìV", base:["Imaj7","ii7","IVmaj7","V7","Imaj7","ii7","V7","Imaj7"], diatonic:true},
    {name:"Silk Neo", desc:"ii‚ÄìIV‚ÄìI‚Äìvi", base:["ii7","IVmaj7","Imaj7","vi7","ii7","V7","Imaj7","V7"], diatonic:true}
  ];
  while (PROG_DB.length < 50){
    PROG_DB.push({name:"Diatonic Set "+(PROG_DB.length+1), desc:"In-key variation", base:["Imaj7","vi7","ii7","V7","Imaj7","IVmaj7","ii7","V7"], diatonic:true});
  }

  var UNIQUE_KEYS = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  var NOTES_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  var NOTES_FLAT  = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];

  var INSP = {
    yours: { label:"Your sequence", base:["Fmaj7","G7","Em7","A7","Dm7","G7","Cmaj7","C#¬∞7"], desc:"Inspired by your sequence", diatonic:false },
    ivviiv: { label:"I‚ÄìV‚Äìvi‚ÄìIV", base:["I","V","vi","IV"], desc:"Inspired by I‚ÄìV‚Äìvi‚ÄìIV", diatonic:true },
    iiviijazz: { label:"ii‚ÄìV‚ÄìI (jazz)", base:["ii7","V7","Imaj7","vi7","ii7","V7","Imaj7"], desc:"Inspired by common ii‚ÄìV‚ÄìI", diatonic:true },
    bossa: { label:"Bossa cycle", base:["ii7","V7","Imaj7","IVmaj7","ii7","V7","Imaj7"], desc:"Inspired by bossa cycles", diatonic:true },
    minorcolor: { label:"Minor color", base:["i7","iv7","bVIImaj7","IIImaj7"], desc:"Inspired by minor color", diatonic:true },
    neosoul: { label:"Neo-soul (diatonic)", base:["Imaj7","ii7","IVmaj7","iii7","vi7"], desc:"Inspired by neo-soul diatonic moves", diatonic:true },
    generate: { label:"Generate (diatonic)", base:[], desc:"Generated in-key", diatonic:true, gen:true }
  };

  function prefersFlats(key){ return ["F","Bb","Eb","Ab","Db","Gb"].indexOf(key)>=0 || key.indexOf("b")>=0; }
  function idxOf(note, flats){ var arr = flats ? NOTES_FLAT : NOTES_SHARP; return arr.indexOf(note); }
  function noteIndexAny(n){ var i = NOTES_SHARP.indexOf(n); if (i<0) i = NOTES_FLAT.indexOf(n); return i; }

  function romanToChord(roman, key, mode){
    var flats = prefersFlats(key);
    var A = flats?NOTES_FLAT:NOTES_SHARP;
    var scaleMaj = [0,2,4,5,7,9,11];
    var scaleMin = [0,2,3,5,7,8,10];
    var scale = mode==="major" ? scaleMaj : scaleMin;
    var rootI = idxOf(key, flats); if (rootI<0) rootI = idxOf(key, !flats);
    function deg(n){ return (n+7)%7; }
    var map = {
      "I":{d:0, q:"maj7"}, "Imaj7":{d:0,q:"maj7"}, "i":{d:0,q:"m7"}, "i7":{d:0,q:"m7"},
      "II":{d:1,q:"maj7"}, "IImaj7":{d:1,q:"maj7"}, "ii":{d:1,q:"m7"}, "ii7":{d:1,q:"m7"},
      "III":{d:2,q:"maj7"}, "IIImaj7":{d:2,q:"maj7"}, "iii":{d:2,q:"m7"}, "iii7":{d:2,q:"m7"},
      "IV":{d:3,q:"maj7"}, "IVmaj7":{d:3,q:"maj7"}, "iv":{d:3,q:"m7"}, "iv7":{d:3,q:"m7"},
      "V":{d:4,q:"7"}, "V7":{d:4,q:"7"}, "v7":{d:4,q:"m7"},
      "VI":{d:5,q:"maj7"}, "VImaj7":{d:5,q:"maj7"}, "vi":{d:5,q:"m7"}, "vi7":{d:5,q:"m7"},
      "VII":{d:6,q:"maj7"}, "VIImaj7":{d:6,q:"maj7"}, "vii":{d:6,q:"m7"}, "vii7":{d:6,q:"m7"},
      "bVII":{d:6,q:"maj7"}, "bVIImaj7":{d:6,q:"maj7"}
    };
    if(!map[roman]) return key+"maj7";
    var info = map[roman];
    var semis = scale[deg(info.d)];
    var name = A[(rootI + semis)%12];
    if (roman.indexOf("bVII")===0){
      var d6 = scale[6]; name = A[(rootI + d6 + 1 + 120)%12];
    }
    return name + info.q;
  }

  function transposeChord(sym, semis, flats){
    var arr = flats ? NOTES_FLAT : NOTES_SHARP;
    var m = sym.match(/^([A-G][b#]?)(.*)$/); if(!m) return sym;
    var root = m[1], suff = m[2] || "";
    var idx = idxOf(root, flats); if(idx < 0) idx = idxOf(root, !flats);
    idx = (idx + semis + 12) % 12;
    return arr[idx] + suff;
  }

  function chordTones(sym, flats){
    var m = sym.match(/^([A-G][b#]?)(.*)$/); if(!m) return {tones:[], intervals:[], colorMask:[]};
    var root = m[1], s = (m[2]||"");
    var A = flats ? NOTES_FLAT : NOTES_SHARP;
    var r = idxOf(root, flats); if (r<0) r = idxOf(root, !flats);
    function pitch(o){ return A[(r + o + 120)%12]; }
    var COLOR_SET = {3:1,4:1,6:1,8:1,9:1,10:1,11:1,14:1,15:1,17:1,18:1,21:1};
    var third = 4, fifth = 7, seventh = null; var adds = {};
    if (/maj7|maj9|maj11|maj13/.test(s)){ third=4; fifth=7; seventh=11; }
    if (/m7b5/.test(s)){ third=3; fifth=6; seventh=10; }
    else if (/m(?!aj)/.test(s)){ third=3; fifth=7; if(/m7/.test(s)) seventh=10; }
    if (/¬∞|dim/.test(s)){ third=3; fifth=6; seventh = (/7/.test(s)?9:null); }
    if (/(^|[^a-z])7(?![0-9])/.test(s)){ if (seventh===null) seventh=10; }
    if (/9/.test(s)){ adds[14]=1; if (seventh===null) seventh=10; }
    if (/11/.test(s)){ adds[17]=1; if (seventh===null) seventh=10; }
    if (/13/.test(s)){ adds[21]=1; if (seventh===null) seventh=10; }
    if (/sus4|sus/.test(s)){ third = 5; }
    if (/b5/.test(s)) fifth = 6;
    if (/#5|\+5|aug/.test(s)) fifth = 8;
    if (/b9/.test(s)) adds[13]=1;
    if (/#9/.test(s)) adds[15]=1;
    var tones = [0, third, fifth]; if (seventh !== null) tones.push(seventh); for(var k in adds){ if(adds.hasOwnProperty(k)) tones.push(parseInt(k,10)); }
    var uniq = []; for (var i=0;i<tones.length;i++){ if (uniq.indexOf(tones[i])<0) uniq.push(tones[i]); }
    var names = []; for(i=0;i<uniq.length;i++){ names.push(pitch(uniq[i])); }
    var colorMask = []; for(i=0;i<uniq.length;i++){ var msk = (((uniq[i]%12)+12)%12); colorMask.push(!!COLOR_SET[msk]); }
    return {tones: names, intervals: uniq, colorMask: colorMask};
  }
  function buildPentatonic(key, mode){
    var A = prefersFlats(key) ? NOTES_FLAT : NOTES_SHARP;
    var idx = idxOf(key, prefersFlats(key)); if (idx<0) idx = idxOf(key, !prefersFlats(key));
    var steps = mode==="major" ? [0,2,4,7,9] : [0,3,5,7,10];
    var out=[]; for(var i=0;i<steps.length;i++){ out.push(A[(idx+steps[i])%12]); } return out;
  }
  function isTwoFive(a,b){
    var ma = a.match(/^([A-G][b#]?)(.*)$/); var mb = b.match(/^([A-G][b#]?)(.*)$/);
    if (!ma || !mb) return false;
    var ra = ma[1], rb = mb[1], sa = ma[2]||"", sb = mb[2]||"";
    var flats = (ra.indexOf('b')>=0 || rb.indexOf('b')>=0);
    var ia = idxOf(ra, flats); if (ia<0) ia = idxOf(ra, !flats);
    var ib = idxOf(rb, flats); if (ib<0) ib = idxOf(rb, !flats);
    var up4 = (ia + 5) % 12;
    return /m7/.test(sa) && /7|9|13/.test(sb) && ib === up4;
  }

  var state = {
    lang:"en", key:"C", mode:"major", bpm:parseInt(bpm.value||"96",10), msPerBeat:60000/parseInt(bpm.value||"96",10),
    beatsPerBar: parseInt(tpmSel.value||"4",10), playing:false,
    measures: parseInt(measuresSel.value||"8",10),
    seq:[], chordSyms:[], curBar:0, curBeat:0,
    accentMode:(accentSel?accentSel.value:'classic'), voicing:(voicingSel?voicingSel.value:'close'), strings:'4', packMode:(packSel?packSel.value:'auto'),
    inspiration:"yours", desc:"Inspired by your sequence",
    loopNext:false,
    nextPreview:null,
    skipCenter:0
  };

  function updateHeader(){
    var lang = state.lang;
    var scl = state.key + (state.mode==="major" ? (lang==="fr"?" majeur":" major") : (lang==="fr"?" mineur":" minor"));
    scaleLabel.textContent = scl;
    var ptxt = (lang==="fr"?"Pentatonique : ":"Pentatonic: ") + buildPentatonic(state.key, state.mode).join(" ");
    pentaLabel.textContent = ptxt;
    descText.textContent = state.desc;
    document.documentElement.lang = (state.lang==="fr"?"fr":"en");
  }

  function centerPortrait_REMOVED() {
    try{
      if (!(window.matchMedia && window.matchMedia('(orientation: portrait)').matches)) return;
      if (state.skipCenter>0){ state.skipCenter--; return; }
      var anchor = document.getElementById('centerAnchor');
      if (!anchor || !anchor.scrollIntoView) return;
      // Keep the main content vertically centered without jitter
      anchor.scrollIntoView({block:'center', inline:'nearest'});
    }catch(e){}
  }


  function toDiatonicRomanSeq(len, mode){
    var M = ["Imaj7","ii7","iii7","IVmaj7","V7","vi7"];
    var m = ["i7","ii7","IIImaj7","iv7","v7","VImaj7"];
    var pool = (mode==="minor")?m:M;
    var out=[];
    var templates = (mode==="minor")
      ? [["ii7","v7","i7","i7"], ["i7","iv7","v7","i7"], ["i7","VImaj7","IIImaj7","v7"], ["ii7","v7","i7","VImaj7"], ["i7","iv7","i7","v7"]]
      : [["ii7","V7","Imaj7","vi7"], ["Imaj7","vi7","ii7","V7"], ["Imaj7","IVmaj7","ii7","V7"], ["iii7","vi7","ii7","V7"], ["Imaj7","ii7","V7","Imaj7"]];
    while(out.length < len){
      var t = templates[Math.floor(Math.random()*templates.length)].slice();
      for (var i=0;i<t.length && out.length<len;i++){ out.push(t[i]); }
    }
    return out;
  }

  function toDiatonic(insp, key, mode){
    if (insp && insp.diatonic===false) return insp.base.slice();
    if (insp && insp.gen){
      var romans = toDiatonicRomanSeq(8, mode);
      var outSyms = [];
      for (var i=0;i<romans.length;i++){ outSyms.push(romanToChord(romans[i], key, mode)); }
      return outSyms;
    }
    if (insp && insp.base && insp.base.length){
      var out=[]; for(var i=0;i<insp.base.length;i++){ out.push(romanToChord(insp.base[i], key, mode)); }
      return out;
    }
    return toDiatonicRomanSeq(8, mode);
  }


  function buildSequence(base){

    var flats = prefersFlats(state.key);
    var tIdx = (idxOf(state.key, flats)<0? idxOf(state.key, !flats):idxOf(state.key, flats));
    var semis = (tIdx - idxOf("C", false) + 12) % 12;
    var tbase=[]; for(var i=0;i<base.length;i++){ tbase.push(transposeChord(base[i], semis, flats)); }
    var bars = []; var j = 0;
    function nextChord(k){ return tbase[k % tbase.length]; }
    while (bars.length < state.measures){
      var a = nextChord(j), b = nextChord(j+1);
      if (state.packMode==='always'){
        bars.push({chords:[a,b], split:true}); j+=2;
      } else if (state.packMode==='never'){
        bars.push({chords:[a], split:false}); j+=1;
      } else {
        if (isTwoFive(a,b) && (bars.length+1) <= state.measures){ bars.push({chords:[a,b], split:true}); j+=2; }
        else { bars.push({chords:[a], split:false}); j+=1; }
      }
    }
    var chordSyms = []; for(i=0;i<bars.length;i++){ for(var p=0;p<bars[i].chords.length;p++){ chordSyms.push(bars[i].chords[p]); } }
    return {bars:bars, chordSyms:chordSyms};
  }

  function buildBarsOnly(base){
    // mirror buildSequence but without touching state
    var flats = prefersFlats(state.key);
    var tIdx = (idxOf(state.key, flats)<0? idxOf(state.key, !flats):idxOf(state.key, flats));
    var semis = (tIdx - idxOf("C", false) + 12) % 12;
    var tbase=[]; for(var i=0;i<base.length;i++){ tbase.push(transposeChord(base[i], semis, flats)); }
    var bars = []; var j = 0;
    function nextChord(k){ return tbase[k % tbase.length]; }
    while (bars.length < state.measures){
      var a = nextChord(j), b = nextChord(j+1);
      if (state.packMode==='always'){
        bars.push({chords:[a,b], split:true}); j+=2;
      } else if (state.packMode==='never'){
        bars.push({chords:[a], split:false}); j+=1;
      } else {
        if (isTwoFive(a,b) && (bars.length+1) <= state.measures){ bars.push({chords:[a,b], split:true}); j+=2; }
        else { bars.push({chords:[a], split:false}); j+=1; }
      }
    }
    var chordSyms = []; for(var i=0;i<bars.length;i++){ for(var p=0;p<bars[i].chords.length;p++){ chordSyms.push(bars[i].chords[p]); } }
    return {bars:bars, chordSyms:chordSyms};
  }

  function makeProgressionCandidate(){
    if (state.inspiration === "generate"){
      var romans = toDiatonicRomanSeq(8, state.mode);
      var outSyms = []; for (var i=0;i<romans.length;i++){ outSyms.push(romanToChord(romans[i], state.key, state.mode)); }
      return { base: outSyms, desc: INSP.generate.desc };
    } else {
      var item = PROG_DB[Math.floor(Math.random()*PROG_DB.length)];
      return { base: toDiatonic(item, state.key, state.mode), desc: item.desc };
    }
  }

  function computeNextPreview(){
    var cand = makeProgressionCandidate();
    var built = buildBarsOnly(cand.base);
    state.nextPreview = { bars: built.bars, chordSyms: built.chordSyms, desc: cand.desc };
  }

  function applyNextPreview(){
    if (!state.nextPreview){ computeNextPreview(); }
    if (!state.nextPreview) return;
    state.seq = state.nextPreview.bars;
    state.chordSyms = state.nextPreview.chordSyms;
    state.desc = state.nextPreview.desc || state.desc;
    state.curBar = 0; state.curBeat = 0;
    renderMain(); renderTicker();
    computeNextPreview();
  }

  function renderFretboardForChord(sym){
    var flats = prefersFlats(state.key);
    var ctones = chordTones(sym, flats);
    var m = sym.match(/^([A-G][b#]?)/); var root = m ? m[1] : "C";
    var tones = ctones.tones;
    var stringsIdx = (state.strings==='5') ? ["G","D","A","E","B"] : ["G","D","A","E"];
    var stringsInt = []; for(var i=0;i<stringsIdx.length;i++){ stringsInt.push(noteIndexAny(stringsIdx[i])); }
    var frets = 25;
    var W = 1000, H = (window.matchMedia && window.matchMedia('(orientation: landscape)').matches) ? 160 : 190;
    var top = 10, bottom = H-10, left = 30, right = W-14;
    var stringGap = (bottom - top) / (stringsInt.length - 1);
    var fretGap = (right - left) / frets;
    var rootIdx = noteIndexAny(root);
    var noteSet = {}; for(i=0;i<tones.length;i++){ noteSet[noteIndexAny(tones[i])] = true; }

    var svg = [];
    svg.push('<rect x="0" y="0" width="'+W+'" height="'+H+'" fill="var(--tile)" rx="12"/>');
    svg.push('<rect x="'+(left-5)+'" y="'+(top-8)+'" width="5" height="'+(bottom-top+16)+'" fill="var(--string)"/>');
    for (var f=1; f<=frets-1; f++){
      var x = left + f * fretGap;
      svg.push('<line x1="'+x+'" y1="'+(top-8)+'" x2="'+x+'" y2="'+(bottom+8)+'" stroke="var(--fretline)" stroke-width="'+((f%12===0)?2:1)+'"/>');
      var mod = f % 12;
      if (mod===3||mod===5||mod===7||mod===9){ svg.push('<circle cx="'+(x - fretGap/2)+'" cy="'+(H/2)+'" r="4.2" fill="var(--fretdot)"/>'); }
      if (f%12===0){ svg.push('<circle cx="'+(x - fretGap/2)+'" cy="'+(H/2 - 10)+'" r="4.2" fill="var(--fretdot)"/><circle cx="'+(x - fretGap/2)+'" cy="'+(H/2 + 10)+'" r="var(--fretdot)"/>'); }
    }
    for (var s=0; s<stringsInt.length; s++){
      var y = top + s*stringGap;
      var strCol = getComputedStyle(document.documentElement).getPropertyValue('--string').trim();
      svg.push('<line x1="'+left+'" y1="'+y+'" x2="'+right+'" y2="'+y+'" stroke="'+strCol+'" stroke-width="'+(2.6 - s*0.2)+'"/>');
      svg.push('<text x="6" y="'+(y+3)+'" font-size="11" fill="#9aa4b2" font-weight="700">'+stringsIdx[s]+'</text>');
    }
    for (s=0; s<stringsInt.length; s++){
      for (f=0; f<=frets-1; f++){
        var noteIdx = (stringsInt[s] + f) % 12;
        if (noteSet[noteIdx]){
          var x2 = left + f*fretGap - fretGap/2;
          var y2 = top + s*stringGap;
          var isRoot = (noteIdx === rootIdx);
          var delta = ((noteIdx - rootIdx + 12) % 12);
          var isColor = (delta===3||delta===4||delta===6||delta===8||delta===9||delta===10||delta===11||delta===1||delta===2||delta===5);
          var isKeyColor = (delta===3 || delta===4 || delta===10 || delta===11);
          var r = isRoot ? 8.5 : 6.4;
          var fill = isRoot ? "var(--good)" : "var(--accent)";
          var stroke = isColor ? (isKeyColor ? "gold" : "white") : "rgba(0,0,0,.35)";
          var sw = isColor ? (isKeyColor ? 3 : 2) : 2;
          svg.push('<circle cx="'+x2+'" cy="'+y2+'" r="'+r+'" fill="'+fill+'" stroke="'+stroke+'" stroke-width="'+sw+'"/>');
        }
      }
    }
    fretboard.setAttribute('viewBox', '0 0 '+W+' '+H);
    fretboard.innerHTML = svg.join("");
  }

  function getCurrentChordSym(){
    var m = state.seq[state.curBar];
    if (!m) return state.chordSyms[0] || "Cmaj7";
    if (!m.split) return m.chords[0];
    if (state.beatsPerBar===4){
      return (state.curBeat < 2) ? m.chords[0] : m.chords[1];
    } else { // 3/4
      return (state.curBeat < 1) ? m.chords[0] : m.chords[1];
    }
  }

  function renderTicker(){
    ticker.innerHTML = "";
    var list = state.seq.slice();
    var isPortrait = (window.matchMedia && window.matchMedia('(orientation: portrait)').matches);
    var ghostCount = isPortrait ? 2 : 2;
    var useNext = (state.loopNext && state.nextPreview && state.nextPreview.bars && state.nextPreview.bars.length);
    var ghostSource = useNext ? state.nextPreview.bars : state.seq;
    for (var g=0; g<ghostCount; g++){
      var srcBar = ghostSource[g % ghostSource.length];
      var item = {chords: srcBar.chords, split: srcBar.split};
      if (!(state.loopNext && !isPortrait)) item.ghost = true; // In landscape+infinite: show as normal (not greyed)
      list.push(item);
    }
    for (var bi=0; bi<list.length; bi++){
      var m = list[bi];
      var wrap = document.createElement('div'); wrap.className='measure'+(bi===state.curBar?' active':'');
      if (m.ghost) wrap.classList.add('ghost');
      var num = document.createElement('div'); num.className='num'; num.textContent='M'+(((bi%state.seq.length)+1)); wrap.appendChild(num);
      var grid = document.createElement('div'); grid.className = m.split ? 'halfgrid' : 'mgrid';
      for (var k=0;k<m.chords.length;k++){
        var sym = m.chords[k];
        var d = document.createElement('div'); d.className='tile';
        if (!m.ghost && bi===state.curBar){
          if (!m.split){
            d.classList.add('active');
          } else {
            if (state.beatsPerBar===4){
              if ((state.curBeat<2 && k===0) || (state.curBeat>=2 && k===1)) d.classList.add('active','split2');
            } else {
              if ((state.curBeat<1 && k===0) || (state.curBeat>=1 && k===1)) d.classList.add('active','split2');
            }
          }
        }
        d.textContent = sym; d.setAttribute('data-bar', bi%state.seq.length); d.setAttribute('data-pos', k);
        grid.appendChild(d);
      }
      wrap.appendChild(grid); ticker.appendChild(wrap);
    }
    if (window.matchMedia && window.matchMedia('(orientation: landscape)').matches){
      var active = ticker.querySelector('.measure.active');
      if (active){
        if (state.skipCenter>0){ state.skipCenter--; }
        else {
          var desired = Math.max(0, Math.min(active.offsetLeft + active.offsetWidth/2 - ticker.clientWidth/2, ticker.scrollWidth - ticker.clientWidth));
          var diff = desired - ticker.scrollLeft;
          if (Math.abs(diff) > 60){
            ticker.scrollTo({left: desired, behavior:'smooth'});
          } else if (Math.abs(diff) > 8){
            ticker.scrollLeft = desired;
          }
        }
      }
    }
  }

  function renderMain(){
    var sym = getCurrentChordSym();
    bigChord.textContent = sym;
    var flats = prefersFlats(state.key);
    var tones = chordTones(sym, flats).tones;
    chordNotes.textContent = tones.join(" ");
    renderFretboardForChord(sym);
    updateHeader();
    
  }

  function buildFrom(base, desc){
    var built = buildSequence(base);
    state.seq = built.bars; state.chordSyms = built.chordSyms;
    state.curBar = 0; state.curBeat = 0; state.desc = desc || state.desc;
    renderMain(); renderTicker();
    if (state.loopNext){ computeNextPreview(); }
  }

  // AUDIO
  var audioCtx = null, timer=null;
  function ensureAudio(){ try{ if (!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } if (audioCtx && audioCtx.state === "suspended") audioCtx.resume(); }catch(e){ } }
  function woodClick(accent){
    if (!metroOn || !metroOn.checked) return;
    ensureAudio(); if (!audioCtx) return;
    var t = audioCtx.currentTime + 0.005;
    var noise = audioCtx.createBufferSource();
    var buffer = audioCtx.createBuffer(1, 4410, audioCtx.sampleRate);
    var data = buffer.getChannelData(0);
    for(var i2=0;i2<data.length;i2++){ data[i2] = (Math.random()*2-1) * Math.pow(1 - i2/data.length, 3); }
    noise.buffer = buffer;
    var band = audioCtx.createBiquadFilter(); band.type = "bandpass"; band.frequency.value = accent ? 2200 : 1500; band.Q.value = 6;
    var osc = audioCtx.createOscillator(); osc.type = "triangle"; osc.frequency.setValueAtTime(accent ? 2000 : 1300, t);
    var gain = audioCtx.createGain();
    var vol = Math.max(0, Math.min(1, parseInt(metroVol ? metroVol.value : "92",10)/100));
    gain.gain.setValueAtTime(0.0001, t);
    try{ gain.gain.exponentialRampToValueAtTime(vol * (accent ? 1.0 : 0.75), t + 0.006); }catch(e){ gain.gain.linearRampToValueAtTime(vol * (accent ? 1.0 : 0.75), t + 0.006); }
    try{ gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.09); }catch(e){ gain.gain.linearRampToValueAtTime(0.0001, t + 0.09); }
    noise.connect(band); band.connect(gain); osc.connect(gain); gain.connect(audioCtx.destination);
    noise.start(t); noise.stop(t + 0.09); osc.start(t); osc.stop(t + 0.08);
  }
  function isAccent(beat){ return (state.accentMode==='jazz' && state.beatsPerBar===4) ? (beat===1 || beat===3) : (beat===0); }
  function pulseBlink(){
    if(pulseDot){ pulseDot.classList.add('on'); setTimeout(function(){ pulseDot.classList.remove('on'); }, 110); }
    if(beatLed){ beatLed.classList.add('on'); setTimeout(function(){ beatLed.classList.remove('on'); }, 110); }
  }

  function tickBeat(){
    var accent = isAccent(state.curBeat);
    pulseBlink(); woodClick(accent);
    state.curBeat++;
    if (state.curBeat >= state.beatsPerBar){
      state.curBeat = 0;
      var willWrap = ((state.curBar + 1) % state.seq.length) === 0;
      if (willWrap && state.loopNext){
        var prevScroll = ticker.scrollLeft;
        applyNextPreview();
        if (window.matchMedia && window.matchMedia('(orientation: landscape)').matches){
          ticker.scrollLeft = prevScroll; // keep timeline position
          state.skipCenter = 2; // skip auto centering for a couple of beats
        }
      } else {
        state.curBar = (state.curBar + 1) % state.seq.length;
      }
    }
    renderMain();
    renderTicker();
  }
  function start(){
    if (state.playing) return;
    state.playing = true; playBtn.textContent = "‚è∏Ô∏é";
    ensureAudio();
    tickBeat();
    timer = setInterval(tickBeat, state.msPerBeat);
  }
  function stop(){
    if (!state.playing) return;
    state.playing = false; playBtn.textContent = "‚ñ∂Ô∏é";
    if(timer){ clearInterval(timer); timer=null; }
  }

  // Click to select chord/bar
  ticker.addEventListener('click', function(ev){
    var t = ev.target;
    if (!t || !t.classList.contains('tile')) return;
    var bar = parseInt(t.getAttribute('data-bar'),10);
    var pos = parseInt(t.getAttribute('data-pos'),10);
    if (isNaN(bar) || isNaN(pos)) return;
    state.curBar = Math.max(0, Math.min(bar, state.seq.length-1));
    var m = state.seq[state.curBar];
    if (m && m.split && pos===1){
      state.curBeat = (state.beatsPerBar===4)?2:1;
    } else {
      state.curBeat = 0;
    }
    renderMain(); renderTicker();
  });

  // ==== Random / Library & Generate ====
  function pickLibrary(){
    var item = PROG_DB[Math.floor(Math.random()*PROG_DB.length)];
    state.desc = item.desc;
    var seq = toDiatonic(item, state.key, state.mode);
    buildFrom(seq, item.desc);
  }
  function pickGenerate(){
    var seq = toDiatonic(INSP.generate, state.key, state.mode);
    state.desc = INSP.generate.desc;
    buildFrom(seq, state.desc);
  }

  // UI events
  bpm.addEventListener('input', function(e){ state.bpm=parseInt(e.target.value,10)||96; bpmVal.textContent=state.bpm; state.msPerBeat=60000/state.bpm; if(state.playing){ if(timer){ clearInterval(timer); timer=null; } start(); } });
  tpmSel.addEventListener('change', function(e){ state.beatsPerBar=parseInt(e.target.value,10)||4; if(state.playing){ stop(); start(); } else { renderTicker(); } });
  measuresSel.addEventListener('change', function(e){ state.measures=parseInt(e.target.value,10)||8; var insp = INSP[state.inspiration]; var seq = toDiatonic(insp, state.key, state.mode); buildFrom(seq, insp.desc); });
  styleSel.addEventListener('change', function(e){ rootEl.setAttribute('data-theme', e.target.value); });
  voicingSel.addEventListener('change', function(e){ state.voicing=e.target.value; renderMain(); });
  stringsSel.addEventListener('change', function(e){ state.strings=e.target.value; renderMain(); });
  packSel.addEventListener('change', function(e){ state.packMode=e.target.value; var insp = INSP[state.inspiration]; var seq = toDiatonic(insp, state.key, state.mode); buildFrom(seq, insp.desc); });
  accentSel.addEventListener('change', function(e){ state.accentMode=e.target.value; });
  langSel.addEventListener('change', function(e){ state.lang=e.target.value; updateHeader(); });

  playBtn.addEventListener('click', function(){ state.playing ? stop() : start(); });
  window.addEventListener('orientationchange', function(){ setTimeout(function(){ renderMain(); renderTicker();  }, 350); });
  if (infBtn){ infBtn.addEventListener('click', function(){
      var prevScroll = ticker.scrollLeft;
      state.loopNext = !state.loopNext;
      infBtn.classList.toggle('toggled', state.loopNext);
      if (state.loopNext){ computeNextPreview(); }
      else { state.nextPreview = null; }
      renderTicker();
      // keep visual position stable in landscape
      try{ if (window.matchMedia && window.matchMedia('(orientation: landscape)').matches){ ticker.scrollLeft = prevScroll; } }catch(e){}
    }); }
  randomBtn.addEventListener('click', function(){
    if (state.playing) { stop(); }
    // 75% library, 25% generated
    if (Math.random() < 0.75){ pickLibrary(); }
    else { pickGenerate(); }
  });
  optsBtn.addEventListener('click', function(){ if(optsPanel&&optsOverlay){ optsPanel.hidden = false; optsOverlay.style.display='block'; } });
  closeOpts.addEventListener('click', function(){ if(optsPanel&&optsOverlay){ optsPanel.hidden = true; optsOverlay.style.display='none'; } });
  optsOverlay.addEventListener('click', function(){ if(optsPanel&&optsOverlay){ optsPanel.hidden = true; optsOverlay.style.display='none'; } });
  keySel.addEventListener('change', function(e){ state.key=e.target.value; pickLibrary(); });
  modeSel.addEventListener('change', function(e){ state.mode=e.target.value; pickLibrary(); });
  inspSel.addEventListener('change', function(e){
    state.inspiration=e.target.value;
    if (state.inspiration==="generate"){ pickGenerate(); }
    else {
      var insp = INSP[state.inspiration]; var seq = toDiatonic(insp, state.key, state.mode); buildFrom(seq, insp.desc);
    }
  });

  document.addEventListener('touchstart', function(){ try{ if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); }catch(e){} }, {passive:true});

  // INIT selects
  for(var i=0;i<UNIQUE_KEYS.length;i++){ var o=document.createElement('option'); o.value=UNIQUE_KEYS[i]; o.textContent=UNIQUE_KEYS[i]; keySel.appendChild(o); }
  keySel.value = state.key; modeSel.value = state.mode; bpmVal.textContent = state.bpm; try{ styleSel.value = (document.documentElement.getAttribute('data-theme')||'dark'); }catch(e){}
  accentSel.value = state.accentMode; packSel.value = state.packMode; tpmSel.value=String(state.beatsPerBar); measuresSel.value=String(state.measures);

  // Boot with user's preferred opening (your sequence)
  var insp0 = INSP["yours"]; state.inspiration="yours"; inspSel.value="yours";
  var seq0 = (insp0.diatonic===false) ? insp0.base.slice() : toDiatonic(insp0, state.key, state.mode);
  buildFrom(seq0, insp0.desc);
  if (state.loopNext){ computeNextPreview(); }
})();
</script>

<!-- mp_safe_fab + shim (v4.2) -->
<style>
  .mp-fab{position:fixed;bottom:14px;right:14px;z-index:99999;
    background:#171e29;color:#e8ecf1;border:1px solid #101620;
    border-radius:12px;padding:8px 12px;font-weight:800;
    text-decoration:none;box-shadow:0 6px 16px rgba(0,0,0,.35); margin-left:8px}
  .mp-fab:hover{filter:brightness(1.1)}
  .mp-fab-wrap{position:fixed;bottom:14px;right:14px;display:flex;gap:8px;z-index:99998}
</style>
<div class="mp-fab-wrap">
  <a class="mp-fab" href="./library.html" title="Biblioth√®que">üéµ Biblioth√®que</a>
  <a class="mp-fab" href="./metronome.html" title="M√©tronome">‚è±Ô∏è M√©tronome</a>
</div>
<script>(function(){
  try{
    var params = new URLSearchParams(location.search);
    var id = params.get('grid');
    if(!id && location.hash){
      var m = location.hash.match(/grid=([^&]+)/);
      if(m) id = decodeURIComponent(m[1]);
    }
    if(id){
      var s = {}; try{s=JSON.parse(localStorage.getItem('mp_settings_v3')||'{}');}catch(e){}
      s.lastGridId = id;
      localStorage.setItem('mp_settings_v3', JSON.stringify(s));
      document.cookie = 'mp_settings_v3='+encodeURIComponent(JSON.stringify(s))+';path=/;SameSite=Lax;max-age='+(3600*24*365);
    }
  }catch(e){}
})();</script>

<script src="js/grid/parse.js"></script>
<script src="js/grid/render.js"></script>
<script src="js/api/library-client.js"></script>

<script>
async function loadGridFromHash() {
  const params = new URLSearchParams(location.hash.slice(1));
  const id = params.get('grid') || params.get('id');
  if (!id) return;
  try {
    if (window.LibraryClient && LibraryClient.getOne) {
      const item = await LibraryClient.getOne(id);
      if (item && item.grid) {
        const ast = window.GridParse.parse(item.grid);
        const html = window.GridRender.renderHTML(ast);
        const target = document.getElementById('grid-view');
        if (target) target.innerHTML = html;
      }
    }
  } catch (e) {
    console.error('Grid load error', e);
  }
}
window.addEventListener('hashchange', loadGridFromHash);
window.addEventListener('DOMContentLoaded', loadGridFromHash);
</script>

</body>
</html>
