<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Bass-Routine ‚Äî Lecteur</title>
<style>
  :root{
    --bg:#0f1115; --panel:#151922; --ink:#e8ecf1; --muted:#9aa4b2; --accent:#6ee7ff; --good:#72f1b8;
    --tile:#0f1320; --string:#b8996d; --border:#101620; --tile-border:#101620;
    --ticker-h: 102px; --header-h: 62px; --safe-bottom: calc(env(safe-area-inset-bottom) + 16px);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;z-index:20;background:var(--panel);border-bottom:1px solid var(--border);padding:6px 10px}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
  .left{display:flex;align-items:center;gap:8px;min-width:0;flex-wrap:wrap}
  .chips{display:flex;gap:6px;align-items:center;min-width:0;flex-wrap:wrap}
  .chip{background:#171e29;border:1px solid var(--border);border-radius:12px;padding:6px 8px;font-weight:700;font-size:12px;white-space:nowrap;max-width:40ch;overflow:hidden;text-overflow:ellipsis}
  .btn{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,#171e29,#141a24);color:var(--ink);padding:8px 10px;border-radius:10px;font-weight:800;cursor:pointer;-webkit-tap-highlight-color: transparent;font-size:14px}
  .iconbtn{padding:8px 10px; min-width:0}
  #playBtn{font-size:22px;padding:12px 16px;border-width:2px}
  .toggled{outline:2px solid var(--good); box-shadow:0 0 0 2px rgba(114,241,184,.45) inset;}
  select,input[type=range],input[type=checkbox]{accent-color:var(--good);background:transparent;color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:6px 8px;font-weight:600}
  #err{display:none;position:fixed;top:62px;left:0;right:0;z-index:50;background:#3b0d0d;color:#ffe1e1;padding:8px 12px;font-weight:700}
  #pulseWrap{display:flex;align-items:center;gap:8px;justify-content:center;margin:6px 0 2px}
  #pulseDot{width:14px;height:14px;border-radius:50%;background:#444}
  #pulseDot.on{background:var(--good);box-shadow:0 0 10px var(--good)}
  main{min-height: calc(100svh - var(--header-h) - var(--ticker-h) - var(--safe-bottom));display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:6px 10px calc(var(--ticker-h) + var(--safe-bottom) + 2px);text-align:center}
  .big-row{display:flex;align-items:center;gap:10px;justify-content:center;margin-top:2px}
  .big-chord{font-weight:900;letter-spacing:.5px;margin:0 0 2px}
  .notes{color:var(--muted);margin:0 0 4px}
  .fretboard-wrap{width:100%;max-width:980px;margin:4px auto;background:var(--tile);border:1px solid var(--border);border-radius:12px;padding:6px}
  .ticker-wrap{position:fixed;bottom:0;left:0;right:0;z-index:30;background:var(--panel);border-top:1px solid var(--border);padding:6px 0 var(--safe-bottom)}
  .ticker{width:100%;max-width:980px;margin:0 auto;display:flex;gap:8px;overflow-x:auto;overflow-y:hidden;white-space:nowrap;padding:6px 8px}
  .measure{flex:0 0 auto;min-width:128px;background:var(--tile);border:1px solid var(--tile-border);border-radius:10px;padding:6px;position:relative}
  .measure.active{box-shadow:0 0 0 2px rgba(114,241,184,.4) inset}
  .mgrid{display:grid;grid-template-columns: 1fr;gap:6px}
  .halfgrid{display:grid;grid-template-columns: 1fr 1fr;gap:6px}
  .tile{min-height:36px;text-align:center;padding:8px;border-radius:8px;background:var(--tile);border:1px solid var(--tile-border);font-weight:900;font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative}
  .tile.active{border-color:var(--good); box-shadow:0 0 0 2px rgba(114,241,184,.85) inset, 0 0 0 2px rgba(114,241,184,.25)}
  .tile.brL::before{content:'ùÑÜ'; position:absolute; left:-14px; top:50%; transform:translateY(-50%); font-size:18px; opacity:.9}
  .tile.brR::after{content:'ùÑá'; position:absolute; right:-14px; top:50%; transform:translateY(-50%); font-size:18px; opacity:.9}
  .marker{flex:0 0 auto;display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px;color:var(--muted);background:#171e29;margin:0 6px}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="left">
      <div class="chips">
        <div class="chip" id="gridTitleChip">‚Äî</div>
        <div class="chip" id="scaleLabel">C major</div>
        <div class="chip" id="pentaLabel">Pentatonic: C D E G A</div>
      </div>
    </div>
    <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
      <label class="chip" style="display:inline-flex;gap:8px;align-items:center">
        <input type="checkbox" id="metroToggle"> M√©tronome
        <select id="metroMode" style="margin-left:6px">
          <option value="classic">classic</option>
          <option value="jazz">jazz</option>
        </select>
      </label>
      <label class="chip" style="display:inline-flex;gap:8px;align-items:center">
        BPM <input id="bpm" type="range" min="40" max="220" value="96" style="width:140px">
        <span id="bpmVal">96</span>
      </label>
      <button class="btn iconbtn" id="randomBtn" title="Grille al√©atoire (biblioth√®que)">üé≤</button>
      <button class="btn iconbtn" id="playBtn" title="Play/Pause">‚ñ∂Ô∏é</button>
      <a class="btn iconbtn" href="./library.html" title="Biblioth√®que">üéµ</a>
      <a class="btn iconbtn" href="./editor.html?id=temp" title="√âditeur">‚úé</a>
      <button class="btn iconbtn" id="optsBtn" title="Options">‚öôÔ∏è</button>
    </div>
  </div>
</header>

<div id="err"></div>

<main>
  <div class="big-row">
    <div id="pulseWrap"><div id="pulseDot"></div></div>
    <div class="big-chord" id="bigChord">Cmaj7</div>
  </div>
  <div class="notes" id="chordNotes">C E G B</div>
  <div class="fretboard-wrap">
    <svg id="fretboard" viewBox="0 0 1000 200" preserveAspectRatio="xMidYMid meet" style="width:100%;height:auto;display:block"></svg>
  </div>
</main>

<div class="ticker-wrap">
  <div class="ticker" id="ticker" aria-label="Grille (mesures)"></div>
</div>

<dialog id="optsPanel">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
    <strong>Options</strong>
    <button class="btn iconbtn" id="closeOpts">‚úï</button>
  </div>
  <div style="display:grid;gap:10px;grid-template-columns: repeat(3, minmax(0,1fr))">
    <div><div style="font-size:12px;color:#9aa4b2">Langue</div><select id="langSel"><option value="fr" selected>Fran√ßais</option><option value="en">English</option></select></div>
    <div><div style="font-size:12px;color:#9aa4b2">Th√®me</div><select id="styleSel"><option value="dark" selected>Dark</option><option value="light">Light</option><option value="jazz">Jazz</option></select></div>
    <div><div style="font-size:12px;color:#9aa4b2">Cordes</div><select id="stringsSel"><option value="4" selected>Basse 4 cordes</option><option value="5">Basse 5 cordes</option></select></div>
  </div>
</dialog>

<script>
(function(){
  function showErr(msg){ var e=document.getElementById('err'); if(!e) return; e.style.display='block'; e.textContent='Error: '+msg; }
  window.addEventListener('error', function(ev){ showErr(ev.message); });
  window.addEventListener('unhandledrejection', function(ev){ try{ showErr((ev.reason && (ev.reason.message||ev.reason)) || 'Promise rejected'); }catch(e){ showErr('Promise rejected'); } });

  function el(id){ return document.getElementById(id); }
  var rootEl=document.documentElement;
  var langSel=el('langSel'), styleSel=el('styleSel'), stringsSel=el('stringsSel');
  var playBtn=el('playBtn'), randomBtn=el('randomBtn'), optsBtn=el('optsBtn'), closeOpts=el('closeOpts');
  var bigChord=el('bigChord'), chordNotes=el('chordNotes'), ticker=el('ticker'), fretboard=el('fretboard');
  var pulseDot=el('pulseDot'), scaleLabel=el('scaleLabel'), pentaLabel=el('pentaLabel'), gridTitleChip=el('gridTitleChip');
  var metroToggle=el('metroToggle'), metroMode=el('metroMode'), bpm=el('bpm'), bpmVal=el('bpmVal');

  // ‚Äî‚Äî‚Äî Notes helpers (support unicode ‚ô≠/‚ôØ) ‚Äî‚Äî‚Äî
  var NOTES_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  var NOTES_FLAT  = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];
  function prefersFlats(key){ return ["F","Bb","Eb","Ab","Db","Gb"].indexOf(key)>=0 || /b/.test(key); }
  function normAcc(s){ return s.replace(/\u266D/g,'b').replace(/\u266F/g,'#'); } // ‚ô≠ -> b, ‚ôØ -> #
  function splitRoot(sym){
    var m = String(sym||'').match(/^([A-G](?:[b#\u266D\u266F])?)(.*)$/);
    if(!m) return {root:"C", suff:""};
    return { root: normAcc(m[1]), suff: m[2]||"" };
  }
  function idxOf(note, flats){ var arr = flats ? NOTES_FLAT : NOTES_SHARP; return arr.indexOf(note); }
  function noteIndexAny(n){ var i = NOTES_SHARP.indexOf(n); if (i<0) i = NOTES_FLAT.indexOf(n); return i; }

  // ‚Äî‚Äî‚Äî State & persistence ‚Äî‚Äî‚Äî
  var state = {
    lang:"fr",
    key:"C", mode:"major",
    bpm:96, msPerBeat:60000/96, beatsPerBar:4,
    playing:false,
    seq:[], chordSyms:[], curBar:0, curBeat:0,
    sections:[], repeats:{L:[],R:[]}, repeatSegments:[],
    strings:'4', title:'‚Äî'
  };
  function readSettings(){
    try{ return JSON.parse(localStorage.getItem('mp_ui')||'{}'); }catch(_){ return {}; }
  }
  function writeSettings(patch){
    const cur = readSettings();
    const nxt = Object.assign({}, cur, patch||{});
    try{ localStorage.setItem('mp_ui', JSON.stringify(nxt)); }catch(_){}
  }
  function applySettings(){
    const s = readSettings();
    if ('metroOn' in s) metroToggle.checked = !!s.metroOn;
    if (s.metroMode) metroMode.value = s.metroMode;
    if (s.bpm){ bpm.value = s.bpm; bpmVal.textContent = s.bpm; state.bpm = parseInt(s.bpm,10)||96; state.msPerBeat = 60000/state.bpm; }
    if (s.theme) rootEl.setAttribute('data-theme', s.theme);
    if (s.lang){ state.lang=s.lang; langSel.value=s.lang; }
    if (s.strings){ state.strings=s.strings; stringsSel.value=s.strings; }
  }

  // ‚Äî‚Äî‚Äî Header info ‚Äî‚Äî‚Äî
  function buildPentatonic(key, mode){
    var A = prefersFlats(key) ? NOTES_FLAT : NOTES_SHARP;
    var idx = idxOf(key, prefersFlats(key)); if (idx<0) idx = idxOf(key, !prefersFlats(key));
    var steps = mode==="major" ? [0,2,4,7,9] : [0,3,5,7,10];
    var out=[]; for(var i=0;i<steps.length;i++){ out.push(A[(idx+steps[i])%12]); } return out;
  }
  function renderHeader(){
    gridTitleChip.textContent = state.title || '‚Äî';
    var scl = state.key + (state.mode==="major" ? ' major':' minor');
    if (state.lang==='fr') scl = state.key + (state.mode==="major" ? ' majeur':' mineur');
    scaleLabel.textContent = scl;
    pentaLabel.textContent = (state.lang==='fr'?'Pentatonique : ':'Pentatonic: ') + buildPentatonic(state.key, state.mode).join(' ');
  }

  // ‚Äî‚Äî‚Äî Fretboard & chord tones ‚Äî‚Äî‚Äî
  function chordTones(sym, flats){
    var sp = splitRoot(sym); var root = sp.root, s = sp.suff||"";
    var A = flats ? NOTES_FLAT : NOTES_SHARP;
    var r = idxOf(root, flats); if (r<0) r = idxOf(root, !flats);
    function pitch(o){ return A[(r + o + 120)%12]; }
    var third = /m(?!aj)/.test(s) || /¬∞|dim/.test(s) ? 3 : 4;
    var fifth = /b5/.test(s) ? 6 : /#5|\+5|aug/.test(s) ? 8 : 7;
    var seventh = /maj7/.test(s) ? 11 : (/7/.test(s) ? 10 : null);
    var adds = []; if(/b9/.test(s)) adds.push(13); if(/#9/.test(s)) adds.push(15);
    if(/9(?![0-9])/.test(s)) adds.push(14); if(/11/.test(s)) adds.push(17); if(/13/.test(s)) adds.push(21);
    if (/sus4|sus/.test(s)) third = 5;
    var base=[0,third,fifth]; if(seventh!==null) base.push(seventh); base=base.concat(adds);
    var uniq=[]; base.forEach(n=>{ if(uniq.indexOf(n)<0) uniq.push(n); });
    return {tones: uniq.map(pitch)};
  }
  function renderFretboardForChord(sym){
    var flats = prefersFlats(state.key);
    var ctones = chordTones(sym, flats);
    var root = splitRoot(sym).root;
    var tones = ctones.tones;
    var stringsIdx = (state.strings==='5') ? ["G","D","A","E","B"] : ["G","D","A","E"];
    var stringsInt = []; for(var i=0;i<stringsIdx.length;i++){ stringsInt.push(noteIndexAny(stringsIdx[i])); }
    var frets = 25, W = 1000, H = (window.matchMedia && window.matchMedia('(orientation: landscape)').matches) ? 160 : 190;
    var top = 10, bottom = H-10, left = 30, right = W-14;
    var stringGap = (bottom - top) / (stringsInt.length - 1);
    var fretGap = (right - left) / frets;
    var rootIdx = noteIndexAny(root);
    var noteSet = {}; for(var i=0;i<tones.length;i++){ noteSet[noteIndexAny(tones[i])] = true; }

    var svg = [];
    svg.push('<rect x="0" y="0" width="'+W+'" height="'+H+'" fill="var(--tile)" rx="12"/>');
    svg.push('<rect x="'+(left-5)+'" y="'+(top-8)+'" width="5" height="'+(bottom-top+16)+'" fill="var(--string)"/>');
    for (var f=1; f<=frets-1; f++){
      var x = left + f * fretGap;
      svg.push('<line x1="'+x+'" y1="'+(top-8)+'" x2="'+x+'" y2="'+(bottom+8)+'" stroke="rgba(255,255,255,.12)" stroke-width="'+((f%12===0)?2:1)+'"/>');
      var mod = f % 12;
      if (mod===3||mod===5||mod===7||mod===9){ svg.push('<circle cx="'+(x - fretGap/2)+'" cy="'+(H/2)+'" r="4.2" fill="rgba(255,255,255,.14)"/>'); }
      if (f%12===0){ svg.push('<circle cx="'+(x - fretGap/2)+'" cy="'+(H/2 - 10)+'" r="4.2" fill="rgba(255,255,255,.14)"/><circle cx="'+(x - fretGap/2)+'" cy="'+(H/2 + 10)+'" r="4.2" fill="rgba(255,255,255,.14)"/>'); }
    }
    for (var s=0; s<stringsInt.length; s++){
      var y = top + s*stringGap;
      svg.push('<line x1="'+left+'" y1="'+y+'" x2="'+right+'" y2="'+y+'" stroke="var(--string)" stroke-width="'+(2.6 - s*0.2)+'"/>');
      svg.push('<text x="6" y="'+(y+3)+'" font-size="11" fill="#9aa4b2" font-weight="700">'+stringsIdx[s]+'</text>');
    }
    for (s=0; s<stringsInt.length; s++){
      for (var f=0; f<=frets-1; f++){
        var noteIdx = (stringsInt[s] + f) % 12;
        if (noteSet[noteIdx]){
          var x2 = left + f*fretGap - fretGap/2;
          var y2 = top + s*stringGap;
          var isRoot = (noteIdx === rootIdx);
          var r = isRoot ? 8.5 : 6.4;
          var fill = isRoot ? "var(--good)" : "var(--accent)";
          svg.push('<circle cx="'+x2+'" cy="'+y2+'" r="'+r+'" fill="'+fill+'" stroke="rgba(0,0,0,.35)" stroke-width="2"/>');
        }
      }
    }
    fretboard.setAttribute('viewBox', '0 0 '+W+' '+H);
    fretboard.innerHTML = svg.join("");
  }

  // ‚Äî‚Äî‚Äî Ticker / sections / reprises ‚Äî‚Äî‚Äî
  function getCurrentChordSym(){
    var m = state.seq[state.curBar];
    if (!m) return state.chordSyms[0] || "Cmaj7";
    if (!m.split) return m.chords[0];
    return (state.curBeat < (state.beatsPerBar===4?2:1)) ? m.chords[0] : m.chords[1];
  }
  function renderTicker(){
    ticker.innerHTML = "";
    var repL = new Set(state.repeats && state.repeats.L || []);
    var repR = new Set(state.repeats && state.repeats.R || []);
    var sects = Array.isArray(state.sections) ? state.sections.slice().sort((a,b)=>a.index-b.index) : [];
    var nextSection = 0;

    for (var i=0;i<state.seq.length;i++){
      var oneBased = i+1;
      while (nextSection < sects.length && sects[nextSection].index === oneBased){
        var mk = document.createElement('div');
        mk.className = 'marker';
        mk.textContent = (sects[nextSection].label || '').trim() || 'Section';
        ticker.appendChild(mk);
        nextSection++;
      }
      var m = state.seq[i];
      var wrap = document.createElement('div');
      wrap.className='measure'+(i===state.curBar?' active':'');
      var grid = document.createElement('div'); grid.className = m.split ? 'halfgrid' : 'mgrid';

      for (var k=0;k<m.chords.length;k++){
        var sym = m.chords[k];
        var d = document.createElement('div'); d.className='tile';
        if (k===0 && repL.has(oneBased)) d.classList.add('brL');
        if (repR.has(oneBased) && (k===m.chords.length-1)) d.classList.add('brR');
        if (i===state.curBar){
          if (!m.split){ d.classList.add('active'); }
          else {
            if ((state.beatsPerBar===4 && ((state.curBeat<2 && k===0) || (state.curBeat>=2 && k===1)))
             || (state.beatsPerBar!==4 && ((state.curBeat<1 && k===0) || (state.curBeat>=1 && k===1)))){
              d.classList.add('active');
            }
          }
        }
        d.textContent = sym;
        d.setAttribute('data-bar', i);
        d.setAttribute('data-pos', k);
        grid.appendChild(d);
      }
      wrap.appendChild(grid); ticker.appendChild(wrap);
    }
  }
  function renderMain(){
    var sym = getCurrentChordSym();
    bigChord.textContent = sym;
    chordNotes.textContent = chordTones(sym, prefersFlats(state.key)).tones.join(" ");
    renderFretboardForChord(sym);
    renderHeader();
  }
  function rebuildChordSyms(){
    state.chordSyms = [];
    for (var i=0;i<state.seq.length;i++){
      for (var k=0;k<state.seq[i].chords.length;k++) state.chordSyms.push(state.seq[i].chords[k]);
    }
  }
  function pairRepeats(Larr, Rarr){
    const L = (Larr||[]).slice().sort((a,b)=>a-b);
    const R = (Rarr||[]).slice().sort((a,b)=>a-b);
    const segs = [];
    for (let ri=0; ri<R.length; ri++){
      let bestStart = -1;
      for (let li=0; li<L.length && L[li] <= R[ri]; li++){
        const start = L[li]-1, end = R[ri]-1;
        const overlap = segs.some(s => !(end < s.start || start > s.end));
        if (!overlap) bestStart = start;
      }
      if (bestStart>=0) segs.push({start:bestStart, end:R[ri]-1, played:false});
    }
    return segs.sort((a,b)=>a.start-b.start);
  }

  // ‚Äî‚Äî‚Äî Audio (m√©tronome + tempo r√©glable) ‚Äî‚Äî‚Äî
  var audioCtx=null, timer=null;
  function ensureAudio(){ try{ if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); if (audioCtx && audioCtx.state==='suspended') audioCtx.resume(); }catch(_){ } }
  function beep(accent){
    if (!metroToggle || !metroToggle.checked) return;
    ensureAudio(); if(!audioCtx) return;
    const t = audioCtx.currentTime + 0.005;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type='square';
    const jazz = (metroMode && metroMode.value==='jazz');
    osc.frequency.setValueAtTime(accent ? (jazz?1400:1600) : (jazz?900:1100), t);
    gain.gain.setValueAtTime(0.0001, t);
    try{ gain.gain.exponentialRampToValueAtTime(accent?0.35:0.24, t+0.006); }catch(_){ gain.gain.linearRampToValueAtTime(accent?0.35:0.24, t+0.006); }
    try{ gain.gain.exponentialRampToValueAtTime(0.0001, t+0.08); }catch(_){ gain.gain.linearRampToValueAtTime(0.0001, t+0.08); }
    osc.connect(gain); gain.connect(audioCtx.destination); osc.start(t); osc.stop(t+0.08);
  }
  function isAccent(beat){
    const jazz = (metroMode && metroMode.value==='jazz');
    return jazz ? ((state.beatsPerBar===4) ? (beat===1||beat===3) : beat===0) : (beat===0);
  }
  function pulseBlink(){
    if(pulseDot){ pulseDot.classList.add('on'); setTimeout(function(){ pulseDot.classList.remove('on'); }, 110); }
  }
  function tickBeat(){
    const accent = isAccent(state.curBeat);
    pulseBlink(); beep(accent);
    state.curBeat++;
    if (state.curBeat >= state.beatsPerBar){
      state.curBeat = 0;
      let nextBar = (state.curBar + 1);
      const seg = state.repeatSegments.find(s => s.end === state.curBar);
      if (seg){
        if (!seg.played){ nextBar = seg.start; seg.played = true; }
        else { nextBar = state.curBar + 1; }
      }
      if (nextBar >= state.seq.length){
        nextBar = 0;
        state.repeatSegments.forEach(s => s.played = false); // r√©arme
      }
      state.curBar = nextBar;
    }
    renderMain(); renderTicker();
  }
  function start(){ if(state.playing) return; state.playing=true; playBtn.textContent="‚è∏Ô∏é"; ensureAudio(); tickBeat(); timer=setInterval(tickBeat, state.msPerBeat); }
  function stop(){ if(!state.playing) return; state.playing=false; playBtn.textContent="‚ñ∂Ô∏é"; if(timer){clearInterval(timer); timer=null;} }

  // ‚Äî‚Äî‚Äî Click in ticker ‚Äî‚Äî‚Äî
  ticker.addEventListener('click', function(ev){
    var t = ev.target; if(!t || !t.classList.contains('tile')) return;
    var bar = parseInt(t.getAttribute('data-bar'),10);
    var pos = parseInt(t.getAttribute('data-pos'),10);
    if (isNaN(bar) || isNaN(pos)) return;
    state.curBar = Math.max(0, Math.min(bar, state.seq.length-1));
    var m = state.seq[state.curBar];
    state.curBeat = (!m || !m.split || pos===0) ? 0 : (state.beatsPerBar===4?2:1);
    renderMain(); renderTicker();
  });

  // ‚Äî‚Äî‚Äî API depuis Bridge ‚Äî‚Äî‚Äî
  window.Reader = window.Reader || {};
  window.Reader.applyGrid = function(g){
    const rawBars = Array.isArray(g && g.bars) ? g.bars : [];
    state.seq = rawBars.map(b => {
      const arr = Array.isArray(b) ? b : (b && b.chords) || [];
      return { chords: arr.slice(0,2), split: arr.length>=2 };
    });
    if (!state.seq.length) return;
    rebuildChordSyms();
    if (g && g.tpb && (g.tpb===3 || g.tpb===4)) state.beatsPerBar = g.tpb;
    state.sections = Array.isArray(g.sections)? g.sections : [];
    state.repeats  = (g.repeats && typeof g.repeats==='object')? g.repeats : {L:[],R:[]};
    state.repeatSegments = pairRepeats(state.repeats.L, state.repeats.R);
    state.curBar = 0; state.curBeat = 0;
    state.title = g.name || g.title || g.id || '‚Äî';
    renderMain(); renderTicker();
    // persiste la grille courante pour la biblio
    try{
      const blob = { lastGridId: g.id };
      localStorage.setItem('mp_settings_v3', JSON.stringify(blob));
      document.cookie = 'mp_settings_v3='+encodeURIComponent(JSON.stringify(blob))+';path=/;SameSite=Lax;max-age='+(3600*24*365);
    }catch(_){}
  };

  // ‚Äî‚Äî‚Äî UI ‚Äî‚Äî‚Äî
  playBtn.addEventListener('click', function(){ state.playing ? stop() : start(); });
  randomBtn.addEventListener('click', async function(){
    try{ stop(); await (window.Bridge && Bridge.randomFromLibrary ? Bridge.randomFromLibrary() : Promise.reject('Bridge indisponible')); }
    catch(e){ showErr(e.message||e); }
  });
  optsBtn.addEventListener('click', function(){ el('optsPanel').showModal(); });
  closeOpts.addEventListener('click', function(){ el('optsPanel').close(); });

  langSel.addEventListener('change', function(e){ state.lang=e.target.value; renderHeader(); writeSettings({lang:state.lang}); });
  styleSel.addEventListener('change', function(e){ rootEl.setAttribute('data-theme', e.target.value); writeSettings({theme:e.target.value}); });
  stringsSel.addEventListener('change', function(e){ state.strings=e.target.value; renderMain(); writeSettings({strings:state.strings}); });
  metroToggle.addEventListener('change', function(){ writeSettings({metroOn: !!metroToggle.checked}); });
  metroMode.addEventListener('change', function(){ writeSettings({metroMode: metroMode.value}); });
  bpm.addEventListener('input', function(e){
    const v = parseInt(e.target.value,10)||96; bpmVal.textContent = v;
    state.bpm = v; state.msPerBeat = 60000/v; writeSettings({bpm:v});
    if(state.playing){ if(timer){ clearInterval(timer); timer=null; } start(); }
  });

  // ‚Äî‚Äî‚Äî Boot ‚Äî‚Äî‚Äî
  function getHashParam(name){
    const h = location.hash || '';
    const m = h.match(new RegExp('[#&]' + name + '=([^&]+)'));
    return m ? decodeURIComponent(m[1]) : null;
  }
  async function bootFromHash(){
    const id = getHashParam('grid');
    if (!id){
      // pas de hash ‚Üí essaie la derni√®re grille connue
      try{
        const s = JSON.parse(localStorage.getItem('mp_settings_v3')||'{}');
        if (s && s.lastGridId){ await Bridge.loadGridToReader(s.lastGridId); stop(); return; }
      }catch(_){}
      return;
    }
    try{ await Bridge.loadGridToReader(id); stop(); }catch(e){ showErr(e.message||e); }
  }
  window.addEventListener('hashchange', bootFromHash);

  applySettings(); // restaure UI (m√©tronome, jazz, bpm, th√®me‚Ä¶)

  document.addEventListener('DOMContentLoaded', function(){
    // default mini progression si rien n‚Äôest charg√©
    if ((location.hash||'').indexOf('grid=')<0){
      try{
        const s = JSON.parse(localStorage.getItem('mp_settings_v3')||'{}');
        if (s && s.lastGridId){ location.hash = 'grid='+encodeURIComponent(s.lastGridId); }
      }catch(_){}
    }
    bootFromHash();
    renderHeader();
    // d√©verrouille audio sur interaction
    document.addEventListener('pointerdown', function(){ try{ if (audioCtx && audioCtx.state==='suspended') audioCtx.resume(); }catch(_){} }, {once:true, passive:true});
  });
})();
</script>

<script src="./js/grid/parse.js"></script>
<script src="./js/grid/grid-bridge.js"></script>
</body>
</html>