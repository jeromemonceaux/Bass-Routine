<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bibliothèque — Import JSON rapide</title>
  <style>
    body { margin:0; font-family: -apple-system, system-ui, Roboto, Arial, sans-serif; background:#fff; color:#111; }
    header { position:sticky; top:0; background:#f7f7f7; border-bottom:1px solid #ddd; }
    .wrap { max-width:1000px; margin:0 auto; padding:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .wrap h1 { font-size:16px; margin:0; font-weight:700; }
    .actions { margin-left:auto; display:flex; gap:6px; flex-wrap:wrap; }
    button, input[type=file] + label {
      appearance:none; border:1px solid #ccc; background:#fff; color:#111; border-radius:10px;
      padding:8px 12px; font-size:14px; line-height:1; cursor:pointer;
    }
    input[type=file] { display:none; }
    main { max-width:1000px; margin:12px auto; padding:0 12px; display:grid; grid-template-columns:1fr; gap:12px; }
    .card { border:1px solid #e5e5e5; border-radius:12px; overflow:hidden; background:#fff; }
    .card h2 { margin:0; font-size:14px; font-weight:700; padding:10px 12px; border-bottom:1px solid #eee; background:#fafafa; }
    .content { padding:12px; }
    .row { display:grid; grid-template-columns:1fr auto auto; gap:8px; align-items:center; padding:8px; border:1px solid #eee; border-radius:10px; margin-bottom:8px; }
    .muted { color:#666; font-size:12px; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #ddd; font-size:11px; color:#333; }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Bibliothèque</h1>
    <div class="actions">
      <button id="btnLoad">Charger DB</button>
      <input id="file" type="file" accept="application/json">
      <label for="file">Importer JSON</label>
      <button id="btnSend" disabled>Envoyer vers DB</button>
      <button id="btnExport">Exporter JSON</button>
      <a href="editor.html" style="text-decoration:none"><button>Éditeur</button></a>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <h2>Catalogue</h2>
    <div class="content">
      <div style="display:grid; grid-template-columns:1fr auto auto; gap:8px; align-items:center; margin-bottom:8px">
        <input id="q" placeholder="Recherche titre/compositeur/ID" style="padding:8px 10px; border:1px solid #ddd; border-radius:10px">
        <select id="filter" style="padding:8px 10px; border:1px solid #ddd; border-radius:10px">
          <option value="all">Tous</option>
          <option value="pd">Domaine public</option>
          <option value="meta">Métadonnées</option>
        </select>
        <button id="btnReset">Réinit</button>
      </div>
      <div id="list"></div>
    </div>
  </section>

  <section class="card">
    <h2>Infos</h2>
    <div class="content">
      <div class="badge" id="status">—</div>
      <div class="muted" style="margin-top:8px">Importer JSON → choisit un fichier local (.json). Puis “Envoyer vers DB” fait un <code>PUT /api/library</code>.</div>
    </div>
  </section>
</main>

<script>
const API = '/api/library';
const $ = (id) => document.getElementById(id);
let LIBRARY = [];
let IMPORT_PAYLOAD = null;

function setStatus(t){ $('status').textContent = t; }

async function loadFromDB(){
  const r = await fetch(API);
  if(!r.ok) throw new Error('HTTP '+r.status);
  LIBRARY = await r.json();
  setStatus(LIBRARY.length+' items (DB)');
  renderList();
}

async function sendToDB(payload){
  const r = await fetch(API, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  if(!r.ok){
    const t = await r.text(); throw new Error('HTTP '+r.status+' '+t);
  }
  setStatus('Importé ✔');
  $('btnSend').disabled = true;
  await loadFromDB();
}

function renderList(){
  const q = ($('q').value||'').toLowerCase();
  const mode = $('filter').value;
  const list = $('list');
  const items = (LIBRARY||[]).filter(it=>{
    const hay = ((it.id||'')+' '+(it.title||'')+' '+(it.composer||'')).toLowerCase();
    if(q && !hay.includes(q)) return false;
    if(mode==='pd' && !it.is_public_domain) return false;
    if(mode==='meta' && it.is_public_domain) return false;
    return true;
  });
  list.innerHTML = items.map(it => `
    <div class="row">
      <div>
        <div style="font-weight:700">${escapeHtml(it.title||'Sans titre')}</div>
        <div class="muted">${escapeHtml(it.id||'')} • ${escapeHtml(it.composer||'')} • ${it.year||'—'} • ${escapeHtml(it.style||'')}</div>
      </div>
      <div><span class="badge ${it.is_public_domain?'':'warn'}">${it.is_public_domain?'Grille incluse (PD)':'Métadonnées'}</span></div>
      <div><a href="editor.html?id=${encodeURIComponent(it.id)}"><button>Ouvrir</button></a></div>
    </div>
  `).join('');
}

function escapeHtml(s){ return (''+s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// UI wiring
$('btnLoad').onclick = () => loadFromDB().catch(e=>alert(e.message));
$('btnExport').onclick = () => {
  const blob = new Blob([JSON.stringify(LIBRARY, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'jazz-library.json';
  a.click();
  URL.revokeObjectURL(a.href);
};
$('btnReset').onclick = () => { $('q').value=''; $('filter').value='all'; renderList(); };
$('q').oninput = renderList;
$('filter').onchange = renderList;

$('file').onchange = () => {
  const f = $('file').files[0]; if(!f) return;
  const rd = new FileReader();
  rd.onload = () => {
    try{
      const data = JSON.parse(rd.result);
      if(!Array.isArray(data)) throw new Error('Le JSON doit être un tableau');
      IMPORT_PAYLOAD = data;
      $('btnSend').disabled = false;
      setStatus('Prêt à envoyer ('+data.length+' items)');
    }catch(err){
      alert('Fichier invalide: '+err.message);
    }
  };
  rd.readAsText(f);
};
$('btnSend').onclick = () => {
  if(!IMPORT_PAYLOAD) { alert('Aucun fichier importé'); return; }
  sendToDB(IMPORT_PAYLOAD).catch(e=>alert(e.message));
};
</script>
</body>
</html>
