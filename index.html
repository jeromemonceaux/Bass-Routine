<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bass-Routine ‚Äî Visualiseur</title>
  <style>
    :root{
      --bg:#0c0d10; --panel:#14161b; --text:#e9ebef; --muted:#9aa0aa; --border:#262a31;
      --accent:#63d1bb; --radius:14px; --f-sans:Inter,system-ui,Segoe UI,Roboto,Arial;
      --compas-cols:4; --show-numbers:0;
    }
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#090b10,#12151c);color:var(--text);font-family:var(--f-sans)}
    header{position:sticky;top:0;background:#0f1117d0;border-bottom:1px solid var(--border);backdrop-filter:blur(6px);z-index:5}
    .wrap{max-width:1200px;margin:0 auto;padding:10px 14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .brand{font-weight:900;letter-spacing:.3px}
    .toolbar{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button,select,input{border:1px solid var(--border);background:#0f1117;color:var(--text);border-radius:12px;padding:8px 12px}
    main{max-width:1200px;margin:16px auto;padding:0 14px;display:grid;grid-template-rows:auto 1fr;gap:12px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
    .panel h2{margin:0;padding:10px 12px;border-bottom:1px solid var(--border);font-size:15px}
    .content{padding:12px}
    .toprow{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px;color:#c9ced6}
    .title{font-weight:800;font-size:18px}
    #fretboard{height:160px;border:1px dashed #394050;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#9aa0aa}
    .compas{background:#0f1117;border:1px solid var(--border);border-radius:12px;padding:10px}
    .grid{display:grid;gap:8px}
    .row{display:grid;grid-template-columns:repeat(var(--cols,4),1fr);gap:8px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:11px;color:#d9deeb;margin:6px 0 0}
    .cell{position:relative;min-height:62px;display:flex;align-items:center;justify-content:center;text-align:center;padding:6px;border:1px solid #2a2f3a;border-radius:10px;font-family:ui-monospace,Menlo,Consolas,monospace;line-height:1.25}
    .cell small{position:absolute;top:6px;left:8px;opacity:calc(var(--show-numbers));font-size:10px}
    .cell .multi{display:flex;flex-direction:column;gap:2px;white-space:pre-wrap}
    .cell.empty{opacity:.6;font-style:italic}
    .bracketL::before{content:'ùÑÜ';position:absolute;left:-14px;top:50%;transform:translateY(-50%);font-size:18px}
    .bracketR::after{content:'ùÑá';position:absolute;right:-14px;top:50%;transform:translateY(-50%);font-size:18px}
    .btn-accent{background:var(--accent);color:#06372e;border-color:#2e8}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">Bass‚ÄëRoutine</div>
    <div id="gridName" class="badge">‚Äî</div>
    <div class="toolbar">
      <button id="randomBtn" class="btn-accent">Random</button>
      <select id="cols">
        <option value="2">2 par ligne</option>
        <option value="3">3 par ligne</option>
        <option value="4" selected>4 par ligne</option>
        <option value="8">8 par ligne</option>
      </select>
      <a href="editor.html" style="text-decoration:none"><button>√âditeur</button></a>
    </div>
  </div>
</header>

<main>
  <section class="panel">
    <h2>Manche & Outils</h2>
    <div class="content">
      <div class="toprow">
        <div id="fretboard">Ici viendra ton manche (compat outils + Random).</div>
        <div>
          <div class="badge">Recherche</div>
          <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">
            <input id="q" placeholder="Titre/compositeur/ID">
            <button id="searchBtn">Chercher</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="panel">
    <h2>Grille</h2>
    <div class="content">
      <div class="badge">Texte normalis√©</div>
      <div id="preview" style="white-space:pre-wrap;background:#0f1117;border:1px solid var(--border);border-radius:12px;padding:10px;min-height:100px;margin:6px 0 10px"></div>
      <div class="badge">Rendu ‚Äúcompas‚Äù</div>
      <div id="compas" class="compas"></div>
    </div>
  </section>
</main>

<script>
const $=(id)=>document.getElementById(id);
const API='/api/library';
let LIB=[], CURRENT=null;

const DIR_RE=/(D\\.?S\\.?\\s*al\\s*Coda|D\\.?S\\.?\\s*al\\s*Fine|D\\.?C\\.?\\s*al\\s*Coda|D\\.?C\\.?\\s*al\\s*Fine|To\\s*Coda|Fine|Segno\\s*ùÑã|Segno|Coda\\s*ùÑå|Coda|ùÑã|ùÑå)/i;
function sectionFromLine(line){ const m=line.match(/^\\s*[\\[(]?(Intro|A\\d*|A|B\\d*|B|C|D|Bridge|Solo|Solos|Refrain|Coda|Segno)\\s*[:\\])]?\\s*$/i); return m?m[1].toUpperCase():null; }
function normalizeChord(s){
  let x=s.trim();
  x=x.replace(/^([A-Ga-g])-(?!\\d)/,(_,r)=>r.toUpperCase()+'m').replace(/#/g,'‚ôØ');
  if(/^(bb|Bb|BB)$/.test(x)) return 'B‚ô≠';
  const m=x.match(/^([A-Ga-g])([b‚ô≠#‚ôØ]?)(.*)$/);
  if(m){
    let [_,r,a,rest]=m; r=r.toUpperCase(); if(a==='b') a='‚ô≠'; if(a==='#') a='‚ôØ';
    rest=rest.replace(/maj/gi,'Œî').replace(/\\bM7\\b/g,'Œî7').replace(/dim/gi,'¬∞')
             .replace(/\\bo\\b(?=\\d|\\(|$)/g,'¬∞').replace(/min/gi,'m').replace(/-7/g,'m7')
             .replace(/m7b5/gi,'m7‚ô≠5').replace(/b(?=\\d)/g,'‚ô≠').replace(/\\+(?=\\d)/g,'‚ôØ')
             .replace(/add\\s*(\\d+)/gi,'add$1').replace(/sus\\s*(2|4)/gi,'sus$1').replace(/alt/gi,'alt');
    x=r+(a||'')+rest;
  }
  x=x.replace(/\\( *([^)]*) *\\)/g,(_,i)=>'('+i.replace(/b(?=\\d)/g,'‚ô≠').replace(/#(?=\\d)/g,'‚ôØ').replace(/\\s+/g,'').replace(/,/g,'')+')');
  x=x.replace(/\\/(.)(b|#)/g,(_,n,a)=>'/'+n.toUpperCase()+(a==='b'?'‚ô≠':'‚ôØ'));
  return x;
}
function isRecognizedChord(s){
  const re=new RegExp('^[A-G](?:[‚ôØ‚ô≠])?(?:m|Œî|¬∞|√∏|dim|maj)?(?:6|7|9|11|13)?(?:sus[24])?(?:add(?:9|11|13))?(?:[‚ô≠‚ôØ]?\\d{1,2})*(?:\\((?:alt|[‚ô≠‚ôØ]?\\d{1,2})+(?:[‚ô≠‚ôØ]?\\d{1,2})*\\))?(?:\\/[A-G](?:[‚ôØ‚ô≠])?)?$','u');
  return re.test(s);
}
function splitIntoChordTokens(str){
  const raw=str.trim().split(/\\s+/); const out=[];
  for(const b of raw){
    if(!b) continue;
    if(/^\\(.*\\)$/.test(b) && out.length && out[out.length-1].type==='chord'){ out[out.length-1].value+=b; }
    else if(/^[()]+$/.test(b)){ out.push({type:'literal', value:b}); }
    else out.push({type:'chord', value:b});
  }
  return out;
}
function normalizeDirective(d){
  let s=d.replace(/\\s+/g,' ').trim();
  s=s.replace(/D\\.?S\\.?/i,'D.S.').replace(/D\\.?C\\.?/i,'D.C.');
  s=s.replace(/al\\s*Coda/i,'al Coda').replace(/al\\s*Fine/i,'al Fine');
  s=s.replace(/To\\s*Coda/i,'To Coda');
  return s;
}
function normalizeGrid(text){
  const lines=text.split(/\\r?\\n/); let htmlLines=[], parse={measures:[]}, repeats=[]; let currentSection=null;
  for(const raw of lines){
    if(!raw.trim()){ htmlLines.push(''); continue; }
    const sec=sectionFromLine(raw); if(sec){ currentSection=sec.replace(/\\d+/g,''); htmlLines.push('<span class="pill">‚ñ∂ '+sec.toUpperCase().replace(/\\d+/g,'')+'</span>'); continue; }
    let line=raw.replace(/\\s+/g,' ').trim();
    const startsRepeat=/ùÑÜ/.test(line), endsRepeat=/ùÑá/.test(line);
    line=line.replace(/ùÑÜ\\s*(?!\\|)/g,'ùÑÜ | ').replace(/(?<!\\|)\\s*ùÑá/g,' | ùÑá');
    const parts=[]; let bar=[];
    line.split(/(\\|ùÑÜ|ùÑá)/g).filter(Boolean).forEach(tok=>{
      const t=tok.trim(); if(!t) return;
      if(t==='|'){ parse.measures.push({section:currentSection, items:[...bar]}); bar=[]; parts.push('|'); return; }
      if(t==='ùÑÜ'||t==='ùÑá'){ parts.push(t); return; }
      let rest=t, m;
      while((m=rest.match(DIR_RE))){
        const idx=m.index; const dir=m[0];
        const before=rest.slice(0,idx).trim();
        if(before){
          splitIntoChordTokens(before).forEach(x=>{
            const n=normalizeChord(x.value); const ok=isRecognizedChord(n);
            parts.push(ok?n:'<span style="border-bottom:2px dotted #f7c87a">'+n+'</span>');
            if(ok) bar.push(n);
          });
        }
        parts.push('<span class="pill">'+normalizeDirective(dir)+'</span>');
        rest=rest.slice(idx+dir.length).trim();
      }
      if(rest){
        splitIntoChordTokens(rest).forEach(x=>{
          const n=normalizeChord(x.value); const ok=isRecognizedChord(n);
          parts.push(ok?n:'<span style="border-bottom:2px dotted #f7c87a">'+n+'</span>');
          if(ok) bar.push(n);
        });
      }
    });
    if(bar.length){ parse.measures.push({section:currentSection, items:[...bar]}); bar=[]; }
    if(startsRepeat) repeats.push({pos: parse.measures.length, type:'L'});
    if(endsRepeat) repeats.push({pos: parse.measures.length, type:'R'});
    htmlLines.push(parts.join(' '));
  }
  return {html:htmlLines.join('\\n'), parse, repeats};
}
function updateCompas(parse, repeats){
  const colsN=parseInt(document.getElementById('cols').value,10)||4;
  const container=document.getElementById('compas'); container.innerHTML='';
  const grid=document.createElement('div'); grid.className='grid'; grid.style.setProperty('--cols', colsN);
  let currentSection=null, rowEl=null, cellCount=0, mi=0;
  const repsL=new Set((repeats||[]).filter(r=>r.type==='L').map(r=>r.pos));
  const repsR=new Set((repeats||[]).filter(r=>r.type==='R').map(r=>r.pos));
  function newRow(){ rowEl=document.createElement('div'); rowEl.className='row'; grid.appendChild(rowEl); cellCount=0; }
  (parse.measures||[]).forEach(m=>{
    if(m.section!==currentSection){ currentSection=m.section; const sec=document.createElement('div'); sec.textContent=currentSection?('Section '+currentSection):'Section'; sec.className='pill'; grid.appendChild(sec); newRow(); }
    if(!rowEl || cellCount>=colsN) newRow();
    mi++;
    const cell=document.createElement('div'); cell.className='cell';
    const list=document.createElement('div'); list.className='multi';
    if(m.items && m.items.length){ m.items.forEach(ch=>{ const line=document.createElement('div'); line.textContent=ch; list.appendChild(line); }); }
    else { cell.classList.add('empty'); const line=document.createElement('div'); line.textContent='‚Äî'; list.appendChild(line); }
    if(getComputedStyle(document.documentElement).getPropertyValue('--show-numbers').trim()==='1'){ const num=document.createElement('small'); num.textContent=mi; cell.appendChild(num); }
    if(repsL.has(mi)) cell.classList.add('bracketL');
    if(repsR.has(mi)) cell.classList.add('bracketR');
    cell.appendChild(list); rowEl.appendChild(cell); cellCount++;
  });
  container.appendChild(grid);
}

async function loadDB(){ const r=await fetch(API); if(!r.ok) throw new Error('HTTP '+r.status); return await r.json(); }
function setTitle(t){ document.getElementById('gridName').textContent = t || '‚Äî'; }
function render(item){
  CURRENT=item;
  setTitle(item?.title||item?.id||'‚Äî');
  const text=item?.grid_text || '';
  const norm=normalizeGrid(text);
  document.getElementById('preview').innerHTML=norm.html;
  updateCompas(norm.parse, norm.repeats);
}
function pickRandom(list){ if(!list?.length) return null; return list[Math.floor(Math.random()*list.length)]; }

document.getElementById('randomBtn').onclick=()=>{ const it=pickRandom(LIB); if(it) render(it); };
document.getElementById('searchBtn').onclick=()=>{
  const q=document.getElementById('q').value.trim().toLowerCase();
  const it=(LIB||[]).find(x=> (x.title||'').toLowerCase().includes(q) || (x.composer||'').toLowerCase().includes(q) || (x.id||'').toLowerCase()===q );
  if(it) render(it); else alert('Introuvable');
};
document.getElementById('cols').onchange=()=>{ if(!CURRENT) return; const norm=normalizeGrid(CURRENT.grid_text||''); updateCompas(norm.parse, norm.repeats); };

async function boot(){
  try{ LIB=await loadDB(); }catch(_){ LIB=[]; }
  if(!LIB.length){
    LIB=[{id:'blue-bossa', title:'Blue Bossa', composer:'Kenny Dorham', style:'Bossa', is_public_domain:false, grid_text:`A:
ùÑÜ Cm7 | Fm7 | Dm7b5 G7 | Cm7 |
| Cm7 | Fm7 | Dm7b5 G7 | Cm7 ùÑá

B: (Bridge)
| E‚ô≠m7 A‚ô≠7 | D‚ô≠Œî | Dm7b5 G7 | Cm7 |

A:
| Cm7 | Fm7 | Dm7b5 G7 | Cm7 | Fine

D.C. al Fine` }];
  }
  render(LIB[0]);
}
boot();
</script>
</body>
</html>
