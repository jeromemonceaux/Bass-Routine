
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bass‑Routine — Bibliothèque</title>
<style>
:root{ --bg:#0c0d10; --panel:#14161b; --text:#e9ebef; --muted:#9aa0aa; --border:#262a31; }
*{box-sizing:border-box} body{margin:0;background:#0c0d10;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
header{position:sticky;top:0;background:#0f1117d0;border-bottom:1px solid var(--border);backdrop-filter:blur(6px);z-index:6}
.wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
button, input[type=file] + label, select, input{border:1px solid var(--border);background:#0f1117;color:var(--text);border-radius:12px;padding:8px 12px}
input[type=file]{display:none}
main{max-width:1100px;margin:16px auto;padding:0 16px}
.card{background:#14161b;border:1px solid var(--border);border-radius:14px;overflow:hidden}
.card h2{margin:0;padding:10px 12px;border-bottom:1px solid var(--border);font-size:15px}
.content{padding:12px}
.row{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;padding:10px;border:1px solid #22262f;border-radius:12px;background:#0e1016;margin-bottom:8px}
.muted{color:#9aa0aa;font-size:12px}
.badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px;color:#c9ced6}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div style="font-weight:800">Bass‑Routine — Bibliothèque</div>
    <div class="actions">
      <button id="loadDb">Charger DB</button>
      <input id="file" type="file" accept="application/json">
      <label for="file">Importer JSON</label>
      <button id="uploadBtn" disabled>Envoyer vers DB</button>
      <button id="export">Exporter JSON</button>
      <a href="index.html" style="text-decoration:none"><button>Lecteur</button></a>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <h2>Catalogue</h2>
    <div class="content">
      <div style="display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;margin-bottom:8px">
        <input id="q" placeholder="Recherche titre/compositeur/ID">
        <select id="filter"><option value="all">Tous</option><option value="pd">Domaine public</option><option value="meta">Métadonnées</option></select>
        <button id="reset">Réinit</button>
      </div>
      <div id="list"></div>
      <div class="badge" id="status">—</div>
    </div>
  </section>
</main>

<script type="module">
import { getAll, putAll } from './js/api/library-client.js'
const $=id=>document.getElementById(id);
let LIB=[], IMPORT=null;

function setStatus(t){ $('status').textContent=t; }

function renderList(){
  const q=($('q').value||'').toLowerCase(), mode=$('filter').value;
  const items=(LIB||[]).filter(it=>{
    const hay=((it.id||'')+' '+(it.title||'')+' '+(it.composer||'')).toLowerCase();
    if(q && !hay.includes(q)) return false;
    if(mode==='pd' && !it.is_public_domain) return false;
    if(mode==='meta' && it.is_public_domain) return false;
    return true;
  });
  $('list').innerHTML=items.map(it=>`<div class="row">
    <div>
      <div style="font-weight:700">${escapeHtml(it.title||'Sans titre')}</div>
      <div class="muted">${escapeHtml(it.id||'')} • ${escapeHtml(it.composer||'')} • ${it.year||'—'} • ${escapeHtml(it.style||'')}</div>
    </div>
    <div><span class="badge ${it.is_public_domain?'':'warn'}">${it.is_public_domain?'Grille incluse (PD)':'Métadonnées'}</span></div>
    <div style="display:flex;gap:6px">
      <a href="index.html#grid=${encodeURIComponent(it.id)}"><button>Jouer</button></a>
      <a href="editor.html?id=${encodeURIComponent(it.id)}"><button>Ouvrir</button></a>
    </div>
  </div>`).join('');
  setStatus(items.length+' items');
}
function escapeHtml(s){ return (''+s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

$('q').oninput=renderList; $('filter').onchange=renderList; $('reset').onclick=()=>{ $('q').value=''; $('filter').value='all'; renderList(); };

$('file').onchange=()=>{
  const f=$('file').files[0]; if(!f) return;
  const rd=new FileReader();
  rd.onload=()=>{
    try{ const arr=JSON.parse(rd.result); if(!Array.isArray(arr)) throw new Error('Le JSON doit être un tableau');
      IMPORT=arr; $('uploadBtn').disabled=false; setStatus('Prêt à envoyer ('+arr.length+' items)');
    }catch(e){ alert('JSON invalide: '+e.message); }
  };
  rd.readAsText(f);
};

$('uploadBtn').onclick=async()=>{
  if(!IMPORT) return alert('Aucun fichier importé');
  try{ await putAll(IMPORT); setStatus('Importé ✔'); await load(); }catch(e){ alert(e.message); }
};

$('export').onclick=()=>{
  const blob=new Blob([JSON.stringify(LIB,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='jazz-library.json'; a.click(); URL.revokeObjectURL(a.href);
};

$('loadDb').onclick=()=>load().catch(e=>alert(e.message));

async function load(){ LIB=await getAll(); renderList(); }

// Auto-load at init
load().catch(()=>{});
</script>
</body>
</html>
