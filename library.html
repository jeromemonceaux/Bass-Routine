<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bibliothèque — Bass-Routine</title>
  <style>
    body{margin:0;background:#0c0d10;color:#e9ebef;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:#0f1117d0;border-bottom:1px solid #262a31;backdrop-filter:blur(6px)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    a{color:inherit;text-decoration:none;border:1px solid #262a31;padding:6px 10px;border-radius:10px;background:#0f1117}
    main{max-width:1100px;margin:18px auto;padding:0 16px}
    .list{display:grid;gap:8px}
    .row{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center;background:#14161b;border:1px solid #262a31;border-radius:12px;padding:8px}
    .row .title{font-weight:600}
    .badge{display:inline-block;border:1px solid #262a31;border-radius:999px;padding:2px 8px;font-size:11px;color:#c9ced6}
    button{border:1px solid #262a31;background:#0f1117;color:#e9ebef;border-radius:10px;padding:6px 10px;cursor:pointer}
    input{border:1px solid #262a31;background:#0f1117;color:#e9ebef;border-radius:10px;padding:8px 10px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <a href="index.html">← Lecteur</a>
    <h1 style="margin-left:8px;font-size:18px">Bibliothèque</h1>
    <input id="q" placeholder="Rechercher…" style="margin-left:auto; min-width:220px">
  </div>
</header>

<main>
  <div class="list" id="libList"></div>
</main>

<script src="js/grid/parse.js"></script>
<script src="js/grid/grid-bridge.js"></script>
<script>
const API = '/api/library';

function openInReader(id, auto=true){
  if(!id) return;
  const url = 'index.html#grid=' + encodeURIComponent(id) + (auto ? '&auto=1' : '');
  location.href = url;
}
function openInEditor(id){
  const url = 'editor.html?id=' + encodeURIComponent(id);
  location.href = url;
}

async function fetchLibrary(){
  const r = await fetch(API);
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}

function hasFullGrid(item){
  return !!(item?.grid_text && item.grid_text.trim()) || (Array.isArray(item?.bars) && item.bars.length);
}

function renderLibrary(list){
  const el = document.getElementById('libList'); // IMPORTANT: assure-toi d'avoir <div id="libList"></div> dans le HTML
  if(!el){ console.error('#libList introuvable'); return; }
  if(!Array.isArray(list)) list = [];

  // tri simple par titre
  list.sort((a,b)=> String(a.title||a.id||'').localeCompare(String(b.title||b.id||''), 'fr'));

  el.innerHTML = list.map(it=>{
    const id = it.id || '';
    const title = it.title || id;
    const composer = it.composer || it.author || '';
    const style = it.style || '';
    const badge = hasFullGrid(it)
      ? '<span class="badge" title="Grille complète disponible">grid</span>'
      : '<span class="badge" title="Seulement métadonnées">meta</span>';
    return `
      <div class="rowItem" data-id="${id}" style="display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center;margin:6px 0;padding:8px;border:1px solid #262a31;border-radius:10px">
        <div>
          <div style="font-weight:700">${title}</div>
          <div style="opacity:.7;font-size:12px">${composer}${style ? ' • '+style : ''}</div>
        </div>
        <div>${badge}</div>
        <div><button class="btnPlay" data-action="play" data-id="${id}">Jouer</button></div>
        <div><button class="btnEdit" data-action="edit" data-id="${id}">Éditer</button></div>
      </div>
    `;
  }).join('') || '<div class="muted">Bibliothèque vide.</div>';
}

async function bootLibrary(){
  try{
    const lib = await fetch('/api/library').then(r=>r.json());
    const el = document.getElementById('lib-list') || document.getElementById('libList');
    if(!el) return;

    if(Array.isArray(lib) && lib.length){
      renderLibrary(lib); // ta fonction existante
      return;
    }

    // Vide => propose de charger les presets
    el.innerHTML = `
      <div style="padding:12px;border:1px dashed #3a3f46;border-radius:10px">
        Bibliothèque vide.
        <button id="seedBtn" style="margin-left:8px">Charger les presets</button>
      </div>
    `;
    document.getElementById('seedBtn')?.addEventListener('click', async ()=>{
      const r = await fetch('/api/library/seed', { method:'POST' });
      if(r.ok) location.reload();
      else alert('Echec du seed');
    });
  }catch(e){
    console.error(e);
    const el = document.getElementById('lib-list') || document.getElementById('libList');
    if(el) el.innerHTML = '<div class="muted">Erreur de chargement</div>';
  }
}
document.addEventListener('DOMContentLoaded', bootLibrary);

// Écouteurs délégués pour Play / Edit
document.addEventListener('click', (e)=>{
  const b = e.target.closest('[data-action]');
  if(!b) return;
  const id = b.getAttribute('data-id');
  if(!id) return;
  if(b.dataset.action === 'play'){
    e.preventDefault();
    openInReader(id, true);
  }else if(b.dataset.action === 'edit'){
    e.preventDefault();
    openInEditor(id);
  }
});
</script>
</body>
</html>